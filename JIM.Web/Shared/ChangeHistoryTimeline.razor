@using JIM.Models.Core
@using JIM.Models.Enums

@if (Changes == null || !Changes.Any())
{
    <MudText Typo="Typo.body2" Class="mud-text-secondary pa-5">No change history available.</MudText>
}
else
{
    <!-- Search and Filter Controls -->
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="mb-4" Style="flex-wrap: nowrap;">
        <MudTextField @bind-Value="_searchText"
                      Label="Search attributes"
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      DebounceInterval="300"
                      Style="max-width: 300px; flex: 0 0 auto;" />

        <MudSelect T="ValueChangeType?"
                   @bind-Value="_filterChangeType"
                   Label="Filter by change type"
                   Variant="Variant.Outlined"
                   Style="max-width: 250px; flex: 0 0 auto;">
            <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)null)">All Changes</MudSelectItem>
            <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)ValueChangeType.Add)">Add</MudSelectItem>
            <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)ValueChangeType.Remove)">Remove</MudSelectItem>
        </MudSelect>
    </MudStack>

    <!-- Timeline -->
    <MudTimeline TimelinePosition="TimelinePosition.Start" TimelineOrientation="TimelineOrientation.Vertical">
        @foreach (var changeGroup in GetFilteredChangeGroups())
        {
            <MudTimelineItem Color="@GetChangeTypeColor(changeGroup.ChangeType)" Size="Size.Small" Elevation="0">
                <ItemOpposite>
                    <MudTooltip Text="@changeGroup.ChangeTime.ToLocalTime().ToString("dd MMM yyyy HH:mm:ss")" Placement="Placement.Top" Arrow="true">
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">
                            @GetRelativeTime(changeGroup.ChangeTime)
                        </MudText>
                    </MudTooltip>
                </ItemOpposite>
                <ItemContent>
                    <MudCard Outlined="true" Class="cursor-pointer" @onclick="() => OpenChangeDetails(changeGroup)">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <!-- Change Header -->
                                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                    <MudIcon Icon="@GetChangeTypeIcon(changeGroup.ChangeType)"
                                             Color="@GetChangeTypeColor(changeGroup.ChangeType)"
                                             Size="Size.Medium" />
                                    <div>
                                        <MudText Typo="Typo.subtitle1">
                                            <strong>@changeGroup.ChangeType</strong>
                                        </MudText>
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                            @GetChangeInitiatorIcon(changeGroup)
                                            @GetChangeInitiatorDescription(changeGroup)
                                        </MudText>
                                    </div>
                                </MudStack>

                                <!-- Summary of Changes -->
                                @if (changeGroup.AttributeChanges.Any())
                                {
                                    <MudDivider />
                                    <div class="change-summary" style="@GetSummaryStyle(changeGroup)">
                                        @foreach (var attrGroup in GetAttributeSummary(changeGroup))
                                        {
                                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="mb-1">
                                                <MudText Typo="Typo.body2" Class="jim-text-code" Style="min-width: 120px;">
                                                    @attrGroup.AttributeName
                                                </MudText>
                                                <MudChip T="string"
                                                         Variant="Variant.Text"
                                                         Size="Size.Small"
                                                         Color="@Helpers.GetMudBlazorColorForValueChangeType(attrGroup.ChangeType)">
                                                    @attrGroup.ChangeType
                                                </MudChip>
                                                <MudText Typo="Typo.body2" Class="mud-text-secondary" Style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    @GetValueSummary(attrGroup)
                                                </MudText>
                                            </MudStack>
                                        }
                                    </div>

                                    @if (ShouldShowExpandButton(changeGroup))
                                    {
                                        <div class="fade-overlay"></div>
                                        <MudButton Variant="Variant.Text"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.ExpandMore"
                                                   Size="Size.Small"
                                                   FullWidth="true"
                                                   OnClick="@(() => OpenChangeDetails(changeGroup))">
                                            View All Changes
                                        </MudButton>
                                    }
                                }
                                else if (changeGroup.ChangeType == ObjectChangeType.Deleted)
                                {
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                        Object was deleted. Final attribute values were not captured.
                                    </MudText>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </ItemContent>
            </MudTimelineItem>
        }
    </MudTimeline>
}

<!-- Change Details Dialog -->
<MudDialog @bind-Visible="_detailsDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudIcon Icon="@GetChangeTypeIcon(_selectedChange?.ChangeType ?? ObjectChangeType.Updated)"
                     Color="@GetChangeTypeColor(_selectedChange?.ChangeType ?? ObjectChangeType.Updated)"
                     Size="Size.Large" />
            <div>
                <MudText Typo="Typo.h6">@_selectedChange?.ChangeType</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @_selectedChange?.ChangeTime.ToLocalTime().ToString("dd MMM yyyy HH:mm:ss")
                </MudText>
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    @GetChangeInitiatorIcon(_selectedChange!)
                    @if (_selectedChange?.ChangeInitiatorType is "User" or "ApiKey" or "SynchronisationRule" && !string.IsNullOrEmpty(_selectedChange.ChangeInitiatorName))
                    {
                        <MudLink Href="@GetInitiatorHref(_selectedChange)">@_selectedChange.ChangeInitiatorName</MudLink>
                    }
                    else if (_selectedChange?.ChangeInitiatorType == "SynchronisationRule")
                    {
                        <MudLink Href="/admin/syncrules">Synchronisation Rule</MudLink>
                    }
                    else
                    {
                        @GetChangeInitiatorDescription(_selectedChange)
                    }
                </MudText>
            </div>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_selectedChange?.AttributeChanges.Any() == true)
        {
            <MudTable Items="@_selectedChange.AttributeChanges"
                      Dense="true"
                      Hover="true"
                      Breakpoint="Breakpoint.Sm"
                      Elevation="0">
                <HeaderContent>
                    <MudTh>Attribute</MudTh>
                    <MudTh>Change</MudTh>
                    <MudTh>Value</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Attribute">
                        <MudText Class="jim-text-code">@context.AttributeName</MudText>
                    </MudTd>
                    <MudTd DataLabel="Change">
                        <MudChip T="string"
                                 Variant="Variant.Text"
                                 Color="@Helpers.GetMudBlazorColorForValueChangeType(context.ChangeType)">
                            @context.ChangeType
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Value">
                        @if (context.ReferenceValue != null)
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudChip T="string" Color="Color.Default" Size="Size.Small">@context.ReferenceValue.TypeName</MudChip>
                                <MudLink Href="@context.ReferenceValue.Href">
                                    @context.ReferenceValue.DisplayName
                                </MudLink>
                                @if (!string.IsNullOrEmpty(context.ReferenceValue.SecondaryId))
                                {
                                    <MudText Class="mud-text-secondary">(@context.ReferenceValue.SecondaryId)</MudText>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudText>@context.Value</MudText>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                Object was deleted. Final attribute values were not captured.
            </MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDetailsDialog" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .change-summary {
        position: relative;
        max-height: 200px;
        overflow: hidden;
    }

    .fade-overlay {
        position: absolute;
        bottom: 48px;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(to bottom, transparent, var(--mud-palette-background));
        pointer-events: none;
    }

    .cursor-pointer {
        cursor: pointer;
        transition: box-shadow 0.2s;
    }

    .cursor-pointer:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

@code {
    /// <summary>
    /// The list of change groups to display (CSO or MVO changes).
    /// </summary>
    [Parameter]
    public List<ChangeGroup> Changes { get; set; } = new();

    private string _searchText = string.Empty;
    private ValueChangeType? _filterChangeType = null;
    private bool _detailsDialogVisible = false;
    private ChangeGroup? _selectedChange = null;

    private DialogOptions _dialogOptions = new DialogOptions
    {
        MaxWidth = MaxWidth.Large,
        FullWidth = true,
        CloseButton = true
    };

    /// <summary>
    /// Represents a group of changes that occurred at a specific point in time.
    /// Works for both ConnectedSystemObjectChange and MetaverseObjectChange.
    /// </summary>
    public class ChangeGroup
    {
        public ObjectChangeType ChangeType { get; set; }
        public DateTime ChangeTime { get; set; }
        public string ChangeInitiatorType { get; set; } = string.Empty;
        public string? ChangeInitiatorName { get; set; }
        public Guid? ChangeInitiatorId { get; set; }
        public List<AttributeChange> AttributeChanges { get; set; } = new();
    }

    /// <summary>
    /// Represents a single attribute change within a change group.
    /// </summary>
    public class AttributeChange
    {
        public string AttributeName { get; set; } = string.Empty;
        public ValueChangeType ChangeType { get; set; }
        public string? Value { get; set; }
        public ReferenceValueInfo? ReferenceValue { get; set; }
    }

    /// <summary>
    /// Reference value information (CSO or MVO).
    /// </summary>
    public class ReferenceValueInfo
    {
        public string TypeName { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string? SecondaryId { get; set; }
        public string Href { get; set; } = string.Empty;
    }

    private class AttributeSummary
    {
        public string AttributeName { get; set; } = string.Empty;
        public ValueChangeType ChangeType { get; set; }
        public int Count { get; set; }
        public string FirstValue { get; set; } = string.Empty;
    }

    private IEnumerable<ChangeGroup> GetFilteredChangeGroups()
    {
        var filtered = Changes.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            filtered = filtered.Select(cg => new ChangeGroup
            {
                ChangeType = cg.ChangeType,
                ChangeTime = cg.ChangeTime,
                ChangeInitiatorType = cg.ChangeInitiatorType,
                ChangeInitiatorName = cg.ChangeInitiatorName,
                AttributeChanges = cg.AttributeChanges
                    .Where(ac => ac.AttributeName.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
                    .ToList()
            }).Where(cg => cg.AttributeChanges.Any() || cg.ChangeType == ObjectChangeType.Deleted);
        }

        // Apply change type filter
        if (_filterChangeType.HasValue)
        {
            filtered = filtered.Select(cg => new ChangeGroup
            {
                ChangeType = cg.ChangeType,
                ChangeTime = cg.ChangeTime,
                ChangeInitiatorType = cg.ChangeInitiatorType,
                ChangeInitiatorName = cg.ChangeInitiatorName,
                AttributeChanges = cg.AttributeChanges
                    .Where(ac => ac.ChangeType == _filterChangeType.Value)
                    .ToList()
            }).Where(cg => cg.AttributeChanges.Any() || cg.ChangeType == ObjectChangeType.Deleted);
        }

        return filtered.OrderByDescending(cg => cg.ChangeTime);
    }

    private IEnumerable<AttributeSummary> GetAttributeSummary(ChangeGroup changeGroup)
    {
        // Group by attribute name and change type, showing first 5
        return changeGroup.AttributeChanges
            .GroupBy(ac => new { ac.AttributeName, ac.ChangeType })
            .Select(g => new AttributeSummary
            {
                AttributeName = g.Key.AttributeName,
                ChangeType = g.Key.ChangeType,
                Count = g.Count(),
                FirstValue = g.First().Value ?? g.First().ReferenceValue?.DisplayName ?? ""
            })
            .Take(5);
    }

    private string GetValueSummary(AttributeSummary summary)
    {
        if (summary.Count == 1)
        {
            return summary.FirstValue;
        }
        else
        {
            return $"{summary.FirstValue} and {summary.Count - 1} more";
        }
    }

    private bool ShouldShowExpandButton(ChangeGroup changeGroup)
    {
        // Show expand button if more than 5 attribute changes
        return changeGroup.AttributeChanges.Count > 5;
    }

    private string GetSummaryStyle(ChangeGroup changeGroup)
    {
        if (ShouldShowExpandButton(changeGroup))
        {
            return "max-height: 150px; overflow: hidden; position: relative;";
        }
        return "";
    }

    private void OpenChangeDetails(ChangeGroup changeGroup)
    {
        _selectedChange = changeGroup;
        _detailsDialogVisible = true;
    }

    private void CloseDetailsDialog()
    {
        _detailsDialogVisible = false;
        _selectedChange = null;
    }

    private string GetRelativeTime(DateTime changeTime)
    {
        var localTime = changeTime.ToLocalTime();
        var now = DateTime.Now;
        var diff = now - localTime;

        if (diff.TotalMinutes < 1)
            return "Just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)}w ago";
        if (diff.TotalDays < 365)
            return $"{(int)(diff.TotalDays / 30)}mo ago";
        return $"{(int)(diff.TotalDays / 365)}y ago";
    }

    private RenderFragment GetChangeInitiatorIcon(ChangeGroup changeGroup)
    {
        return builder =>
        {
            string icon = changeGroup.ChangeInitiatorType switch
            {
                "User" => Icons.Material.Filled.Person,
                "ApiKey" => Icons.Material.Filled.Key,
                "System" => Icons.Material.Filled.Settings,
                _ => Icons.Material.Filled.Rule // SynchronisationRule or other
            };

            builder.OpenComponent<MudIcon>(0);
            builder.AddAttribute(1, "Icon", icon);
            builder.AddAttribute(2, "Size", Size.Small);
            builder.AddAttribute(3, "Style", "margin-right: 4px; vertical-align: text-bottom;");
            builder.CloseComponent();
        };
    }

    private string GetChangeInitiatorDescription(ChangeGroup? changeGroup)
    {
        if (changeGroup == null)
            return string.Empty;

        if (!string.IsNullOrEmpty(changeGroup.ChangeInitiatorName))
        {
            return changeGroup.ChangeInitiatorName;
        }
        return changeGroup.ChangeInitiatorType;
    }

    private string GetInitiatorHref(ChangeGroup changeGroup)
    {
        if (changeGroup.ChangeInitiatorId == null)
            return "#";

        return changeGroup.ChangeInitiatorType switch
        {
            "User" => $"/t/users/v/{changeGroup.ChangeInitiatorId}",
            "ApiKey" => $"/admin/apikeys", // API Keys list page
            "SynchronisationRule" => $"/admin/syncrules/{changeGroup.ChangeInitiatorId}",
            _ => "#"
        };
    }

    private string GetChangeTypeIcon(ObjectChangeType changeType)
    {
        return changeType switch
        {
            ObjectChangeType.Added => Icons.Material.Filled.Add,
            ObjectChangeType.Updated => Icons.Material.Filled.Edit,
            ObjectChangeType.Deleted => Icons.Material.Filled.Delete,
            _ => Icons.Material.Filled.Info
        };
    }

    private Color GetChangeTypeColor(ObjectChangeType changeType)
    {
        return changeType switch
        {
            ObjectChangeType.Added => Color.Success,
            ObjectChangeType.Updated => Color.Info,
            ObjectChangeType.Deleted => Color.Error,
            _ => Color.Default
        };
    }
}
