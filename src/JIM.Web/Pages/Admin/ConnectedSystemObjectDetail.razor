@page "/admin/connected-systems/{CsId:int}/objects/{CsoId}"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.Staging
@using JIM.Models.Staging.DTOs
@using JIM.Models.Transactional
@using JIM.Models.Activities
@using JIM.Models.Core
@using JIM.Models.Enums
@using JIM.Utilities
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject IDialogService DialogService

<PageTitle>Connected System Object: @GetDisplayIdentifier()</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-primary-text">Connected System Object:</span> @GetDisplayIdentifier()
</MudText>
<MudBreadcrumbs Items="Breadcrumbs" Class="ps-0"></MudBreadcrumbs>

<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
    A view of this object as staged within JIM. This includes any attribute values imported from the connected system,
    as well as any pending export changes awaiting export.
</MudText>

@if (ConnectedSystemHeader != null && ConnectedSystemObject != null)
{
    <MudPaper Class="pa-4 mt-4 mb-4" Outlined="true">
        @* First row: Type, Status, Created, Updated, MVO Link *@
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="flex-wrap" Spacing="3">
            @* Object Type *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body1" Class="mud-text-secondary">Type:</MudText>
                <MudChip T="string" Variant="Variant.Text" Color="Color.Primary">
                    @ConnectedSystemObject.Type.Name
                </MudChip>
            </MudStack>
            <MudDivider Vertical="true" FlexItem="true" Class="my-1" />

            @* Status *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body1" Class="mud-text-secondary">Status:</MudText>
                <MudChip T="string" Variant="Variant.Text" Color="GetStatusColor(ConnectedSystemObject.Status)">
                    @ConnectedSystemObject.Status.ToString().SplitOnCapitalLetters()
                </MudChip>
            </MudStack>
            <MudDivider Vertical="true" FlexItem="true" Class="my-1" />

            @* Created *@
            <MudTooltip Text="@ConnectedSystemObject.Created.ToFriendlyDate()" Arrow="true" Placement="Placement.Top">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body1" Class="mud-text-secondary">Created:</MudText>
                    <MudText Typo="Typo.body1">@ConnectedSystemObject.Created.ToRelativeTime()</MudText>
                </MudStack>
            </MudTooltip>

            @* Last Updated *@
            @if (ConnectedSystemObject.LastUpdated.HasValue)
            {
                <MudDivider Vertical="true" FlexItem="true" Class="my-1" />
                <MudTooltip Text="@ConnectedSystemObject.LastUpdated.Value.ToFriendlyDate()" Arrow="true"
                    Placement="Placement.Top">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.body1" Class="mud-text-secondary">Updated:</MudText>
                        <MudText Typo="Typo.body1">@ConnectedSystemObject.LastUpdated.Value.ToRelativeTime()</MudText>
                    </MudStack>
                </MudTooltip>
            }

            @* Metaverse Link *@
            @if (ConnectedSystemObject.MetaverseObjectId.HasValue && ConnectedSystemObject.MetaverseObject != null)
            {
                <MudDivider Vertical="true" FlexItem="true" Class="my-1" />
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body1" Class="mud-text-secondary">Metaverse Object:</MudText>
                    <MudLink Typo="Typo.body1" Href="@Utilities.GetMetaverseObjectHref(ConnectedSystemObject.MetaverseObject)">
                        @(Utilities.GetMetaverseObjectHrefText(ConnectedSystemObject.MetaverseObject) ??
                                        ConnectedSystemObject.MetaverseObjectId.ToString())
                    </MudLink>
                </MudStack>
                <MudDivider Vertical="true" FlexItem="true" Class="my-1" />
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body1" Class="mud-text-secondary">Join Type:</MudText>
                    <MudChip T="string" Variant="Variant.Text" Color="GetJoinTypeColor(ConnectedSystemObject.JoinType)">
                        @ConnectedSystemObject.JoinType
                    </MudChip>
                </MudStack>
            }
        </MudStack>

    </MudPaper>

    @if (PendingExport != null && PendingExport.AttributeValueChanges.Count > 0)
    {
        <MudPaper Class="pa-5 mt-5 mb-5" Outlined="true">
            <MudText Typo="Typo.h6">Pending Exports</MudText>
            <MudText Typo="Typo.subtitle1" Class="my-3">
                The following attribute changes are pending for this connected system. These may be awaiting export, or have
                already been exported
                and are awaiting confirmation via a subsequent import. Once confirmed, these changes will be reflected in the
                CSO attribute values below.
            </MudText>
            <MudTable Items="@PendingExport.AttributeValueChanges" Hover="true" Dense="true" Outlined="true" Elevation="0">
                <HeaderContent>
                    <MudTh>
                        <MudText Typo="Typo.button">Attribute</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Typo="Typo.button">Change Type</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Typo="Typo.button">Value</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Typo="Typo.button">Status</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Typo="Typo.button">Export Attempts</MudText>
                    </MudTh>
                    <MudTh>
                        <MudText Typo="Typo.button">Last Exported</MudText>
                    </MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Attribute">@(context.Attribute?.Name ?? $"Attribute {context.AttributeId}")</MudTd>
                    <MudTd DataLabel="Change Type">
                        <MudChip T="string" Variant="Variant.Text" Color="GetAttributeChangeTypeColor(context.ChangeType)"
                           >
                            @context.ChangeType
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Value">@GetAttributeValue(context)</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Variant="Variant.Text" Color="GetAttributeChangeStatusColor(context.Status)"
                           >
                            @context.Status.ToString().SplitOnCapitalLetters()
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Export Attempts">@context.ExportAttemptCount</MudTd>
                    <MudTd DataLabel="Last Exported">@(context.LastExportedAt?.ToFriendlyDate() ?? "-")</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }

    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="false" Outlined="true" PanelClass="pa-0 mt-4">
        <MudTabPanel Text="Attributes">
            <MudPaper Class="pa-0" Outlined="true">
                <MudSimpleTable Hover="true" Elevation="0" Class="jim-attribute-table">
                    <thead>
                        <tr>
                            <th class="jim-attr-header-name">Attribute</th>
                            <th class="jim-attr-header-value">Value</th>
                            <th class="jim-attr-header-type">Type</th>
                            <th class="jim-attr-header-plurality">Plurality</th>
                            <th class="jim-attr-header-extid">External ID?</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var groupedAttributes = GetGroupedAttributes();
                        }
                        @if (!groupedAttributes.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-center pa-4">
                                    <MudText Typo="Typo.body1" Class="mud-text-secondary">No attributes to display</MudText>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var group in groupedAttributes)
                            {
                                <tr class="@(group.Values.Count > 1 ? "jim-attr-row-mva" : "")">
                                    <td class="jim-attr-name">
                                        <MudText Typo="Typo.body1" Class="mud-text-secondary">@group.AttributeName</MudText>
                                    </td>
                                    <td class="jim-attr-value">
                                        @if (group.Values.Count == 1)
                                        {
                                            <CsoAttributeValue Value="@group.Values[0]" />
                                        }
                                        else if (group.Values.Count <= MvaInlineThreshold)
                                        {
                                            <div class="jim-attr-expanded">
                                                @foreach (var val in group.Values)
                                                {
                                                    <div class="jim-attr-expanded-item">
                                                        <CsoAttributeValue Value="@val" />
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="jim-attr-expanded">
                                                @foreach (var val in group.Values.Take(MvaInlineThreshold))
                                                {
                                                    <div class="jim-attr-expanded-item">
                                                        <CsoAttributeValue Value="@val" />
                                                    </div>
                                                }
                                                <MudButton Variant="Variant.Outlined" Class="jim-attr-expand-btn"
                                                    OnClick="@(() => OpenMvaDialogAsync(group.AttributeName, group.Values))">
                                                    +@(group.Values.Count - MvaInlineThreshold) more
                                                </MudButton>
                                            </div>
                                        }
                                    </td>
                                    <td class="jim-attr-type">
                                        <MudText Typo="Typo.body1" Class="mud-text-secondary">@group.Values[0].Attribute.Type
                                        </MudText>
                                    </td>
                                    <td class="jim-attr-plurality">
                                        @if (group.IsMultiValued)
                                        {
                                            <MudText Typo="Typo.body1" Class="mud-text-secondary">Multi</MudText>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body1" Class="mud-text-secondary">Single</MudText>
                                        }
                                    </td>
                                    <td>
                                        @if (IsExternalId(group.Values[0]))
                                        {
                                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined">External ID</MudChip>
                                        }
                                        else if (IsSecondaryExternalId(group.Values[0]))
                                        {
                                            <MudChip T="string" Color="Color.Secondary" Variant="Variant.Outlined">Secondary ID</MudChip>
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        </MudTabPanel>
        <MudTabPanel Text="Change History">
            @if (CsoChanges == null)
            {
                <MudProgressCircular Indeterminate="true" Class="mr-2" />
                <MudText>Loading change history...</MudText>
            }
            else
            {
                <ChangeHistoryTimeline Changes="@GetCsoChangeHistory()" />
            }
        </MudTabPanel>
    </MudTabs>
}

@code {
    /// <summary>
    /// Connected System ID.
    /// </summary>
    [Parameter]
    public int CsId { get; set; }

    /// <summary>
    /// Connected System Object ID.
    /// </summary>
    [Parameter]
    public string CsoId { get; set; } = null!;

    private ConnectedSystemHeader? ConnectedSystemHeader { get; set; }

    private ConnectedSystemObject? ConnectedSystemObject { get; set; }

    private ConnectedSystemObjectAttributeValue? ExternalIdAttributeValue { get; set; }

    private ConnectedSystemObjectAttributeValue? SecondaryExternalIdAttributeValue { get; set; }

    private PendingExport? PendingExport { get; set; }

    private List<ConnectedSystemObjectChange>? CsoChanges { get; set; }

    private List<BreadcrumbItem> Breadcrumbs { get; set; } = null!;

    protected override async Task OnParametersSetAsync()
    {
        ConnectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(CsId);
        if (ConnectedSystemHeader == null)
        {
            // ConnectedSystem not found, redirect to the Connected Systems index page
            NavManager.NavigateTo($"/admin/connected-systems/");
            return;
        }

        var csoIdValid = Guid.TryParse(CsoId, out var connectedSystemObjectId);
        if (!csoIdValid)
        {
            NavManager.NavigateTo(Utilities.GetConnectedSystemObjectsHref(CsId));
            return;
        }

        ConnectedSystemObject = await Jim.ConnectedSystems.GetConnectedSystemObjectAsync(CsId, connectedSystemObjectId);
        if (ConnectedSystemObject == null)
        {
            // ConnectedSystemObject not found, redirect to Connected System Objects index page
            NavManager.NavigateTo(Utilities.GetConnectedSystemObjectsHref(CsId));
            return;
        }

        Breadcrumbs = new List<BreadcrumbItem>
        {
            new("Home", href: "/", icon: Icons.Material.Filled.Home),
            new("Connected Systems", href: "/admin/connected-systems/"),
            new(ConnectedSystemHeader.Name, href: Utilities.GetConnectedSystemHref(ConnectedSystemHeader)),
            new("Objects", href: Utilities.GetConnectedSystemObjectsHref(ConnectedSystemHeader)),
            new(GetDisplayIdentifier(), href: null, disabled: true)
        };

        ExternalIdAttributeValue = ConnectedSystemObject.ExternalIdAttributeValue;
        SecondaryExternalIdAttributeValue = ConnectedSystemObject.SecondaryExternalIdAttributeValue;

        // Fetch pending export for this CSO
        PendingExport = await Jim.ConnectedSystems.GetPendingExportForObjectAsync(connectedSystemObjectId);

        // Fetch change history for this CSO
        CsoChanges = await Jim.ConnectedSystems.GetConnectedSystemObjectChangesAsync(connectedSystemObjectId);
    }

    private const int MvaInlineThreshold = 10;

    private record AttributeGroup(
    string AttributeName,
    List<ConnectedSystemObjectAttributeValue> Values,
    bool IsMultiValued);

    private List<AttributeGroup> GetGroupedAttributes()
    {
        if (ConnectedSystemObject == null)
            return new List<AttributeGroup>();

        return ConnectedSystemObject.AttributeValues
        .GroupBy(v => v.Attribute.Name)
        .OrderBy(g => g.Key)
        .Select(g => new AttributeGroup(
        g.Key,
        g.ToList(),
        g.First().Attribute.AttributePlurality == AttributePlurality.MultiValued))
        .ToList();
    }

    private bool IsExternalId(ConnectedSystemObjectAttributeValue value)
    {
        if (ConnectedSystemObject == null) return false;
        var attributeId = value.AttributeId != 0 ? value.AttributeId : value.Attribute?.Id ?? 0;
        return attributeId == ConnectedSystemObject.ExternalIdAttributeId;
    }

    private bool IsSecondaryExternalId(ConnectedSystemObjectAttributeValue value)
    {
        if (ConnectedSystemObject?.SecondaryExternalIdAttributeId == null) return false;
        var attributeId = value.AttributeId != 0 ? value.AttributeId : value.Attribute?.Id ?? 0;
        return attributeId == ConnectedSystemObject.SecondaryExternalIdAttributeId;
    }

    private async Task OpenMvaDialogAsync(string attributeName, List<ConnectedSystemObjectAttributeValue> values)
    {
        var parameters = new DialogParameters<CsoMvaDialog>
        {
            { x => x.AttributeName, attributeName },
            { x => x.Values, values }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        await DialogService.ShowAsync<CsoMvaDialog>(attributeName, parameters, options);
    }

    private static string GetAttributeValue(PendingExportAttributeValueChange change)
    {
        if (!string.IsNullOrEmpty(change.UnresolvedReferenceValue))
            return $"[Unresolved Reference: {change.UnresolvedReferenceValue}]";

        if (change.StringValue != null)
            return change.StringValue;

        if (change.DateTimeValue.HasValue)
            return change.DateTimeValue.Value.ToFriendlyDate();

        if (change.IntValue.HasValue)
            return change.IntValue.Value.ToString();

        if (change.ByteValue != null)
            return $"[Binary data: {change.ByteValue.Length} bytes]";

        return "[null]";
    }

    private static MudBlazor.Color GetAttributeChangeTypeColor(PendingExportAttributeChangeType changeType)
    {
        return changeType switch
        {
            PendingExportAttributeChangeType.Add => MudBlazor.Color.Primary,
            PendingExportAttributeChangeType.Update => MudBlazor.Color.Info,
            PendingExportAttributeChangeType.Remove => MudBlazor.Color.Warning,
            PendingExportAttributeChangeType.RemoveAll => MudBlazor.Color.Error,
            _ => MudBlazor.Color.Default,
        };
    }

    private static MudBlazor.Color GetAttributeChangeStatusColor(PendingExportAttributeChangeStatus status)
    {
        return status switch
        {
            PendingExportAttributeChangeStatus.Pending => MudBlazor.Color.Default,
            PendingExportAttributeChangeStatus.ExportedPendingConfirmation => MudBlazor.Color.Info,
            PendingExportAttributeChangeStatus.ExportedNotConfirmed => MudBlazor.Color.Warning,
            PendingExportAttributeChangeStatus.Failed => MudBlazor.Color.Error,
            _ => MudBlazor.Color.Default,
        };
    }

    private static MudBlazor.Color GetStatusColor(ConnectedSystemObjectStatus status)
    {
        return status switch
        {
            ConnectedSystemObjectStatus.Normal => MudBlazor.Color.Success,
            ConnectedSystemObjectStatus.Obsolete => MudBlazor.Color.Warning,
            ConnectedSystemObjectStatus.PendingProvisioning => MudBlazor.Color.Info,
            _ => MudBlazor.Color.Default,
        };
    }

    private static MudBlazor.Color GetJoinTypeColor(ConnectedSystemObjectJoinType joinType)
    {
        return joinType switch
        {
            ConnectedSystemObjectJoinType.Projected => MudBlazor.Color.Primary,
            ConnectedSystemObjectJoinType.Provisioned => MudBlazor.Color.Secondary,
            ConnectedSystemObjectJoinType.Joined => MudBlazor.Color.Info,
            ConnectedSystemObjectJoinType.NotJoined => MudBlazor.Color.Default,
            _ => MudBlazor.Color.Default,
        };
    }

    private List<ChangeHistoryTimeline.ChangeGroup> GetCsoChangeHistory()
    {
        if (CsoChanges == null)
            return new List<ChangeHistoryTimeline.ChangeGroup>();

        return CsoChanges
        .OrderByDescending(c => c.ChangeTime)
        .Select(change => new ChangeHistoryTimeline.ChangeGroup
        {
            ChangeType = change.ChangeType,
            ChangeTime = change.ChangeTime,
            // CSO changes: Map the principal that initiated the import (User or ApiKey)
            ChangeInitiatorType = MapInitiatorType(change.InitiatedByType),
            ChangeInitiatorName = change.InitiatedByName,
            ChangeInitiatorId = change.InitiatedById,
            // Mechanism is Import, with link to connected system and run profile name
            ChangeMechanismType = "Import",
            ConnectedSystemId = ConnectedSystemHeader?.Id,
            ConnectedSystemName = ConnectedSystemHeader?.Name,
            RunProfileName = change.ActivityRunProfileExecutionItem?.Activity?.TargetName,
            SyncRuleId = null,
            SyncRuleName = null,
            ActivityRunProfileExecutionItemId = change.ActivityRunProfileExecutionItemId,
            AttributeChanges = change.AttributeChanges
        .OrderBy(ac => ac.Attribute.Name)
        .SelectMany(ac => ac.ValueChanges.Select(vc => new ChangeHistoryTimeline.AttributeChange
        {
            AttributeName = ac.Attribute.Name,
            ChangeType = vc.ValueChangeType,
            Value = vc.ReferenceValue == null ? vc.ToString() : null,
            ReferenceValue = vc.ReferenceValue != null ? new ChangeHistoryTimeline.ReferenceValueInfo
            {
                TypeName = vc.ReferenceValue.Type.Name,
                DisplayName = vc.ReferenceValue.DisplayNameOrId ?? vc.ReferenceValue.Id.ToString(),
                SecondaryId = vc.ReferenceValue.SecondaryExternalIdAttributeValue?.ToStringNoName(),
                Href = Utilities.GetConnectedSystemObjectHref(vc.ReferenceValue)
            } : null,
            IsMultiValued = ac.Attribute.AttributePlurality == AttributePlurality.MultiValued
        }))
        .ToList()
        })
        .ToList();
    }

    private static string MapInitiatorType(ActivityInitiatorType initiatorType)
    {
        return initiatorType switch
        {
            ActivityInitiatorType.User => "User",
            ActivityInitiatorType.ApiKey => "ApiKey",
            _ => "Unknown"
        };
    }

    /// <summary>
    /// Gets a user-friendly display identifier for the CSO.
    /// Returns the external ID value if available, otherwise falls back to the internal GUID.
    /// </summary>
    private string GetDisplayIdentifier()
    {
        return ExternalIdAttributeValue?.ToStringNoName()
        ?? ConnectedSystemObject?.Id.ToString()
        ?? CsoId;
    }
}
