@page "/activity/sync/{Id:guid}"
@attribute [Authorize(Roles = "User")]
@using JIM.Application
@using JIM.Models.Activities;
@using JIM.Models.Core
@using JIM.Models.Enums;
@using JIM.Models.Staging
@using JIM.Models.Staging.DTOs
@using JIM.Utilities;
@inject JimApplication Jim
@inject NavigationManager NavManager

<PageTitle>Sync Details: @(_externalIdAttributeValue?.ToStringNoName() ?? _activityRunProfileExecutionItem?.Id.ToString())</PageTitle>

@if (_activityRunProfileExecutionItem != null)
{
    <MudBreadcrumbs Items="_breadcrumbs" Class="ps-0 mb-4"></MudBreadcrumbs>

    @* Page Title *@
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
        <MudText Typo="Typo.h5">@GetStatusTitle()</MudText>
        <MudIcon Icon="@GetStatusIcon()" Size="Size.Large" Color="@GetStatusColor()" />
    </MudStack>

    @* Summary Section *@
    <MudText Typo="Typo.h6" Class="mb-2">
        Execution Summary
    </MudText>
    <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3">
        @GetStatusDescription()
    </MudText>
    <MudPaper Class="pa-5 mb-5" Outlined="true">
        <MudGrid Spacing="3">
            @* Connected System *@
            @if (_connectedSystemHeader != null)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.overline" Class="mud-text-secondary">Connected System</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Small" Class="mud-text-secondary" />
                        <MudLink Href="@Utilities.GetConnectedSystemHref(_connectedSystemHeader)" Typo="Typo.body1">
                            @_connectedSystemHeader.Name
                        </MudLink>
                    </MudStack>
                </MudItem>
            }

            @* Run Profile *@
            @if (_activity != null)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.overline" Class="mud-text-secondary">Run Profile</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Small" Class="mud-text-secondary" />
                        <MudText Typo="Typo.body1">@_activity.TargetName</MudText>
                    </MudStack>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.overline" Class="mud-text-secondary">Executed</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mud-text-secondary" />
                        <MudText Typo="Typo.body1" title="@_activity.Executed.ToLocalTime().ToString("F")">
                            @_activity.Executed.ToLocalTime().ToRelativeTime()
                        </MudText>
                    </MudStack>
                </MudItem>
            }

            @* Initiated By *@
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.overline" Class="mud-text-secondary">Initiated By</MudText>
                @if (_activity is { InitiatedByType: ActivityInitiatorType.User, InitiatedByMetaverseObject: not null })
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mud-text-secondary" />
                        <MudLink Href="@(Utilities.GetMetaverseObjectHref(_activity.InitiatedByMetaverseObject))" Typo="Typo.body1">
                            @_activity.InitiatedByMetaverseObject.DisplayName
                        </MudLink>
                    </MudStack>
                }
                else if (_activity is { InitiatedByType: ActivityInitiatorType.ApiKey })
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Class="mud-text-secondary" />
                        @if (_activity.InitiatedByApiKey != null)
                        {
                            <MudLink Href="@Utilities.GetApiKeyHref(_activity.InitiatedByApiKey.Id)" Typo="Typo.body1">
                                @_activity.InitiatedByName
                            </MudLink>
                        }
                        else
                        {
                            <MudText Typo="Typo.body1">@_activity.InitiatedByName</MudText>
                        }
                    </MudStack>
                }
                else if (_activity != null && !string.IsNullOrEmpty(_activity.InitiatedByName))
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Class="mud-text-secondary" />
                        <MudText Typo="Typo.body1">@_activity.InitiatedByName</MudText>
                    </MudStack>
                }
                else
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="Size.Small" Class="mud-text-secondary" />
                        <MudText Typo="Typo.body1">System (Automated)</MudText>
                    </MudStack>
                }
            </MudItem>

            @* Change Type - hide when NotSet with error (rejected imports don't have an operation) *@
            @if (!(_activityRunProfileExecutionItem.ObjectChangeType == ObjectChangeType.NotSet &&
                   _activityRunProfileExecutionItem.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet))
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.overline" Class="mud-text-secondary">Operation</MudText><br />
                    <MudChip T="string"
                             Color="@Helpers.GetRunItemMudBlazorColorForType(_activityRunProfileExecutionItem.ObjectChangeType)"
                             Variant="Variant.Filled"
                             Size="Size.Medium"
                             Icon="@GetChangeTypeIcon()"
                             Class="ml-0 mt-1">
                        @_activityRunProfileExecutionItem.ObjectChangeType.ToString().SplitOnCapitalLetters()
                    </MudChip>
                </MudItem>
            }

            @* Connected System Object / External ID - label changes based on context *@
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.overline" Class="mud-text-secondary">@GetObjectFieldLabel()</MudText>
                @if (_activityRunProfileExecutionItem.ConnectedSystemObject != null)
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="flex-wrap">
                        <MudChip T="string" Color="Color.Default">
                            @_activityRunProfileExecutionItem.ConnectedSystemObject.Type.Name
                        </MudChip>
                        @if (_externalIdAttributeValue != null)
                        {
                            <MudLink Href="@(Utilities.GetConnectedSystemObjectHref(_activityRunProfileExecutionItem.ConnectedSystemObject))"
                                     Class="jim-text-code">
                                @_externalIdAttributeValue.ToStringNoName()
                            </MudLink>
                        }
                        else
                        {
                            <MudLink Href="@(Utilities.GetConnectedSystemObjectHref(_activityRunProfileExecutionItem.ConnectedSystemObject))">
                                View Object
                            </MudLink>
                        }
                    </MudStack>
                }
                else if (!string.IsNullOrEmpty(_activityRunProfileExecutionItem.ExternalIdSnapshot))
                {
                    @* CSO doesn't exist but we have an external ID snapshot - differentiate between error (rejected) vs deleted *@
                    @if (_activityRunProfileExecutionItem.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudTooltip Text="This object was not created due to an import error. The external ID shown is from the source data.">
                                <MudChip T="string" Color="Color.Error" Size="Size.Small" Icon="@Icons.Material.Filled.Block">
                                    Rejected
                                </MudChip>
                            </MudTooltip>
                            <MudText Class="jim-text-code">@_activityRunProfileExecutionItem.ExternalIdSnapshot</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudTooltip Text="This object has been deleted. The external ID shown is preserved from when this operation was recorded.">
                                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.History">
                                    Deleted
                                </MudChip>
                            </MudTooltip>
                            <MudText Class="jim-text-code">@_activityRunProfileExecutionItem.ExternalIdSnapshot</MudText>
                        </MudStack>
                    }
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Not available</MudText>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* Projection Flow Visualisation - shown for Projected items *@
    @if (_activityRunProfileExecutionItem.ObjectChangeType == ObjectChangeType.Projected)
    {
        <MudText Typo="Typo.h6" Class="mb-3">Projection Details</MudText>
        <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3">
            The following connected system object was projected to create a new metaverse object.
        </MudText>

        <MudGrid Spacing="3" Class="mb-5">
            @* Source: Connected System Object Card *@
            <MudItem xs="12" md="5">
                <MudPaper Class="pa-4" Outlined="true" Style="height: 100%; border-left: 4px solid var(--mud-palette-info);">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Storage" Color="Color.Info" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Source Object</MudText>
                        </MudStack>

                        @if (_activityRunProfileExecutionItem.ConnectedSystemObject != null)
                        {
                            var cso = _activityRunProfileExecutionItem.ConnectedSystemObject;

                            @* Object Type *@
                            <div>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">Type</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-0">
                                    @cso.Type.Name
                                </MudChip>
                            </div>

                            @* External ID *@
                            <div>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">External ID</MudText>
                                <MudText Class="jim-text-code" Style="word-break: break-all;">
                                    @(_externalIdAttributeValue?.ToStringNoName() ?? "-")
                                </MudText>
                            </div>

                            @* Secondary External ID (if available) *@
                            @if (cso.SecondaryExternalIdAttributeValue != null)
                            {
                                <div>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Secondary ID</MudText>
                                    <MudText Class="jim-text-code" Style="word-break: break-all;">
                                        @cso.SecondaryExternalIdAttributeValue.ToStringNoName()
                                    </MudText>
                                </div>
                            }

                            @* Display Name (if available) *@
                            var csoDisplayName = cso.AttributeValues
                                .FirstOrDefault(av => av.Attribute.Name.Equals("displayname", StringComparison.OrdinalIgnoreCase))?.StringValue;
                            if (!string.IsNullOrEmpty(csoDisplayName))
                            {
                                <div>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Display Name</MudText>
                                    <MudText>@csoDisplayName</MudText>
                                </div>
                            }

                            <MudDivider Class="my-2" />

                            <MudButton Variant="Variant.Text"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.OpenInNew"
                                       Href="@Utilities.GetConnectedSystemObjectHref(cso)">
                                View Connected System Object
                            </MudButton>
                        }
                        else
                        {
                            <MudText Class="mud-text-secondary">Source object data not available</MudText>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>

            @* Arrow / Flow Indicator *@
            <MudItem xs="12" md="2" Class="d-flex align-center justify-center">
                <MudStack AlignItems="AlignItems.Center" Spacing="1">
                    @* Desktop: horizontal arrow *@
                    <MudHidden Breakpoint="Breakpoint.SmAndDown">
                        <MudIcon Icon="@Icons.Material.Filled.ArrowForward"
                                 Size="Size.Large"
                                 Color="Color.Primary"
                                 Style="font-size: 3rem;" />
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Color="Color.Primary"
                                 Variant="Variant.Outlined">
                            Projected
                        </MudChip>
                    </MudHidden>
                    @* Mobile: vertical arrow *@
                    <MudHidden Breakpoint="Breakpoint.MdAndUp">
                        <MudIcon Icon="@Icons.Material.Filled.ArrowDownward"
                                 Size="Size.Large"
                                 Color="Color.Primary"
                                 Style="font-size: 2.5rem;" />
                        <MudChip T="string"
                                 Size="Size.Small"
                                 Color="Color.Primary"
                                 Variant="Variant.Outlined">
                            Projected
                        </MudChip>
                    </MudHidden>
                </MudStack>
            </MudItem>

            @* Destination: Metaverse Object Card *@
            <MudItem xs="12" md="5">
                <MudPaper Class="pa-4" Outlined="true" Style="height: 100%; border-left: 4px solid var(--mud-palette-primary);">
                    <MudStack Spacing="2">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@Icons.Material.Filled.Hub" Color="Color.Primary" />
                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">Metaverse Object</MudText>
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Filled">New</MudChip>
                        </MudStack>

                        @if (_metaverseObject != null)
                        {
                            @* Object Type *@
                            <div>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">Type</MudText>
                                <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-0">
                                    @_metaverseObject.Type.Name
                                </MudChip>
                            </div>

                            @* Display Name (if available) *@
                            @if (!string.IsNullOrEmpty(_metaverseObject.DisplayName))
                            {
                                <div>
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary">Display Name</MudText>
                                    <MudText Style="font-weight: 500;">@_metaverseObject.DisplayName</MudText>
                                </div>
                            }

                            @* Preview of MVO Attributes (up to 5, excluding displayName) *@
                            var previewAttributes = GetMvoAttributePreview();
                            if (previewAttributes.Any())
                            {
                                <MudDivider Class="my-1" />
                                <MudText Typo="Typo.caption" Class="mud-text-secondary mb-1">Attributes</MudText>
                                foreach (var attr in previewAttributes)
                                {
                                    <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Start" Class="mb-1">
                                        <MudText Typo="Typo.body2" Class="jim-text-code" Style="min-width: 100px; flex-shrink: 0;">@attr.Name</MudText>
                                        <MudText Typo="Typo.body2" Style="word-break: break-word;">@attr.DisplayValue</MudText>
                                    </MudStack>
                                }

                                var totalAttributes = _metaverseObject.AttributeValues
                                    .Where(av => !av.Attribute.Name.Equals(Constants.BuiltInAttributes.DisplayName, StringComparison.OrdinalIgnoreCase))
                                    .Count();
                                var remainingCount = totalAttributes - previewAttributes.Count();
                                if (remainingCount > 0)
                                {
                                    <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                                        +@remainingCount more attribute@(remainingCount != 1 ? "s" : "")
                                    </MudText>
                                }
                            }

                            <MudDivider Class="my-2" />

                            <MudButton Variant="Variant.Text"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       StartIcon="@Icons.Material.Filled.OpenInNew"
                                       Href="@Utilities.GetMetaverseObjectHref(_metaverseObject)">
                                View Metaverse Object
                            </MudButton>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Dense="true" Class="mt-2">
                                The projected metaverse object may have been deleted.
                            </MudAlert>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }

    @* Attribute Changes Section *@
    @if (_activityRunProfileExecutionItem.ConnectedSystemObjectChange != null)
    {
        var changeCount = _activityRunProfileExecutionItem.ConnectedSystemObjectChange.AttributeChanges
            .Sum(c => c.ValueChanges.Count);

        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3">
            <MudText Typo="Typo.h6">
                Attribute Changes
            </MudText>
            <MudChip T="string" Size="Size.Small" Color="Color.Primary">@changeCount</MudChip>
        </MudStack>

        <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3">
            The following attributes were modified during this synchronisation operation.
        </MudText>

        <MudTable Items="@GetFlattenedChanges()"
                  Hover="true"
                  Dense="true"
                  Outlined="true"
                  Elevation="0"
                  Class="mb-5">
            <HeaderContent>
                <MudTh Style="width: 25%;">Attribute</MudTh>
                <MudTh Style="width: 15%;">Change</MudTh>
                <MudTh Style="width: 60%;">Value</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Attribute">
                    <MudText Class="jim-text-code">@context.AttributeName</MudText>
                </MudTd>
                <MudTd DataLabel="Change">
                    <MudChip T="string"
                             Variant="Variant.Text"
                             Color="@Helpers.GetMudBlazorColorForValueChangeType(context.ChangeType)"
                             Class="ml-0">
                        @context.ChangeType
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Value">
                    @if (context.ReferenceValue != null)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudChip T="string" Color="Color.Default" Size="Size.Small">@context.ReferenceValue.Type.Name</MudChip>
                            <MudLink Href="@Utilities.GetConnectedSystemObjectHref(context.ReferenceValue)">
                                @context.ReferenceValue.DisplayNameOrId
                            </MudLink>
                            @if (context.ReferenceValue.SecondaryExternalIdAttributeValue != null)
                            {
                                <MudText Class="mud-text-secondary">(@context.ReferenceValue.SecondaryExternalIdAttributeValue.ToString())</MudText>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudText>@context.Value</MudText>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4">No attribute changes recorded.</MudText>
            </NoRecordsContent>
        </MudTable>
    }
    else if (_activityRunProfileExecutionItem.ObjectChangeType == ObjectChangeType.NoChange)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-5">
            <MudText Typo="Typo.body1">No Changes Required</MudText>
            <MudText Typo="Typo.body2">
                @if (_activityRunProfileExecutionItem.NoChangeReason != null)
                {
                    @_activityRunProfileExecutionItem.NoChangeReason.ToString()!.SplitOnCapitalLetters()
                }
                else
                {
                    <text>The object was already up to date with no attribute changes needed.</text>
                }
            </MudText>
        </MudAlert>
    }

    @* Error Section *@
    @if (_activityRunProfileExecutionItem.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
    {
        <MudText Typo="Typo.h6" Class="mb-3">
            Error Details
        </MudText>

        <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Class="mb-3 jim-alert-error">
            <MudText Typo="Typo.body1" Style="font-weight: 500;">
                @_activityRunProfileExecutionItem.ErrorType.ToString()!.SplitOnCapitalLetters()
            </MudText>
            @if (!string.IsNullOrEmpty(_activityRunProfileExecutionItem.ErrorMessage))
            {
                <MudText Typo="Typo.body1" Class="mt-2">@_activityRunProfileExecutionItem.ErrorMessage</MudText>
            }
        </MudAlert>

        @if (!string.IsNullOrEmpty(_activityRunProfileExecutionItem.ErrorStackTrace))
        {
            <MudExpansionPanels Class="mb-5">
                <MudExpansionPanel Text="Stack Trace" MaxHeight="400">
                    <pre class="jim-text-code" style="white-space: pre-wrap; word-wrap: break-word; overflow-x: auto; font-size: 0.8rem; margin: 0;">@_activityRunProfileExecutionItem.ErrorStackTrace</pre>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
    }
}
else
{
    <MudProgressCircular Indeterminate="true" />
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private ActivityRunProfileExecutionItem? _activityRunProfileExecutionItem;
    private Activity? _activity;
    private ConnectedSystemHeader? _connectedSystemHeader;
    private List<BreadcrumbItem> _breadcrumbs = null!;
    private ConnectedSystemObjectAttributeValue? _externalIdAttributeValue;
    private MetaverseObject? _metaverseObject;

    /// <summary>
    /// Helper record for flattened changes display in the table.
    /// </summary>
    private record FlattenedChange(
        string AttributeName,
        ValueChangeType ChangeType,
        string? Value,
        ConnectedSystemObject? ReferenceValue);

    /// <summary>
    /// Helper record for MVO attribute preview display.
    /// </summary>
    private record MvoAttributePreview(string Name, string DisplayValue);

    /// <summary>
    /// Maximum number of attributes to show in the MVO preview.
    /// </summary>
    private const int MaxPreviewAttributes = 5;

    protected override async Task OnParametersSetAsync()
    {
        _activityRunProfileExecutionItem = await Jim.Activities.GetActivityRunProfileExecutionItemAsync(Id);
        if (_activityRunProfileExecutionItem == null)
        {
            NavManager.NavigateTo("/activity");
            return;
        }

        _breadcrumbs = new List<BreadcrumbItem>
        {
            new("Home", href: "/", icon: Icons.Material.Filled.Home),
            new("Activity", href: "/activity"),
            new("Activity Detail", href: $"/activity/{_activityRunProfileExecutionItem.ActivityId}"),
            new("Sync Details", href: null, disabled: true)
        };

        _activity = await Jim.Activities.GetActivityAsync(_activityRunProfileExecutionItem.ActivityId);
        _externalIdAttributeValue = _activityRunProfileExecutionItem.GetExternalIdAttributeValue();

        var connectedSystemId = _activityRunProfileExecutionItem.GetConnectedSystemId();
        if (connectedSystemId != null)
            _connectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(connectedSystemId.Value);

        // For projected items, get the MVO from the MetaverseObjectChange or fall back to CSO.MetaverseObject
        // Note: MetaverseObjectChange is not currently populated during sync, so we primarily use CSO.MetaverseObject
        if (_activityRunProfileExecutionItem.ObjectChangeType == ObjectChangeType.Projected)
        {
            _metaverseObject = _activityRunProfileExecutionItem.MetaverseObjectChange?.MetaverseObject
                ?? _activityRunProfileExecutionItem.ConnectedSystemObject?.MetaverseObject;
        }
    }

    /// <summary>
    /// Gets a preview of MVO attributes for display, excluding displayName and limiting multi-valued attributes.
    /// </summary>
    private IEnumerable<MvoAttributePreview> GetMvoAttributePreview()
    {
        if (_metaverseObject == null)
            return Enumerable.Empty<MvoAttributePreview>();

        return _metaverseObject.AttributeValues
            .Where(av => !av.Attribute.Name.Equals(Constants.BuiltInAttributes.DisplayName, StringComparison.OrdinalIgnoreCase))
            .OrderBy(av => av.Attribute.Name)
            .Take(MaxPreviewAttributes)
            .Select(av => new MvoAttributePreview(
                av.Attribute.Name,
                FormatAttributeValue(av)
            ));
    }

    /// <summary>
    /// Formats an attribute value for preview display.
    /// </summary>
    private static string FormatAttributeValue(MetaverseObjectAttributeValue attributeValue)
    {
        // Use the built-in ToString() method which handles all value types
        var result = attributeValue.ToString();
        if (string.IsNullOrEmpty(result))
            return "-";

        // Remove the attribute name prefix if present (format is "AttributeName: Value")
        if (attributeValue.Attribute != null)
        {
            var prefix = $"{attributeValue.Attribute.Name}: ";
            if (result.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
                result = result.Substring(prefix.Length);
        }

        return result;
    }

    private Color GetStatusColor()
    {
        if (_activityRunProfileExecutionItem?.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
            return Color.Error;

        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => Color.Success,
            ObjectChangeType.Updated => Color.Info,
            ObjectChangeType.Deleted => Color.Warning,
            // Sync operations
            ObjectChangeType.Projected => Color.Primary,
            ObjectChangeType.Joined => Color.Secondary,
            ObjectChangeType.AttributeFlow => Color.Info,
            ObjectChangeType.Disconnected => Color.Warning,
            // Export operations
            ObjectChangeType.Provisioned => Color.Success,
            ObjectChangeType.Exported => Color.Primary,
            ObjectChangeType.Deprovisioned => Color.Warning,
            // Other
            ObjectChangeType.NoChange => Color.Default,
            _ => Color.Default
        };
    }

    private string GetStatusIcon()
    {
        if (_activityRunProfileExecutionItem?.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
            return Icons.Material.Filled.Error;

        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => Icons.Material.Filled.Add,
            ObjectChangeType.Updated => Icons.Material.Filled.Edit,
            ObjectChangeType.Deleted => Icons.Material.Filled.Delete,
            // Sync operations
            ObjectChangeType.Projected => Icons.Material.Filled.AccountTree,
            ObjectChangeType.Joined => Icons.Material.Filled.Link,
            ObjectChangeType.AttributeFlow => Icons.Material.Filled.SwapHoriz,
            ObjectChangeType.Disconnected => Icons.Material.Filled.LinkOff,
            // Export operations
            ObjectChangeType.Provisioned => Icons.Material.Filled.Add,
            ObjectChangeType.Exported => Icons.Material.Filled.Publish,
            ObjectChangeType.Deprovisioned => Icons.Material.Filled.Delete,
            // Other
            ObjectChangeType.NoChange => Icons.Material.Filled.CheckCircle,
            _ => Icons.Material.Filled.Info
        };
    }

    private string GetStatusTitle()
    {
        if (_activityRunProfileExecutionItem?.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
            return GetErrorPhaseTitle();

        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => "Object Added to Staging",
            ObjectChangeType.Updated => "Object Updated",
            ObjectChangeType.Deleted => "Object Deleted from Source",
            // Sync operations
            ObjectChangeType.Projected => "Projected New Metaverse Object",
            ObjectChangeType.Joined => "Joined to Metaverse Object",
            ObjectChangeType.AttributeFlow => "Attributes Flowed",
            ObjectChangeType.Disconnected => "Disconnected from Metaverse",
            // Export operations
            ObjectChangeType.Provisioned => "Object Provisioned",
            ObjectChangeType.Exported => "Object Exported",
            ObjectChangeType.Deprovisioned => "Object Deprovisioned",
            // Other
            ObjectChangeType.NoChange => "No Changes",
            _ => "Synchronisation Complete"
        };
    }

    /// <summary>
    /// Returns an appropriate error title based on the error type (import vs sync vs export phase).
    /// </summary>
    private string GetErrorPhaseTitle()
    {
        return _activityRunProfileExecutionItem?.ErrorType switch
        {
            // Import-phase errors - object rejected before CSO creation
            ActivityRunProfileExecutionItemErrorType.DuplicateObject => "Import Rejected",
            ActivityRunProfileExecutionItemErrorType.MissingExternalIdAttributeValue => "Import Rejected",
            ActivityRunProfileExecutionItemErrorType.DuplicateImportedAttributes => "Import Rejected",
            ActivityRunProfileExecutionItemErrorType.UnsupportedExternalIdAttributeType => "Import Rejected",
            ActivityRunProfileExecutionItemErrorType.CsoCreationFailed => "Import Rejected",

            // Sync-phase errors - CSO exists but sync failed
            ActivityRunProfileExecutionItemErrorType.AmbiguousMatch => "Synchronisation Failed",
            ActivityRunProfileExecutionItemErrorType.CouldNotMatchObjectType => "Synchronisation Failed",
            ActivityRunProfileExecutionItemErrorType.CouldNotJoinDueToExistingJoin => "Synchronisation Failed",
            ActivityRunProfileExecutionItemErrorType.UnexpectedAttribute => "Synchronisation Failed",
            ActivityRunProfileExecutionItemErrorType.UnresolvedReference => "Synchronisation Failed",

            // Export-phase errors
            ActivityRunProfileExecutionItemErrorType.ExportNotConfirmed => "Export Pending",
            ActivityRunProfileExecutionItemErrorType.ExportConfirmationFailed => "Export Failed",

            // Generic/unhandled
            ActivityRunProfileExecutionItemErrorType.UnhandledError => "Operation Failed",
            _ => "Synchronisation Failed"
        };
    }

    /// <summary>
    /// Returns the appropriate label for the object field based on context.
    /// </summary>
    private string GetObjectFieldLabel()
    {
        // If CSO exists, show "Connected System Object"
        if (_activityRunProfileExecutionItem?.ConnectedSystemObject != null)
            return "Connected System Object";

        // If no CSO but has external ID snapshot
        if (!string.IsNullOrEmpty(_activityRunProfileExecutionItem?.ExternalIdSnapshot))
        {
            // If there's an error (rejected), show "External ID (from source data)" for clarity
            if (_activityRunProfileExecutionItem.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
                return "External ID (from source data)";

            // If no error but no CSO, it was deleted
            return "External ID (Deleted)";
        }

        // Fallback
        return "Connected System Object";
    }

    private string GetStatusDescription()
    {
        var objectDesc = _externalIdAttributeValue?.ToStringNoName()
            ?? _activityRunProfileExecutionItem?.ExternalIdSnapshot
            ?? "object";

        if (_activityRunProfileExecutionItem?.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
            return $"An error occurred while synchronising {objectDesc}.";

        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => $"A new object ({objectDesc}) was imported and added to the staging area.",
            ObjectChangeType.Updated => $"The object ({objectDesc}) was updated with new attribute values.",
            ObjectChangeType.Deleted => $"The object ({objectDesc}) was deleted from the source system.",
            // Sync operations
            ObjectChangeType.Projected => "A new metaverse object was created via projection.",
            ObjectChangeType.Joined => $"The object ({objectDesc}) was joined to an existing metaverse object.",
            ObjectChangeType.AttributeFlow => $"Attributes were flowed for ({objectDesc}) between staging and metaverse.",
            ObjectChangeType.Disconnected => $"The object ({objectDesc}) was disconnected from the metaverse.",
            // Export operations
            ObjectChangeType.Provisioned => $"A new object ({objectDesc}) was provisioned in the target system.",
            ObjectChangeType.Exported => $"The object ({objectDesc}) was exported with updated attributes.",
            ObjectChangeType.Deprovisioned => $"The object ({objectDesc}) was deprovisioned from the target system.",
            // Other
            ObjectChangeType.NoChange => $"The object ({objectDesc}) was already up to date.",
            _ => $"Synchronisation completed for {objectDesc}."
        };
    }

    private string GetChangeTypeIcon()
    {
        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => Icons.Material.Filled.Add,
            ObjectChangeType.Updated => Icons.Material.Filled.Edit,
            ObjectChangeType.Deleted => Icons.Material.Filled.Delete,
            // Sync operations
            ObjectChangeType.Projected => Icons.Material.Filled.AccountTree,
            ObjectChangeType.Joined => Icons.Material.Filled.Link,
            ObjectChangeType.AttributeFlow => Icons.Material.Filled.SwapHoriz,
            ObjectChangeType.Disconnected => Icons.Material.Filled.LinkOff,
            // Export operations
            ObjectChangeType.Provisioned => Icons.Material.Filled.Add,
            ObjectChangeType.Exported => Icons.Material.Filled.Publish,
            ObjectChangeType.Deprovisioned => Icons.Material.Filled.Delete,
            // Other
            ObjectChangeType.NoChange => Icons.Material.Filled.CheckCircle,
            _ => Icons.Material.Filled.QuestionMark
        };
    }

    private IEnumerable<FlattenedChange> GetFlattenedChanges()
    {
        if (_activityRunProfileExecutionItem?.ConnectedSystemObjectChange == null)
            return Enumerable.Empty<FlattenedChange>();

        return _activityRunProfileExecutionItem.ConnectedSystemObjectChange.AttributeChanges
            .OrderBy(c => c.Attribute.Name)
            .SelectMany(change => change.ValueChanges.Select(vc => new FlattenedChange(
                change.Attribute.Name,
                vc.ValueChangeType,
                vc.ReferenceValue == null ? vc.ToString() : null,
                vc.ReferenceValue
            )));
    }
}
