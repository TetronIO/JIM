@page "/admin/sync-rules"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.Logic;
@using JIM.Models.Logic.DTOs
@inject JimApplication Jim

<PageTitle>Synchronisation Rules</PageTitle>
<MudText Typo="Typo.h4">Synchronisation Rules</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>
<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
    Synchronisation Rules are used to define the flow of information between JIM and Connected Systems.
</MudText>

@if (!_canCreateSyncRules)
{
    <MudAlert Class="mt-5" Severity="Severity.Warning" Variant="Variant.Outlined">Please create a <MudLink Href="/admin/connected-systems/">Connected
        System</MudLink> first.</MudAlert>
    }

    <MudTable Items="@_syncRuleHeaders" Hover="true" Breakpoint="Breakpoint.Sm" Class="mt-5 mb-5" SortLabel="Sort By"
              Filter="new Func<SyncRuleHeader, bool>(FilterFunc1)" Outlined="true" Elevation="0">
        <ToolBarContent>
            <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Href="/admin/sync-rules/new"
                       Color="Color.Primary" Disabled="@(!_canCreateSyncRules)" DropShadow="false">Create Synchronisation Rule
            </MudButton>
            <MudSpacer />
            <MudTextField @bind-Value="_searchString" Variant="Variant.Outlined" Placeholder="Search" Margin="Margin.Dense"
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                          Class="mt-0"></MudTextField>
        </ToolBarContent>
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.Name)">
                    <MudText Typo="Typo.button">Name</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.Direction)">
                    <MudText Typo="Typo.button">Direction</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.ConnectedSystemName)">
                    <MudText Typo="Typo.button">Connected System</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudText Typo="Typo.button">Object Mapping</MudText>
            </MudTh>
            <MudTh>
                <MudText Typo="Typo.button">Capabilities</MudText>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.Enabled)">
                    <MudText Typo="Typo.button">Status</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.Created)">
                    <MudText Typo="Typo.button">Created</MudText>
                </MudTableSortLabel>
            </MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">
                <MudLink Href="@("/admin/sync-rules/" + context.Id)">@context.Name</MudLink>
            </MudTd>
            <MudTd DataLabel="Direction">
                @if (context.Direction == SyncRuleDirection.Import)
                {
                    <MudChip T="string" Variant="Variant.Text" Color="Color.Info">Inbound</MudChip>
                }
                else
                {
                    <MudChip T="string" Variant="Variant.Text" Color="Color.Warning">Outbound</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Connected System">@context.ConnectedSystemName</MudTd>
            <MudTd DataLabel="Object Mapping">
                <div class="d-flex align-center flex-wrap" style="gap: 2px;">
                    @if (context.Direction == SyncRuleDirection.Import)
                    {
                        @* Inbound: CS -> MV *@
                        <MudChip T="string">
                            <AvatarContent>
                                <MudTooltip Text="Connected System Object Type" Arrow="true" Placement="Placement.Top">
                                    <MudAvatar Color="Color.Tertiary">CS</MudAvatar>
                                </MudTooltip>
                            </AvatarContent>
                            <ChildContent>@context.ConnectedSystemObjectTypeName</ChildContent>
                        </MudChip>
                        <MudIcon Icon="@Icons.Material.Filled.TrendingFlat" Class="mud-text-secondary" />
                        <MudChip T="string">
                            <AvatarContent>
                                <MudTooltip Text="Metaverse Object Type" Arrow="true" Placement="Placement.Top">
                                    <MudAvatar Color="Color.Primary">MV</MudAvatar>
                                </MudTooltip>
                            </AvatarContent>
                            <ChildContent>@context.MetaverseObjectTypeName</ChildContent>
                        </MudChip>
                    }
                    else
                    {
                        @* Outbound: MV -> CS *@
                        <MudChip T="string">
                            <AvatarContent>
                                <MudTooltip Text="Metaverse Object Type" Arrow="true" Placement="Placement.Top">
                                    <MudAvatar Color="Color.Primary">MV</MudAvatar>
                                </MudTooltip>
                            </AvatarContent>
                            <ChildContent>@context.MetaverseObjectTypeName</ChildContent>
                        </MudChip>
                        <MudIcon Icon="@Icons.Material.Filled.TrendingFlat" Class="mud-text-secondary" />
                        <MudChip T="string">
                            <AvatarContent>
                                <MudTooltip Text="Connected System Object Type" Arrow="true" Placement="Placement.Top">
                                    <MudAvatar Color="Color.Tertiary">CS</MudAvatar>
                                </MudTooltip>
                            </AvatarContent>
                            <ChildContent>@context.ConnectedSystemObjectTypeName</ChildContent>
                        </MudChip>
                    }
                </div>
            </MudTd>
            <MudTd DataLabel="Capabilities">
                <div class="d-flex align-center gap-1 flex-wrap">
                    @if (context.Direction == SyncRuleDirection.Import && context.ProjectToMetaverse == true)
                    {
                        <MudTooltip Text="Projects new objects to the Metaverse" Arrow="true" Placement="Placement.Top">
                            <MudChip T="string" Variant="Variant.Text" Color="Color.Info">Projects</MudChip>
                        </MudTooltip>
                    }
                    @if (context.Direction == SyncRuleDirection.Export && context.ProvisionToConnectedSystem == true)
                    {
                        <MudTooltip Text="Provisions new objects to the Connected System" Arrow="true"
                                    Placement="Placement.Top">
                            <MudChip T="string" Variant="Variant.Text" Color="Color.Warning">Provisions</MudChip>
                        </MudTooltip>
                    }
                    @if (!((context.Direction == SyncRuleDirection.Import && context.ProjectToMetaverse == true) ||
                                                                                                                           (context.Direction == SyncRuleDirection.Export && context.ProvisionToConnectedSystem == true)))
                    {
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">-</MudText>
                    }
                </div>
            </MudTd>
            <MudTd DataLabel="Status">
                @if (context.Enabled)
                {
                    <MudChip T="string" Variant="Variant.Text" Color="Color.Success">Enabled</MudChip>
                }
                else
                {
                    <MudChip T="string" Variant="Variant.Text" Color="Color.Default">Disabled</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Created">
                <MudTooltip Text="@context.Created.ToLocalTime().ToFriendlyDate()" Arrow="true" Placement="Placement.Top">
                    @context.Created.ToLocalTime().ToRelativeTime()
                </MudTooltip>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            There are no synchronisation rules
        </NoRecordsContent>
    </MudTable>

@code {
    private IList<SyncRuleHeader>? _syncRuleHeaders;
    private string _searchString = "";
    private bool _canCreateSyncRules;

    private readonly List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new("Home", href: "/", icon: Icons.Material.Filled.Home),
        new("Synchronisation Rules", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        _canCreateSyncRules = Jim.ConnectedSystems.GetConnectedSystemCount() > 0;
        _syncRuleHeaders = await Jim.ConnectedSystems.GetSyncRuleHeadersAsync();
    }

    private bool FilterFunc1(SyncRuleHeader element) => FilterFunc(element, _searchString);

    private static bool FilterFunc(SyncRuleHeader element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        if (element.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    }
}
