@using JIM.Application
@using JIM.Models.Activities
@using JIM.Models.Staging
@using JIM.Models.Utility
@using JIM.Utilities
@using JIM.Web.Services
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject IUserPreferenceService PreferenceService
@implements IDisposable

@if (_preferencesLoaded)
{
    <MudPaper Elevation="0" Outlined="true" Class="pa-4 mb-4">
        <MudText Typo="Typo.h6" Class="mb-3">Execution History</MudText>

        @* Filter Controls *@
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" Label="Connected System" Variant="Variant.Outlined"
                           Dense="true" Clearable="true" MultiSelection="true"
                           SelectedValues="_filterConnectedSystems"
                           SelectedValuesChanged="OnConnectedSystemFilterChanged"
                           MultiSelectionTextFunc="@(new Func<List<string>, string>(GetMultiSelectText))">
                    @if (_filterOptions != null)
                    {
                        @foreach (var cs in _filterOptions.ConnectedSystems)
                        {
                            <MudSelectItem T="string" Value="@cs">@cs</MudSelectItem>
                        }
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" Label="Run Profile" Variant="Variant.Outlined"
                           Dense="true" Clearable="true" MultiSelection="true"
                           SelectedValues="_filterRunProfiles"
                           SelectedValuesChanged="OnRunProfileFilterChanged"
                           MultiSelectionTextFunc="@(new Func<List<string>, string>(GetMultiSelectText))">
                    @if (_filterOptions != null)
                    {
                        @foreach (var rp in _filterOptions.RunProfiles)
                        {
                            <MudSelectItem T="string" Value="@rp">@rp</MudSelectItem>
                        }
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="ActivityStatus" Label="Status" Variant="Variant.Outlined"
                           Dense="true" Clearable="true" MultiSelection="true"
                           SelectedValues="_filterStatuses"
                           SelectedValuesChanged="OnStatusFilterChanged"
                           MultiSelectionTextFunc="@(new Func<List<string>, string>(GetMultiSelectText))">
                    <MudSelectItem T="ActivityStatus" Value="ActivityStatus.InProgress">In Progress</MudSelectItem>
                    <MudSelectItem T="ActivityStatus" Value="ActivityStatus.Complete">Complete</MudSelectItem>
                    <MudSelectItem T="ActivityStatus" Value="ActivityStatus.CompleteWithWarning">Complete With Warning</MudSelectItem>
                    <MudSelectItem T="ActivityStatus" Value="ActivityStatus.CompleteWithError">Complete With Error</MudSelectItem>
                    <MudSelectItem T="ActivityStatus" Value="ActivityStatus.FailedWithError">Failed With Error</MudSelectItem>
                    <MudSelectItem T="ActivityStatus" Value="ActivityStatus.Cancelled">Cancelled</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField T="string" @bind-Value="_filterInitiatedBy" Label="Initiated By"
                              Variant="Variant.Outlined" Clearable="true" Placeholder="Search by name..."
                              Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true" DebounceInterval="500"
                              OnDebounceIntervalElapsed="OnInitiatedByFilterChanged" />
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudTable @ref="_table" T="Activity" ServerData="ServerReload" @bind-CurrentPage="_currentPage"
              RowsPerPage="@_rowsPerPage" RowsPerPageChanged="OnRowsPerPageChanged"
              Hover="true" Dense="true" Breakpoint="Breakpoint.Sm"
              Outlined="true" Elevation="0" OnRowClick="HandleRowClick" RowClass="cursor-pointer">
        <HeaderContent>
            <MudTh>
                <MudText Typo="Typo.button">Connected System</MudText>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="target" T="Activity">
                    <MudText Typo="Typo.button">Run Profile</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudText Typo="Typo.button">Stats</MudText>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="initiatedby" T="Activity">
                    <MudText Typo="Typo.button">Initiated By</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="status" T="Activity">
                    <MudText Typo="Typo.button">Status</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="created" T="Activity" InitialDirection="SortDirection.Descending">
                    <MudText Typo="Typo.button">Executed</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="executiontime" T="Activity">
                    <MudText Typo="Typo.button">Duration</MudText>
                </MudTableSortLabel>
            </MudTh>
        </HeaderContent>
        <RowTemplate Context="context">
            <MudTd DataLabel="Connected System">
                @if (!string.IsNullOrEmpty(context.TargetContext))
                {
                    @context.TargetContext
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-disabled">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Run Profile">
                @if (!string.IsNullOrEmpty(context.TargetName))
                {
                    @context.TargetName
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-disabled">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Stats">
                @if (context.Status != ActivityStatus.InProgress)
                {
                    @if (HasAnyStats(context))
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            @{ var runType = GetEffectiveRunType(context.ConnectedSystemRunType, context.TargetName); }
                            @if (runType == "Import")
                            {
                                @if (context.TotalAdded > 0)
                                {
                                    <MudTooltip Text="Added" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Success" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Add" Class="px-2">
                                            @context.TotalAdded.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalUpdated > 0)
                                {
                                    <MudTooltip Text="Updated" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Info" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Sync" Class="px-2">
                                            @context.TotalUpdated.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalDeleted > 0)
                                {
                                    <MudTooltip Text="Deletions Detected" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Error" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Delete" Class="px-2">
                                            @context.TotalDeleted.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                            }
                            else if (runType == "Sync")
                            {
                                @if (context.TotalProjected > 0)
                                {
                                    <MudTooltip Text="Projected" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Primary" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Commit" Class="px-2">
                                            @context.TotalProjected.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalJoined > 0)
                                {
                                    <MudTooltip Text="Joined" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Secondary" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Link" Class="px-2">
                                            @context.TotalJoined.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalAttributeFlows > 0)
                                {
                                    <MudTooltip Text="Attribute Flows" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Info" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.SwapHoriz" Class="px-2">
                                            @context.TotalAttributeFlows.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalDisconnected > 0)
                                {
                                    <MudTooltip Text="Disconnected" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Warning" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.LinkOff" Class="px-2">
                                            @context.TotalDisconnected.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalDeleted > 0)
                                {
                                    <MudTooltip Text="Deletions Processed" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Error" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Delete" Class="px-2">
                                            @context.TotalDeleted.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalDriftCorrections > 0)
                                {
                                    <MudTooltip Text="Drift Corrections" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Warning" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Shield" Class="px-2">
                                            @context.TotalDriftCorrections.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalPendingExports > 0)
                                {
                                    <MudTooltip Text="Pending Exports" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Info" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Outbox" Class="px-2">
                                            @context.TotalPendingExports.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                            }
                            else if (runType == "Export")
                            {
                                @if (context.TotalProvisioned > 0)
                                {
                                    <MudTooltip Text="Provisioned" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Success" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Add" Class="px-2">
                                            @context.TotalProvisioned.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalExported > 0)
                                {
                                    <MudTooltip Text="Exported" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Info" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Sync" Class="px-2">
                                            @context.TotalExported.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                                @if (context.TotalDeprovisioned > 0)
                                {
                                    <MudTooltip Text="Deprovisioned" Arrow="true" Placement="Placement.Top">
                                        <MudChip T="string" Color="Color.Error" Variant="Variant.Text"
                                                 Icon="@Icons.Material.Filled.Delete" Class="px-2">
                                            @context.TotalDeprovisioned.ToString("N0")
                                        </MudChip>
                                    </MudTooltip>
                                }
                            }
                            @if (context.TotalErrors > 0)
                            {
                                <MudTooltip Text="Errors" Arrow="true" Placement="Placement.Top">
                                    <MudChip T="string" Color="Color.Error" Variant="Variant.Filled"
                                             Icon="@Icons.Material.Filled.Error" Class="px-2">
                                        @context.TotalErrors.ToString("N0")
                                    </MudChip>
                                </MudTooltip>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudTooltip Text="No changes" Arrow="true" Placement="Placement.Top">
                            <MudChip T="string" Color="Color.Default" Variant="Variant.Text"
                                     Icon="@Icons.Material.Outlined.CheckCircle" Class="px-2">
                                0
                            </MudChip>
                        </MudTooltip>
                    }
                }
                else
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Style="width: 80px;" />
                }
            </MudTd>
            <MudTd DataLabel="Initiated By">
                @if (context.InitiatedByType == ActivityInitiatorType.User && context.InitiatedById != null)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-1" Style="vertical-align: middle;" />
                    <span>@context.InitiatedByName</span>
                }
                else if (context.InitiatedByType == ActivityInitiatorType.ApiKey)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Key" Class="mr-1" Style="vertical-align: middle;" />
                    <span>@context.InitiatedByName</span>
                }
                else if (context.InitiatedByType == ActivityInitiatorType.System)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Class="mr-1" Style="vertical-align: middle;" />
                    <span>@(context.InitiatedByName ?? "Scheduler")</span>
                }
                else if (!string.IsNullOrEmpty(context.InitiatedByName))
                {
                    <span>@context.InitiatedByName</span>
                }
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Variant="Variant.Text"
                         Color="Helpers.GetActivityMudBlazorColorForStatus(context.Status)">
                    @context.Status.ToString().SplitOnCapitalLetters()
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Executed">
                <MudTooltip Text="@context.Executed.ToLocalTime().ToFriendlyDate()" Arrow="true" Placement="Placement.Top">
                    @context.Executed.ToLocalTime().ToRelativeTime()
                </MudTooltip>
            </MudTd>
            <MudTd DataLabel="Duration">
                @if (context.ExecutionTime.HasValue)
                {
                    @context.ExecutionTime.Value.ToCasualString()
                }
                else if (context.Status == ActivityStatus.InProgress)
                {
                    <MudText Typo="Typo.body2" Class="mud-text-disabled">Running...</MudText>
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-disabled">-</MudText>
                }
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            No execution history to display.
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@* Activity Detail Panel with Overlay *@
<MudOverlay @bind-Visible="_panelOpen" DarkBackground="true" AutoClose="true" ZIndex="1250" />
<div class="jim-activity-panel @(_panelOpen ? "jim-activity-panel-open" : "")">
    @if (_selectedActivity != null)
    {
        <div class="d-flex flex-column gap-4 pa-4" style="height: 100%; overflow-y: auto;">
            @* Header with close button *@
            <div class="d-flex justify-space-between align-center">
                <MudText Typo="Typo.h6">Execution Details</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@(() => _panelOpen = false)" />
            </div>

            @* Status *@
            <div class="d-flex gap-4 align-center flex-wrap">
                <MudChip T="string" Size="Size.Medium" Variant="Variant.Filled"
                         Color="Helpers.GetActivityMudBlazorColorForStatus(_selectedActivity.Status)">
                    @_selectedActivity.Status.ToString().SplitOnCapitalLetters()
                </MudChip>
            </div>

            @* Target Information *@
            <MudPaper Elevation="0" Class="pa-3" Outlined="true">
                <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Primary">Target</MudText>
                @if (!string.IsNullOrEmpty(_selectedActivity.TargetContext))
                {
                    <MudText Typo="Typo.body1"><strong>@_selectedActivity.TargetContext</strong> â†’ @_selectedActivity.TargetName</MudText>
                }
                else
                {
                    <MudText Typo="Typo.body1">@_selectedActivity.TargetName</MudText>
                }
                <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                    @_selectedActivity.TargetType.ToString().SplitOnCapitalLetters()
                </MudText>
            </MudPaper>

            @* Statistics *@
            @if (_selectedActivity.Status != ActivityStatus.InProgress)
            {
                <MudPaper Elevation="0" Class="pa-3" Outlined="true">
                    <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Primary">Statistics</MudText>
                    @{ var sidebarRunType = GetEffectiveRunType(_selectedActivity.ConnectedSystemRunType, _selectedActivity.TargetName); }
                    <MudSimpleTable Dense="true" Hover="true">
                        <tbody>
                            @if (sidebarRunType == "Import")
                            {
                                <tr>
                                    <td><MudText Typo="Typo.body2">Adds</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Success">@_selectedActivity.TotalAdded.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Updates</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Info">@_selectedActivity.TotalUpdated.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Deletions Detected</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Error">@_selectedActivity.TotalDeleted.ToString("N0")</MudText></td>
                                </tr>
                            }
                            else if (sidebarRunType == "Sync")
                            {
                                <tr>
                                    <td><MudText Typo="Typo.body2">Projections</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Primary">@_selectedActivity.TotalProjected.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Joins</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Secondary">@_selectedActivity.TotalJoined.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Attribute Flows</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Info">@_selectedActivity.TotalAttributeFlows.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Disconnects</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Warning">@_selectedActivity.TotalDisconnected.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Deletions Processed</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Error">@_selectedActivity.TotalDeleted.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Drift Corrections</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Warning">@_selectedActivity.TotalDriftCorrections.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Pending Exports</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Info">@_selectedActivity.TotalPendingExports.ToString("N0")</MudText></td>
                                </tr>
                            }
                            else if (sidebarRunType == "Export")
                            {
                                <tr>
                                    <td><MudText Typo="Typo.body2">Provisions</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Success">@_selectedActivity.TotalProvisioned.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Exports</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Info">@_selectedActivity.TotalExported.ToString("N0")</MudText></td>
                                </tr>
                                <tr>
                                    <td><MudText Typo="Typo.body2">Deprovisions</MudText></td>
                                    <td style="text-align: right;"><MudText Typo="Typo.body2" Color="Color.Error">@_selectedActivity.TotalDeprovisioned.ToString("N0")</MudText></td>
                                </tr>
                            }
                            <tr>
                                <td><MudText Typo="Typo.body2">Errors</MudText></td>
                                <td style="text-align: right;"><MudText Typo="Typo.body2" Color="@(_selectedActivity.TotalErrors > 0 ? Color.Error : Color.Default)">@_selectedActivity.TotalErrors.ToString("N0")</MudText></td>
                            </tr>
                        </tbody>
                    </MudSimpleTable>
                </MudPaper>
            }

            @* Timing *@
            <MudPaper Elevation="0" Class="pa-3" Outlined="true">
                <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Primary">Timing</MudText>
                <MudSimpleTable Dense="true" Hover="true">
                    <tbody>
                        <tr>
                            <td><MudText Typo="Typo.body2">Created</MudText></td>
                            <td><MudText Typo="Typo.body2">@_selectedActivity.Created.ToLocalTime().ToFriendlyDate()</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2">Executed</MudText></td>
                            <td><MudText Typo="Typo.body2">@_selectedActivity.Executed.ToLocalTime().ToFriendlyDate()</MudText></td>
                        </tr>
                        @if (_selectedActivity.ExecutionTime.HasValue)
                        {
                            <tr>
                                <td><MudText Typo="Typo.body2">Duration</MudText></td>
                                <td><MudText Typo="Typo.body2">@_selectedActivity.ExecutionTime.Value.ToCasualString()</MudText></td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            </MudPaper>

            @* Initiator *@
            <MudPaper Elevation="0" Class="pa-3" Outlined="true">
                <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Primary">Initiated By</MudText>
                <div class="d-flex align-center gap-2">
                    @if (_selectedActivity.InitiatedByType == ActivityInitiatorType.User)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Person" />
                    }
                    else if (_selectedActivity.InitiatedByType == ActivityInitiatorType.ApiKey)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Key" />
                    }
                    else if (_selectedActivity.InitiatedByType == ActivityInitiatorType.System)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" />
                    }
                    <MudText Typo="Typo.body1">@(_selectedActivity.InitiatedByName ?? "Unknown")</MudText>
                </div>
            </MudPaper>

            @* Error Details *@
            @if (!string.IsNullOrEmpty(_selectedActivity.ErrorMessage))
            {
                <MudExpansionPanels Elevation="0">
                    <MudExpansionPanel Expanded="true">
                        <TitleContent>
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" />
                                <MudText Color="Color.Error">Error Details</MudText>
                            </div>
                        </TitleContent>
                        <ChildContent>
                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap; word-break: break-word;">
                                @_selectedActivity.ErrorMessage
                            </MudText>
                            @if (!string.IsNullOrEmpty(_selectedActivity.ErrorStackTrace))
                            {
                                <MudDivider Class="my-2" />
                                <pre class="jim-text-code" style="white-space: pre-wrap; word-break: break-word; font-size: 0.75rem; margin: 0; padding: 12px; background: var(--mud-palette-background); border-radius: 4px; overflow-x: auto;">@_selectedActivity.ErrorStackTrace</pre>
                            }
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }

            @* View Full Details Link *@
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                       Class="flex-shrink-0"
                       EndIcon="@Icons.Material.Filled.ArrowForward"
                       Href="@($"/activity/{_selectedActivity.Id}")">
                View Full Details
            </MudButton>
        </div>
    }
</div>

@code {
    private MudTable<Activity>? _table;
    private int _currentPage;
    private int _rowsPerPage = 10;
    private bool _preferencesLoaded;
    private bool _panelOpen;
    private Activity? _selectedActivity;
    private readonly CancellationTokenSource _pollingCancellationTokenSource = new();

    // Snapshot of last-displayed data for change detection during polling
    private string? _lastDataFingerprint;

    // Filter state
    private ActivityFilterOptions? _filterOptions;
    private IEnumerable<string> _filterConnectedSystems = [];
    private IEnumerable<string> _filterRunProfiles = [];
    private IEnumerable<ActivityStatus> _filterStatuses = [];
    private string? _filterInitiatedBy;

    protected override async Task OnInitializedAsync()
    {
        // Load filter options (distinct connected systems and run profiles)
        _filterOptions = await Jim.Activities.GetWorkerTaskActivityFilterOptionsAsync();

        // Setup polling for auto-refresh, only reloading when data has actually changed
        var token = _pollingCancellationTokenSource.Token;
        _ = Task.Run(async () =>
        {
            while (!token.IsCancellationRequested)
            {
                try
                {
                    await Task.Delay(TimeSpan.FromSeconds(5), token);

                    // Only auto-refresh when on page 1 and panel is closed to avoid jarring UX
                    if (_table == null || _currentPage != 0 || _panelOpen)
                        continue;

                    // Fetch current data and compare with what's displayed
                    var connectedSystems = _filterConnectedSystems.Any() ? _filterConnectedSystems : null;
                    var runProfiles = _filterRunProfiles.Any() ? _filterRunProfiles : null;
                    var statuses = _filterStatuses.Any() ? _filterStatuses : null;
                    var initiatedBy = string.IsNullOrWhiteSpace(_filterInitiatedBy) ? null : _filterInitiatedBy;

                    var result = await Jim.Activities.GetWorkerTaskActivitiesAsync(
                        1, _rowsPerPage, connectedSystems, runProfiles, statuses, initiatedBy, "created", true);

                    var fingerprint = BuildFingerprint(result.Results);
                    if (fingerprint != _lastDataFingerprint)
                    {
                        await InvokeAsync(() => _table!.ReloadServerData());
                    }
                }
                catch (TaskCanceledException)
                {
                    break;
                }
                catch
                {
                    // Ignore errors during polling, will retry on next interval
                }
            }
        }, token);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_preferencesLoaded)
        {
            try
            {
                var preferredSize = await PreferenceService.GetRowsPerPageAsync();
                _rowsPerPage = preferredSize;
                _preferencesLoaded = true;
                StateHasChanged();
            }
            catch
            {
                // JS interop not yet available, will retry on next render
            }
        }
    }

    void IDisposable.Dispose()
    {
        _pollingCancellationTokenSource.Cancel();
    }

    private async Task OnRowsPerPageChanged(int newSize)
    {
        _rowsPerPage = newSize;
        await PreferenceService.SetRowsPerPageAsync(newSize);
    }

    private async Task<TableData<Activity>> ServerReload(TableState state, CancellationToken token)
    {
        var page = state.Page + 1;
        var sortDescending = state.SortDirection == SortDirection.Descending;

        // Get activities filtered for worker tasks
        var connectedSystems = _filterConnectedSystems.Any() ? _filterConnectedSystems : null;
        var runProfiles = _filterRunProfiles.Any() ? _filterRunProfiles : null;
        var statuses = _filterStatuses.Any() ? _filterStatuses : null;
        var initiatedBy = string.IsNullOrWhiteSpace(_filterInitiatedBy) ? null : _filterInitiatedBy;

        var result = await Jim.Activities.GetWorkerTaskActivitiesAsync(
            page,
            state.PageSize,
            connectedSystems,
            runProfiles,
            statuses,
            initiatedBy,
            state.SortLabel,
            sortDescending);

        _lastDataFingerprint = BuildFingerprint(result.Results);

        return new TableData<Activity>
        {
            TotalItems = result.TotalResults,
            Items = result.Results
        };
    }

    /// <summary>
    /// Builds a lightweight fingerprint of the current result set for change detection.
    /// Captures identity, status, and a representative subset of granular stats so polling
    /// only triggers a reload when data actually changed.
    /// </summary>
    private static string BuildFingerprint(IEnumerable<Activity> activities)
    {
        return string.Join("|", activities.Select(a =>
            $"{a.Id}:{a.Status}:{a.TotalAdded},{a.TotalUpdated},{a.TotalDeleted},{a.TotalProjected},{a.TotalJoined},{a.TotalAttributeFlows},{a.TotalDisconnected},{a.TotalDriftCorrections},{a.TotalProvisioned},{a.TotalExported},{a.TotalDeprovisioned},{a.TotalErrors}"));
    }

    private void OnConnectedSystemFilterChanged(IEnumerable<string> values)
    {
        _filterConnectedSystems = values;
        _table?.ReloadServerData();
    }

    private void OnRunProfileFilterChanged(IEnumerable<string> values)
    {
        _filterRunProfiles = values;
        _table?.ReloadServerData();
    }

    private void OnStatusFilterChanged(IEnumerable<ActivityStatus> values)
    {
        _filterStatuses = values;
        _table?.ReloadServerData();
    }

    private void OnInitiatedByFilterChanged(string text)
    {
        _filterInitiatedBy = text;
        _table?.ReloadServerData();
    }

    private static string GetMultiSelectText(List<string> selectedValues)
    {
        return selectedValues.Count switch
        {
            0 => string.Empty,
            1 => selectedValues[0],
            _ => $"{selectedValues.Count} selected"
        };
    }

    private void HandleRowClick(TableRowClickEventArgs<Activity> args)
    {
        if (args.Item == null)
            return;

        _selectedActivity = args.Item;
        _panelOpen = true;
    }

    /// <summary>
    /// Returns true if any of the granular activity stats fields are greater than zero.
    /// </summary>
    private static bool HasAnyStats(Activity activity)
    {
        return activity.TotalAdded > 0
            || activity.TotalUpdated > 0
            || activity.TotalDeleted > 0
            || activity.TotalProjected > 0
            || activity.TotalJoined > 0
            || activity.TotalAttributeFlows > 0
            || activity.TotalDisconnected > 0
            || activity.TotalDisconnectedOutOfScope > 0
            || activity.TotalOutOfScopeRetainJoin > 0
            || activity.TotalDriftCorrections > 0
            || activity.TotalProvisioned > 0
            || activity.TotalExported > 0
            || activity.TotalDeprovisioned > 0
            || activity.TotalCreated > 0
            || activity.TotalPendingExports > 0
            || activity.TotalErrors > 0;
    }

    private static string GetEffectiveRunType(ConnectedSystemRunType? runType, string? targetName)
    {
        if (runType is ConnectedSystemRunType.FullImport or ConnectedSystemRunType.DeltaImport)
            return "Import";
        if (runType is ConnectedSystemRunType.FullSynchronisation or ConnectedSystemRunType.DeltaSynchronisation)
            return "Sync";
        if (runType is ConnectedSystemRunType.Export)
            return "Export";

        if (!string.IsNullOrEmpty(targetName))
        {
            if (targetName.Contains("Import", StringComparison.OrdinalIgnoreCase))
                return "Import";
            if (targetName.Contains("Sync", StringComparison.OrdinalIgnoreCase))
                return "Sync";
            if (targetName.Contains("Export", StringComparison.OrdinalIgnoreCase))
                return "Export";
        }

        return "Unknown";
    }
}
