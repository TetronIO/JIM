@page "/admin/connected-systems/{CsId:int}/objects/{CsoId}"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.Staging
@using JIM.Models.Staging.DTOs
@using JIM.Models.Transactional
@using JIM.Utilities
@inject JimApplication Jim
@inject NavigationManager NavManager

<PageTitle>Connected System Object: @ConnectedSystemObject?.Id</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-secondary-text">Connected System Object:</span> @ConnectedSystemObject?.Id</MudText>
<MudBreadcrumbs Items="Breadcrumbs" Class="ps-0"></MudBreadcrumbs>

<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
    A view of this object as staged within JIM. This includes any attribute values imported from the connected system, as well as any pending export changes awaiting export.
</MudText>

@if (ConnectedSystemHeader != null && ConnectedSystemObject != null)
{
    <MudPaper Class="pa-5 mt-5 mb-5" Outlined="true">
        @if (ExternalIdAttributeValue != null)
        {
            <MudTooltip Text="The immutable unique identifier for the object in the Connected System. Typically generated by the external system" Arrow="true" Placement="Placement.Right">
                <div class="mb-2">
                    <MudText Typo="Typo.subtitle2">External Id (<span class="mud-secondary-text">@ExternalIdAttributeValue.Attribute.Name</span>):</MudText>
                </div>
            </MudTooltip>
            <MudField Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AssignmentInd" Variant="Variant.Outlined">@ExternalIdAttributeValue.ToStringNoName()</MudField>
        }

        @if (SecondaryExternalIdAttributeValue != null)
        {
            <br />
            <MudTooltip Text="Some external systems, such as LDAP directories use an additional attribute to identify objects when referencing them" Arrow="true" Placement="Placement.Right">
                <div class="mb-2">
                    <MudText Typo="Typo.subtitle2">Secondary External Id (<span class="mud-secondary-text">@SecondaryExternalIdAttributeValue.Attribute.Name</span>):</MudText>
                </div>
            </MudTooltip>
            <MudField Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.AssignmentInd" Variant="Variant.Outlined">@SecondaryExternalIdAttributeValue.ToStringNoName()</MudField>
        }
    </MudPaper>

    @if (PendingExport != null && PendingExport.AttributeValueChanges.Count > 0)
    {
        <MudPaper Class="pa-5 mt-5 mb-5 jim-paper-info" Outlined="true">
            <MudText Typo="Typo.h6">Pending Exports</MudText>
            <MudText Typo="Typo.subtitle1" Class="my-3">
                The following attribute changes are pending for this connected system. These may be awaiting export, or have already been exported
                and are awaiting confirmation via a subsequent import. Once confirmed, these changes will be reflected in the CSO attribute values below.
            </MudText>
            <MudTable Items="@PendingExport.AttributeValueChanges" Hover="true" Dense="true" Outlined="true" Elevation="0">
                <HeaderContent>
                    <MudTh>Attribute</MudTh>
                    <MudTh>Change Type</MudTh>
                    <MudTh>Value</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Export Attempts</MudTh>
                    <MudTh>Last Exported</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Attribute">@(context.Attribute?.Name ?? $"Attribute {context.AttributeId}")</MudTd>
                    <MudTd DataLabel="Change Type">
                        <MudChip T="string" Variant="Variant.Text" Color="GetAttributeChangeTypeColor(context.ChangeType)" Size="Size.Small">
                            @context.ChangeType
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Value">@GetAttributeValue(context)</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Variant="Variant.Text" Color="GetAttributeChangeStatusColor(context.Status)" Size="Size.Small">
                            @context.Status.ToString().SplitOnCapitalLetters()
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Export Attempts">@context.ExportAttemptCount</MudTd>
                    <MudTd DataLabel="Last Exported">@(context.LastExportedAt?.ToFriendlyDate() ?? "-")</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }

    <style>
        .mud-table-cell-custom-group {
            font-weight: 500;
        }

        .mud-table-cell-custom-group-footer {
            padding-bottom: 50px;
            text-align: right;
        }
    </style>

    <MudPaper Class="pa-5" Outlined="true">
        <MudTable Hover="true" Breakpoint="Breakpoint.Sm" Elevation="0"
            Items="@(ConnectedSystemObject.AttributeValues.OrderBy(q => q.Attribute.Name))"
            GroupBy="@_groupDefinition"
            GroupHeaderStyle="background-color:var(--mud-palette-background-grey)"
            GroupFooterClass="mb-4"
            Dense="true">
            <ColGroup>
                <col style="width: 60px;" />
                <col />
                <col />
            </ColGroup>
            <HeaderContent>
                <MudTh>Attribute Value Type</MudTh>
                <MudTh>Attribute Value</MudTh>
            </HeaderContent>
            <GroupHeaderTemplate>
                <MudTh Class="mud-table-cell-custom-group" colspan="5">@(context.GroupName): <span class="mud-secondary-text">@(context.Key)</span></MudTh>
            </GroupHeaderTemplate>
            <RowTemplate>
                <MudTd DataLabel="Type">@context.Attribute.Type</MudTd>
                <MudTd DataLabel="Value">
                    @if (context.ReferenceValue != null)
                    {
                        <MudChip T="string" Color="Color.Default" Size="Size.Small">@context.ReferenceValue.Type.Name</MudChip>
                        <text> </text>
                        <MudLink Href="@Utilities.GetConnectedSystemObjectHref(context.ReferenceValue)">@context.ReferenceValue.DisplayNameOrId</MudLink>

                        if (context.ReferenceValue.SecondaryExternalIdAttributeValue != null)
                        {
                            <span class="mud-text-secondary"> (@context.ReferenceValue.SecondaryExternalIdAttributeValue.ToString())</span>
                        }
                    }
                    else if (context.UnresolvedReferenceValue != null)
                    {
                        <MudText>Unresolved reference: <span Style="@($"color:{Colors.Gray.Darken2};")">@context.ToString()</span></MudText>
                    }
                    else
                    {
                        @context.ToStringNoName()
                    }
                </MudTd>
            </RowTemplate>
            <GroupFooterTemplate>
                <MudTh Class="mud-table-cell-custom-group mud-table-cell-custom-group-footer" colspan="5">Total Values: @context.Items.Count()</MudTh>
            </GroupFooterTemplate>
        </MudTable>
    </MudPaper>
}

@code {
    /// <summary>
    /// Connected System ID.
    /// </summary>
    [Parameter]
    public int CsId { get; set; }

    /// <summary>
    /// Connected System Object ID.
    /// </summary>
    [Parameter]
    public string CsoId { get; set; } = null!;

    private ConnectedSystemHeader? ConnectedSystemHeader { get; set; }

    private ConnectedSystemObject? ConnectedSystemObject { get; set; }

    private ConnectedSystemObjectAttributeValue? ExternalIdAttributeValue { get; set; }

    private ConnectedSystemObjectAttributeValue? SecondaryExternalIdAttributeValue { get; set; }

    private PendingExport? PendingExport { get; set; }

    private List<BreadcrumbItem> Breadcrumbs { get; set; } = null!;

    protected override async Task OnParametersSetAsync()
    {
        ConnectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(CsId);
        if (ConnectedSystemHeader == null)
        {
            // ConnectedSystem not found, redirect to the Connected Systems index page
            NavManager.NavigateTo($"/admin/connected-systems/");
            return;
        }

        var csoIdValid = Guid.TryParse(CsoId, out var connectedSystemObjectId);
        if (!csoIdValid)
        {
            NavManager.NavigateTo(Utilities.GetConnectedSystemObjectsHref(CsId));
            return;
        }

        ConnectedSystemObject = await Jim.ConnectedSystems.GetConnectedSystemObjectAsync(CsId, connectedSystemObjectId);
        if (ConnectedSystemObject == null)
        {
            // ConnectedSystemObject not found, redirect to Connected System Objects index page
            NavManager.NavigateTo(Utilities.GetConnectedSystemObjectsHref(CsId));
            return;
        }

        Breadcrumbs = new List<BreadcrumbItem>
        {
            new("Home", href: "/", icon: Icons.Material.Filled.Home),
            new("Connected Systems", href: "/admin/connected-systems/"),
            new(ConnectedSystemHeader.Name, href: Utilities.GetConnectedSystemHref(ConnectedSystemHeader)),
            new("Objects", href: Utilities.GetConnectedSystemObjectsHref(ConnectedSystemHeader)),
            new(CsoId.ToString(), href: null, disabled: true)
        };

        ExternalIdAttributeValue = ConnectedSystemObject.ExternalIdAttributeValue;
        SecondaryExternalIdAttributeValue = ConnectedSystemObject.SecondaryExternalIdAttributeValue;

        // Fetch pending export for this CSO
        PendingExport = await Jim.ConnectedSystems.GetPendingExportForObjectAsync(connectedSystemObjectId);
    }

    private readonly TableGroupDefinition<ConnectedSystemObjectAttributeValue> _groupDefinition = new()
    {
        GroupName = "Group",
        Indentation = false,
        Expandable = true,
        Selector = (e) => e.Attribute.Name
    };

    private static string GetAttributeValue(PendingExportAttributeValueChange change)
    {
        if (!string.IsNullOrEmpty(change.UnresolvedReferenceValue))
            return $"[Unresolved Reference: {change.UnresolvedReferenceValue}]";

        if (change.StringValue != null)
            return change.StringValue;

        if (change.DateTimeValue.HasValue)
            return change.DateTimeValue.Value.ToFriendlyDate();

        if (change.IntValue.HasValue)
            return change.IntValue.Value.ToString();

        if (change.ByteValue != null)
            return $"[Binary data: {change.ByteValue.Length} bytes]";

        return "[null]";
    }

    private static MudBlazor.Color GetAttributeChangeTypeColor(PendingExportAttributeChangeType changeType)
    {
        return changeType switch
        {
            PendingExportAttributeChangeType.Add => MudBlazor.Color.Primary,
            PendingExportAttributeChangeType.Update => MudBlazor.Color.Info,
            PendingExportAttributeChangeType.Remove => MudBlazor.Color.Warning,
            PendingExportAttributeChangeType.RemoveAll => MudBlazor.Color.Error,
            _ => MudBlazor.Color.Default,
        };
    }

    private static MudBlazor.Color GetAttributeChangeStatusColor(PendingExportAttributeChangeStatus status)
    {
        return status switch
        {
            PendingExportAttributeChangeStatus.Pending => MudBlazor.Color.Default,
            PendingExportAttributeChangeStatus.ExportedPendingConfirmation => MudBlazor.Color.Info,
            PendingExportAttributeChangeStatus.ExportedNotConfirmed => MudBlazor.Color.Warning,
            PendingExportAttributeChangeStatus.Failed => MudBlazor.Color.Error,
            _ => MudBlazor.Color.Default,
        };
    }
}
