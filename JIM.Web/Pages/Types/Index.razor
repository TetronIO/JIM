@page "/t/{TypeNameUrlParam}"
@page "/t/{TypeNameUrlParam}/s/{PredefinedSearchUri}"
@attribute [Authorize(Roles = "Users")]
@using JIM.Application
@using JIM.Models.Core
@using JIM.Models.Core.DTOs
@using JIM.Models.Search
@using JIM.Models.Utility
@using JIM.Utilities
@inject JimApplication Jim
@inject NavigationManager NavManager

<PageTitle>@PageTitle</PageTitle>
<MudText Typo="Typo.h4">@PageTitle</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>
<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">Search, or browse for @ObjectTypeName</MudText>

@if (_isInitialised && PredefinedSearch != null)
{
    <MudTable @ref="_table" T="MetaverseObjectHeader" ServerData="ServerReload" Hover="true"
        Breakpoint="Breakpoint.Sm" Class="mt-5" Outlined="true" Elevation="0" OnRowClick="HandleRowClick"
        RowClass="cursor-pointer" Loading="@_loading" LoadingProgressColor="Color.Primary">
        <ToolBarContent>
            <MudSpacer />
            <MudTextField T="string" ValueChanged="@(s => OnSearch(s))" Placeholder="Search..."
                Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                Class="mt-0" />
        </ToolBarContent>
        <HeaderContent>
            @foreach (var psa in PredefinedSearch.Attributes)
            {
                <MudTh>
                    <MudTableSortLabel SortLabel="@psa.MetaverseAttribute.Name" T="MetaverseObjectHeader"
                        InitialDirection="@(psa.MetaverseAttribute.Name == Constants.BuiltInAttributes.DisplayName ? SortDirection.Ascending : SortDirection.None)">
                        <MudText Typo="Typo.button">@psa.MetaverseAttribute.Name</MudText>
                    </MudTableSortLabel>
                </MudTh>
            }
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@Constants.BuiltInAttributes.DisplayName">
                <MudLink Href="@Utilities.GetMetaverseObjectHref(context)">@Utilities.GetMetaverseObjectHrefText(context)</MudLink>
            </MudTd>
            @foreach (var psa in PredefinedSearch.Attributes.Where(q => q.MetaverseAttribute.Name != Constants.BuiltInAttributes.DisplayName))
            {
                <MudTd DataLabel="@psa.MetaverseAttribute.Name">@context.GetAttributeValue(psa.MetaverseAttribute.Name)?.StringValue</MudTd>
            }
        </RowTemplate>
        <NoRecordsContent>
            No results
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}
else if (_isInitialised)
{
    if (!string.IsNullOrEmpty(PredefinedSearchUri))
    {
        <b>No such predefined search found, sorry</b>
    }
    else
    {
        <b>Please create a default Predefined Search for this Metaverse Object Type</b>
    }
}

@code {
    [Parameter]
    public string TypeNameUrlParam { get; set; } = null!;

    [Parameter]
    public string? PredefinedSearchUri { get; set; }

    private MudTable<MetaverseObjectHeader>? _table;
    private string _searchString = "";
    private bool _loading;
    private bool _isInitialised;

    private MetaverseObjectType? MetaverseObjectType { get; set; }
    private PredefinedSearch? PredefinedSearch { get; set; }
    private string? PageTitle { get; set; }
    private string? ObjectTypeName { get; set; }
    private List<BreadcrumbItem> _breadcrumbs = null!;

    protected override async Task OnParametersSetAsync()
    {
        // Reset state when parameters change (e.g., navigating between types)
        _isInitialised = false;

        var pluralName = Helpers.ConvertFromUrlParam(TypeNameUrlParam);
        MetaverseObjectType = await Jim.Metaverse.GetMetaverseObjectTypeByPluralNameAsync(pluralName, false);
        if (MetaverseObjectType == null)
        {
            NavManager.NavigateTo("/");
            return;
        }

        // set a default name for the objects on this page (use PluralName for list views)
        PageTitle = MetaverseObjectType.PluralName;

        // are we being asked to load a specific PredefinedSearch, via the URL?
        if (!string.IsNullOrEmpty(PredefinedSearchUri))
        {
            PredefinedSearch = await Jim.Search.GetPredefinedSearchAsync(PredefinedSearchUri);
        }
        else
        {
            // is there a default predefined search for this object type?
            PredefinedSearch = await Jim.Search.GetPredefinedSearchAsync(MetaverseObjectType);
        }

        if (PredefinedSearch != null)
        {
            PageTitle = PredefinedSearch.Name;
            ObjectTypeName = PredefinedSearch.Name.ToLower();
        }

        if (PredefinedSearch == null || PredefinedSearch.IsDefaultForMetaverseObjectType)
        {
            _breadcrumbs = new List<BreadcrumbItem>
            {
                new("Home", href: "/", icon: Icons.Material.Filled.Home),
                new(MetaverseObjectType.PluralName, href: null, disabled: true)
            };
        }
        else
        {
            _breadcrumbs = new List<BreadcrumbItem>
            {
                new("Home", href: "/", icon: Icons.Material.Filled.Home),
                new(MetaverseObjectType.PluralName, href: $"/t/{MetaverseObjectType.PluralName.ToLower()}"),
                new(PredefinedSearch.Name, href: null, disabled: true)
            };
        }

        // Mark as initialised - now the table can render and load data
        _isInitialised = true;
    }

    private async Task<TableData<MetaverseObjectHeader>> ServerReload(TableState state, CancellationToken token)
    {
        if (PredefinedSearch == null)
        {
            return new TableData<MetaverseObjectHeader> { TotalItems = 0, Items = [] };
        }

        _loading = true;
        StateHasChanged();

        try
        {
            // Convert MudBlazor's 0-indexed page to our 1-indexed page
            var page = state.Page + 1;
            var sortDescending = state.SortDirection == SortDirection.Descending;

            // Update URL with current page (without triggering navigation/reload)
            UpdateUrlWithPage(page);

            var result = await Jim.Metaverse.GetMetaverseObjectsOfTypeAsync(
                PredefinedSearch,
                page,
                state.PageSize,
                string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                state.SortLabel,
                sortDescending);

            return new TableData<MetaverseObjectHeader>
            {
                TotalItems = result.TotalResults,
                Items = result.Results
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void UpdateUrlWithPage(int page)
    {
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        var baseUrl = uri.GetLeftPart(UriPartial.Path);

        // Only add ?p= if not on page 1
        var newUrl = page > 1 ? $"{baseUrl}?p={page}" : baseUrl;

        // Update URL without navigation (replace current history entry)
        NavManager.NavigateTo(newUrl, replace: true);
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _table?.ReloadServerData();
    }

    private void HandleRowClick(TableRowClickEventArgs<MetaverseObjectHeader> args)
    {
        if (args.Item != null)
            NavManager.NavigateTo(Utilities.GetMetaverseObjectHref(args.Item));
    }
}
