@page "/activity/{Id:guid}"
@attribute [Authorize(Roles = "User")]
@using JIM.Application
@using JIM.Models.Activities;
@using JIM.Models.Activities.DTOs;
@using JIM.Models.Core.DTOs;
@using JIM.Models.Enums;
@using JIM.Models.Staging
@using JIM.Models.Staging.DTOs
@using JIM.Models.Utility;
@using JIM.Utilities;
@inject JimApplication Jim
@inject NavigationManager NavManager

<PageTitle>Activity: @_activity?.TargetOperationType @_activity?.TargetType.ToString().SplitOnCapitalLetters(): @_activity?.TargetName</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-secondary-text">Activity:</span> @_activity?.TargetOperationType @_activity?.TargetType.ToString().SplitOnCapitalLetters(): <span class="mud-primary-text">@(!string.IsNullOrEmpty(_activity?.TargetName) ? _activity?.TargetName : "(no name)")</span></MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>

@if (_activity != null)
{
    <MudText Typo="Typo.h5" Class="mt-5">Details</MudText>
    <MudPaper Class="pa-5 mt-5" Outlined="true">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">ID:</MudText>
                <MudText Class="mud-text-secondary jim-text-code">@_activity.Id</MudText>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Target:</MudText>
                <MudText Class="mud-text-secondary">
                    @switch (_activity.TargetType)
                    {
                        case ActivityTargetType.DataGenerationTemplate:
                            <MudLink Href="@($"/admin/example-data/templates/{_activity.DataGenerationTemplateId}")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.ConnectedSystem:
                            <MudLink Href="@($"/admin/connected-systems/{_activity.ConnectedSystemId}/")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.ConnectedSystemRunProfile when _connectedSystemHeader != null:
                            <MudLink Href="@($"/admin/connected-systems/{_activity.ConnectedSystemId}/")">@_connectedSystemHeader.Name</MudLink> @:/ @_activity.TargetName
                            break;
                        case ActivityTargetType.MetaverseObject when _metaverseObjectHeader != null:
                            <MudLink Href="@Utilities.GetMetaverseObjectHref(_metaverseObjectHeader)">@Utilities.GetMetaverseObjectHrefText(_metaverseObjectHeader)</MudLink>
                            break;
                        case ActivityTargetType.SyncRule:
                            <MudLink Href="@($"/admin/connected-systems/sync-rules/{_activity.SyncRuleId}")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.TrustedCertificate:
                            <MudLink Href="/admin/certificates">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.MetaverseAttribute:
                            <MudLink Href="/admin/schema/metaverse">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.ObjectMatchingRule:
                        case ActivityTargetType.NotSet:
                        default:
                            @(_activity.TargetName ?? "-")
                            break;
                    }
                </MudText>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">When:</MudText>
                <MudText Class="mud-text-secondary" title="@_activity.Created.ToLocalTime().ToFriendlyDate()">@_activity.Created.ToLocalTime().ToRelativeTime()</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Initiated By:</MudText>
                @{
                    if (_activity.InitiatedByType == ActivityInitiatorType.User && _activity.InitiatedByMetaverseObject != null)
                    {
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            <MudLink Href="@Utilities.GetMetaverseObjectHref(_activity.InitiatedByMetaverseObject)">@Utilities.GetMetaverseObjectHrefText(_activity.InitiatedByMetaverseObject)</MudLink>
                        </MudText>
                    }
                    else if (_activity.InitiatedByType == ActivityInitiatorType.ApiKey)
                    {
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @if (_activity.InitiatedById.HasValue)
                            {
                                <MudLink Href="@Utilities.GetApiKeyHref(_activity.InitiatedById.Value)">@_activity.InitiatedByName</MudLink>
                            }
                            else
                            {
                                <span>@_activity.InitiatedByName</span>
                            }
                        </MudText>
                    }
                    else if (!string.IsNullOrEmpty(_activity.InitiatedByName))
                    {
                        <MudText>@_activity.InitiatedByName</MudText>
                    }
                }
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Status:</MudText><br />
                <MudChip T="string" Variant="Variant.Text" Color="Helpers.GetActivityMudBlazorColorForStatus(_activity.Status)" Class="ml-0">@_activity.Status.ToString().SplitOnCapitalLetters()</MudChip>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Execution Time:</MudText>
                <MudText Class="mud-text-secondary">@(_activity.ExecutionTime?.ToAbbreviatedString() ?? "-")</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Total Activity Time:</MudText>
                <MudText Class="mud-text-secondary">@(_activity.TotalActivityTime?.ToAbbreviatedString() ?? "-")</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (!string.IsNullOrEmpty(_activity.ErrorMessage) || !string.IsNullOrEmpty(_activity.ErrorStackTrace))
    {
        <MudPaper Class="pa-4 mt-4" Style="@($"color:{Colors.Shades.White}; background:{Colors.Red.Default};")" Outlined="true">
            @if (!string.IsNullOrEmpty(_activity.ErrorMessage))
            {
                <MudText Typo="Typo.button">Error Message:</MudText>
                <MudText>@_activity.ErrorMessage</MudText>
                <br />
            }

            @if (!string.IsNullOrEmpty(_activity.ErrorStackTrace))
            {
                <MudText Typo="Typo.button">Error Stack:</MudText>
                <pre style="white-space: pre-wrap; word-wrap: break-word; overflow-x: auto; max-width: 100%;">@_activity.ErrorStackTrace</pre>
            }
        </MudPaper>
    }

    @if (_activity.TargetType == ActivityTargetType.ConnectedSystemRunProfile && _activity.TargetOperationType == ActivityTargetOperationType.Execute)
    {
        @if (_activityRunProfileExecutionStats != null)
        {
            @* Summary Section *@
            <MudText Typo="Typo.h5" Class="mt-5">Summary</MudText>
            <MudStack Row="true" Class="mt-4 mb-5 flex-wrap" Spacing="3">
                @* Total card *@
                <MudPaper Class="pa-4" Outlined="true" Style="min-width: 120px;">
                    <MudText Typo="Typo.button" Class="mud-text-secondary">Total</MudText>
                    <MudText Typo="Typo.h4">@_activityRunProfileExecutionStats.TotalObjectChangeCount.ToString("N0")</MudText>
                </MudPaper>

                @* Import-specific cards *@
                @if (IsImportRun())
                {
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Green.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Added</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success">@_activityRunProfileExecutionStats.TotalCsoAdds.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Teal.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Updated</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Info">@_activityRunProfileExecutionStats.TotalCsoUpdates.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Red.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Deleted</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Error">@_activityRunProfileExecutionStats.TotalCsoDeletes.ToString("N0")</MudText>
                    </MudPaper>
                }

                @* Sync-specific cards *@
                @if (IsSyncRun())
                {
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid var(--mud-palette-primary); min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Projected</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Primary">@_activityRunProfileExecutionStats.TotalProjections.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid var(--mud-palette-secondary); min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Joined</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Secondary">@_activityRunProfileExecutionStats.TotalJoins.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid var(--mud-palette-tertiary); min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Attribute Flow</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Tertiary">@_activityRunProfileExecutionStats.TotalAttributeFlows.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid var(--mud-palette-warning); min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Disconnected</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Warning">@_activityRunProfileExecutionStats.TotalDisconnections.ToString("N0")</MudText>
                    </MudPaper>
                }

                @* Export-specific cards *@
                @if (IsExportRun())
                {
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Green.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Provisioned</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success">@_activityRunProfileExecutionStats.TotalProvisioned.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Teal.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Exported</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Info">@_activityRunProfileExecutionStats.TotalExported.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Red.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Deprovisioned</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Error">@_activityRunProfileExecutionStats.TotalDeprovisioned.ToString("N0")</MudText>
                    </MudPaper>
                }

                @* Unchanged card - always show *@
                <MudPaper Class="pa-4" Outlined="true" Style="border-left: 4px solid var(--mud-palette-grey-light); min-width: 120px;">
                    <MudText Typo="Typo.button" Class="mud-text-secondary">Unchanged</MudText>
                    <MudText Typo="Typo.h4" Class="mud-text-secondary">@_activityRunProfileExecutionStats.TotalUnchanged.ToString("N0")</MudText>
                </MudPaper>

                @* Object Types card *@
                <MudPaper Class="pa-4" Outlined="true" Style="min-width: 120px;">
                    <MudText Typo="Typo.button" Class="mud-text-secondary">Object Types</MudText>
                    <MudText Typo="Typo.h4">@_activityRunProfileExecutionStats.TotalObjectTypes.ToString("N0")</MudText>
                </MudPaper>

                @* Errors card - green border when 0, red background when > 0 *@
                <MudPaper Class="pa-4" Outlined="true"
                          Style="@(_activityRunProfileExecutionStats.TotalObjectErrors > 0
                                 ? $"background-color: {Colors.Red.Default}; color: {Colors.Shades.White}; border-left: 4px solid {Colors.Red.Darken3}; min-width: 120px;"
                                 : $"border-left: 4px solid {Colors.Green.Default}; min-width: 120px;")">
                    <MudText Typo="Typo.button" Style="@(_activityRunProfileExecutionStats.TotalObjectErrors > 0 ? $"color: {Colors.Shades.White};" : "")">Errors</MudText>
                    <MudText Typo="Typo.h4" Style="@(_activityRunProfileExecutionStats.TotalObjectErrors > 0 ? $"color: {Colors.Shades.White};" : "")">@_activityRunProfileExecutionStats.TotalObjectErrors.ToString("N0")</MudText>
                </MudPaper>
            </MudStack>
        }

        @* Results Section with Filter and Table *@
        <MudText Typo="Typo.h5">@Helpers.GetRunTypeResultsTitle(_activity.ConnectedSystemRunType)</MudText>

        @* Change Type Filter Chips *@
        @if (GetAvailableChangeTypes().Any())
        {
            <MudText Typo="Typo.body2" Class="mud-text-secondary mt-3 mb-2">Filter by Change Type:</MudText>
            <MudChipSet T="ObjectChangeType"
                        SelectionMode="SelectionMode.MultiSelection"
                        SelectedValues="_selectedChangeTypes"
                        SelectedValuesChanged="OnChangeTypeFilterChanged"
                        Class="mb-3">
                @foreach (var changeType in GetAvailableChangeTypes())
                {
                    <MudChip Value="@changeType"
                             Color="@Helpers.GetRunItemMudBlazorColorForType(changeType)"
                             Variant="@(IsChangeTypeSelected(changeType) ? Variant.Filled : Variant.Outlined)"
                             SelectedColor="@Helpers.GetRunItemMudBlazorColorForType(changeType)">
                        @Helpers.GetChangeTypeDisplayName(changeType)
                        @if (GetChangeTypeCount(changeType) is var count && count > 0)
                        {
                            <MudText Typo="Typo.caption" Class="ml-1">(@count.ToString("N0"))</MudText>
                        }
                    </MudChip>
                }
                @* Disabled Unchanged chip *@
                <MudChip T="ObjectChangeType"
                         Variant="Variant.Outlined"
                         Color="Color.Default"
                         Disabled="true">
                    Unchanged
                    <MudText Typo="Typo.caption" Class="ml-1">(@GetUnchangedCount().ToString("N0"))</MudText>
                </MudChip>
            </MudChipSet>
        }

        <MudTable @ref="_table"
                  T="ActivityRunProfileExecutionItemHeader"
                  ServerData="ServerReload"
                  Hover="true"
                  Dense="true"
                  Breakpoint="Breakpoint.Sm"
                  Class="mt-3 mb-5"
                  Outlined="true"
                  Elevation="0"
                  OnRowClick="HandleRowClick"
                  RowClass="cursor-pointer"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary">
            <ToolBarContent>
                <MudSpacer />
                <MudTextField T="string"
                              ValueChanged="@(s => OnSearch(s))"
                              Placeholder="Search name, external ID, or object type"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Medium"
                              Class="mt-0"
                              Style="min-width: 300px;" />
            </ToolBarContent>
            <HeaderContent>
                <MudTh>
                    <MudTableSortLabel SortLabel="id" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">Internal Id</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="externalid" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">External Id</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="displayname" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">Name</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="objecttype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">External Object Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="changetype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">Change Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="errortype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">Error Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Internal Id"><MudLink Href="@($"/activity/sync/{context.Id}")">@context.Id</MudLink></MudTd>
                <MudTd DataLabel="External Id" class="jim-text-code">@(!string.IsNullOrEmpty(context.ExternalIdValue) ? context.ExternalIdValue : "-")</MudTd>
                <MudTd DataLabel="Display Name">@(!string.IsNullOrEmpty(context.DisplayName) ? context.DisplayName : "-")</MudTd>
                <MudTd DataLabel="External Object Type">@(context.ConnectedSystemObjectType != null ? context.ConnectedSystemObjectType.ToString().SplitOnCapitalLetters() : "-")</MudTd>
                <MudTd DataLabel="Change Type">
                    <MudChip T="string" Variant="Variant.Text" Color="Helpers.GetRunItemMudBlazorColorForType(context.ObjectChangeType)">@context.ObjectChangeType.ToString().SplitOnCapitalLetters()</MudChip>
                </MudTd>
                <MudTd DataLabel="Error Type">
                    @if (context.ErrorType != null && context.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
                    {
                        <MudChip T="string" Variant="Variant.Text" Color="Color.Error">@context.ErrorType.Value.ToString().SplitOnCapitalLetters()</MudChip>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                @if (string.IsNullOrWhiteSpace(_searchString))
                {
                    <MudText>There are no sync results to show.</MudText>
                }
                else
                {
                    <MudText>No sync results found matching "@_searchString".</MudText>
                }
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private MudTable<ActivityRunProfileExecutionItemHeader>? _table;
    private Activity? _activity;
    private ConnectedSystemHeader? _connectedSystemHeader;
    private MetaverseObjectHeader? _metaverseObjectHeader;
    private ActivityRunProfileExecutionStats? _activityRunProfileExecutionStats;
    private string _searchString = "";
    private bool _loading;

    // Change type filter - when chips are selected, the table reloads with the filter applied
    private IReadOnlyCollection<ObjectChangeType> _selectedChangeTypes = new List<ObjectChangeType>();

    private readonly List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new("Home", href: "/", icon: Icons.Material.Filled.Home),
        new("Activity", href: "/activity"),
        new("Activity Detail", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        _activity = await Jim.Activities.GetActivityAsync(Id);
        if (_activity == null)
        {
            NavManager.NavigateTo("../");
            return;
        }

        // Note: These queries run sequentially because EF Core's DbContext is not thread-safe.
        // The main performance win comes from the optimised GROUP BY query in GetActivityRunProfileExecutionStatsAsync.
        if (_activity.ConnectedSystemId.HasValue)
            _connectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(_activity.ConnectedSystemId.Value);

        if (_activity.TargetType is ActivityTargetType.MetaverseObject or ActivityTargetType.ConnectedSystemRunProfile && _activity.MetaverseObjectId != null)
            _metaverseObjectHeader = await Jim.Metaverse.GetMetaverseObjectHeaderAsync(_activity.MetaverseObjectId.Value);

        if (_activity.TargetType == ActivityTargetType.ConnectedSystemRunProfile && _activity.TargetOperationType == ActivityTargetOperationType.Execute)
            _activityRunProfileExecutionStats = await Jim.Activities.GetActivityRunProfileExecutionStatsAsync(_activity.Id);
    }

    private async Task<TableData<ActivityRunProfileExecutionItemHeader>> ServerReload(TableState state, CancellationToken token)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Convert MudBlazor's 0-indexed page to our 1-indexed page
            var page = state.Page + 1;
            var sortDescending = state.SortDirection == SortDirection.Descending;

            // Get selected change types for filtering (null means show all)
            IEnumerable<ObjectChangeType>? changeTypeFilter = _selectedChangeTypes.Count > 0 ? _selectedChangeTypes : null;

            var result = await Jim.Activities.GetActivityRunProfileExecutionItemHeadersAsync(
                Id,
                page,
                state.PageSize,
                string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                state.SortLabel,
                sortDescending,
                changeTypeFilter);

            return new TableData<ActivityRunProfileExecutionItemHeader>
            {
                TotalItems = result.TotalResults,
                Items = result.Results
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _table?.ReloadServerData();
    }

    private void OnChangeTypeFilterChanged(IReadOnlyCollection<ObjectChangeType> selectedTypes)
    {
        _selectedChangeTypes = selectedTypes;
        _table?.ReloadServerData();
    }

    private void HandleRowClick(TableRowClickEventArgs<ActivityRunProfileExecutionItemHeader> args)
    {
        if (_loading || args.Item == null)
            return;

        NavManager.NavigateTo($"/activity/sync/{args.Item.Id}");
    }

    /// <summary>
    /// Returns the change types that have at least one RPEI in this activity.
    /// Shows all possible change types with non-zero counts first, ordered logically.
    /// </summary>
    private IEnumerable<ObjectChangeType> GetAvailableChangeTypes()
    {
        if (_activityRunProfileExecutionStats == null)
            return Enumerable.Empty<ObjectChangeType>();

        // Return change types in logical order: Import → Sync → Export → Other
        var availableTypes = new List<ObjectChangeType>();

        // Import operations
        if (_activityRunProfileExecutionStats.TotalCsoAdds > 0)
            availableTypes.Add(ObjectChangeType.Added);
        if (_activityRunProfileExecutionStats.TotalCsoUpdates > 0)
            availableTypes.Add(ObjectChangeType.Updated);
        if (_activityRunProfileExecutionStats.TotalCsoDeletes > 0)
            availableTypes.Add(ObjectChangeType.Deleted);

        // Sync operations
        if (_activityRunProfileExecutionStats.TotalProjections > 0)
            availableTypes.Add(ObjectChangeType.Projected);
        if (_activityRunProfileExecutionStats.TotalJoins > 0)
            availableTypes.Add(ObjectChangeType.Joined);
        if (_activityRunProfileExecutionStats.TotalAttributeFlows > 0)
            availableTypes.Add(ObjectChangeType.AttributeFlow);
        if (_activityRunProfileExecutionStats.TotalDisconnections > 0)
            availableTypes.Add(ObjectChangeType.Disconnected);

        // Export operations
        if (_activityRunProfileExecutionStats.TotalProvisioned > 0)
            availableTypes.Add(ObjectChangeType.Provisioned);
        if (_activityRunProfileExecutionStats.TotalExported > 0)
            availableTypes.Add(ObjectChangeType.Exported);
        if (_activityRunProfileExecutionStats.TotalDeprovisioned > 0)
            availableTypes.Add(ObjectChangeType.Deprovisioned);

        // Note: NoChange RPEIs are filtered out from GetAvailableChangeTypes
        // as unchanged objects are shown separately via TotalUnchanged

        return availableTypes;
    }

    /// <summary>
    /// Gets the count of RPEIs for a specific change type from the stats.
    /// </summary>
    private int GetChangeTypeCount(ObjectChangeType changeType)
    {
        if (_activityRunProfileExecutionStats == null)
            return 0;

        return changeType switch
        {
            ObjectChangeType.Added => _activityRunProfileExecutionStats.TotalCsoAdds,
            ObjectChangeType.Updated => _activityRunProfileExecutionStats.TotalCsoUpdates,
            ObjectChangeType.Deleted => _activityRunProfileExecutionStats.TotalCsoDeletes,
            ObjectChangeType.Projected => _activityRunProfileExecutionStats.TotalProjections,
            ObjectChangeType.Joined => _activityRunProfileExecutionStats.TotalJoins,
            ObjectChangeType.AttributeFlow => _activityRunProfileExecutionStats.TotalAttributeFlows,
            ObjectChangeType.Disconnected => _activityRunProfileExecutionStats.TotalDisconnections,
            ObjectChangeType.Provisioned => _activityRunProfileExecutionStats.TotalProvisioned,
            ObjectChangeType.Exported => _activityRunProfileExecutionStats.TotalExported,
            ObjectChangeType.Deprovisioned => _activityRunProfileExecutionStats.TotalDeprovisioned,
            ObjectChangeType.NoChange => 0, // NoChange items shown via TotalUnchanged
            _ => 0
        };
    }

    /// <summary>
    /// Checks if a change type is currently selected in the filter.
    /// </summary>
    private bool IsChangeTypeSelected(ObjectChangeType changeType)
    {
        return _selectedChangeTypes.Contains(changeType);
    }

    /// <summary>
    /// Gets the relevant change types for the current run type.
    /// Returns all possible change types for the run type, not just those with counts > 0.
    /// </summary>
    private IEnumerable<ObjectChangeType> GetRelevantChangeTypes()
    {
        return Helpers.GetChangeTypesForRunType(_activity?.ConnectedSystemRunType);
    }

    /// <summary>
    /// Checks if this is an Import run (Full or Delta).
    /// Falls back to checking if import stats are populated when run type is NotSet.
    /// </summary>
    private bool IsImportRun()
    {
        var runType = _activity?.ConnectedSystemRunType;
        if (runType is ConnectedSystemRunType.FullImport or ConnectedSystemRunType.DeltaImport)
            return true;

        // Fallback: check if this looks like an import based on stats or target name
        if (runType is null or ConnectedSystemRunType.NotSet)
        {
            // Check if the target name contains "Import" or if import stats exist
            if (_activity?.TargetName?.Contains("Import", StringComparison.OrdinalIgnoreCase) == true)
                return true;
            // If there are CSO adds/updates/deletes but no sync or export stats, it's likely import
            if (_activityRunProfileExecutionStats != null &&
                (_activityRunProfileExecutionStats.TotalCsoAdds > 0 ||
                 _activityRunProfileExecutionStats.TotalCsoUpdates > 0 ||
                 _activityRunProfileExecutionStats.TotalCsoDeletes > 0) &&
                _activityRunProfileExecutionStats.TotalProjections == 0 &&
                _activityRunProfileExecutionStats.TotalProvisioned == 0)
                return true;
        }

        return false;
    }

    /// <summary>
    /// Checks if this is a Sync run (Full or Delta).
    /// </summary>
    private bool IsSyncRun()
    {
        var runType = _activity?.ConnectedSystemRunType;
        if (runType is ConnectedSystemRunType.FullSynchronisation or ConnectedSystemRunType.DeltaSynchronisation)
            return true;

        // Fallback: check if this looks like a sync based on stats or target name
        if (runType is null or ConnectedSystemRunType.NotSet)
        {
            if (_activity?.TargetName?.Contains("Sync", StringComparison.OrdinalIgnoreCase) == true)
                return true;
            if (_activityRunProfileExecutionStats != null &&
                (_activityRunProfileExecutionStats.TotalProjections > 0 ||
                 _activityRunProfileExecutionStats.TotalJoins > 0 ||
                 _activityRunProfileExecutionStats.TotalAttributeFlows > 0 ||
                 _activityRunProfileExecutionStats.TotalDisconnections > 0))
                return true;
        }

        return false;
    }

    /// <summary>
    /// Checks if this is an Export run.
    /// </summary>
    private bool IsExportRun()
    {
        var runType = _activity?.ConnectedSystemRunType;
        if (runType == ConnectedSystemRunType.Export)
            return true;

        // Fallback: check if this looks like an export based on stats or target name
        if (runType is null or ConnectedSystemRunType.NotSet)
        {
            if (_activity?.TargetName?.Contains("Export", StringComparison.OrdinalIgnoreCase) == true)
                return true;
            if (_activityRunProfileExecutionStats != null &&
                (_activityRunProfileExecutionStats.TotalProvisioned > 0 ||
                 _activityRunProfileExecutionStats.TotalExported > 0 ||
                 _activityRunProfileExecutionStats.TotalDeprovisioned > 0))
                return true;
        }

        return false;
    }

    /// <summary>
    /// Gets the unchanged count safely.
    /// </summary>
    private int GetUnchangedCount()
    {
        return _activityRunProfileExecutionStats?.TotalUnchanged ?? 0;
    }

    /// <summary>
    /// Converts a MudBlazor Color to its CSS variable name suffix.
    /// </summary>
    private static string GetColorCssName(Color color)
    {
        return color switch
        {
            Color.Primary => "primary",
            Color.Secondary => "secondary",
            Color.Tertiary => "tertiary",
            Color.Info => "info",
            Color.Success => "success",
            Color.Warning => "warning",
            Color.Error => "error",
            Color.Dark => "dark",
            Color.Surface => "surface",
            _ => "default"
        };
    }
}
