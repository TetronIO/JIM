services:

  jim.web:
    container_name: jim.web
    image: ${DOCKER_REGISTRY-}jim.web
    restart: always
    env_file: .env
    environment:
      # Docker-specific overrides
      - DB_HOSTNAME=jim.database
      - LOGGING_PATH=/var/log/jim
      - LOGGING_LEVEL=Verbose
      - ENABLE_REQUEST_LOGGING=true
    volumes:
      - jim-logs-volume:/var/log/jim
    cap_add:
      - DAC_READ_SEARCH
      - SYS_ADMIN
    build:
      context: .
      dockerfile: JIM.Web/Dockerfile
    depends_on:
      - jim.database
      - jim.worker
    healthcheck:
      test: ["CMD-SHELL", "printf 'GET /api/v1/health/ready HTTP/1.1\\r\\nHost: localhost\\r\\n\\r\\n' | nc localhost 80 | grep -q '200 OK'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - jim-network

  jim.worker:
    container_name: jim.worker
    image: ${DOCKER_REGISTRY-}jim.worker
    restart: always
    env_file: .env
    environment:
      # Docker-specific overrides
      - DB_HOSTNAME=jim.database
      - LOGGING_PATH=/var/log/jim
      - LOGGING_LEVEL=Verbose
    volumes:
      - jim-logs-volume:/var/log/jim
    build:
      context: .
      dockerfile: JIM.Worker/Dockerfile
    depends_on:
      - jim.database
    networks:
      - jim-network

  jim.scheduler:
    container_name: jim.scheduler
    image: ${DOCKER_REGISTRY-}jim.scheduler
    restart: always
    env_file: .env
    environment:
      # Docker-specific overrides
      - DB_HOSTNAME=jim.database
      - LOGGING_PATH=/var/log/jim
      - LOGGING_LEVEL=Error
    volumes:
      - jim-logs-volume:/var/log/jim
    build:
      context: .
      dockerfile: JIM.Scheduler/Dockerfile
    depends_on:
      - jim.database
      - jim.worker
    networks:
      - jim-network

  adminer:
    container_name: jim.adminer
    image: adminer
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - jim.database
    networks:
      - jim-network

  jim.database:
    container_name: jim.database
    image: postgres:18
    # customise the following command parameter values for your environment: https://pgtune.leopard.in.ua/
    # the default values are for a 64gb windows/32gb wsl 16 core ssd system
    # statement_timeout=300000 (5 minutes) prevents runaway queries
    # log_min_duration_statement=1000 (1 second) logs slow queries for performance analysis
    command: postgres -c max_connections=200 -c shared_buffers=8GB -c effective_cache_size=24GB -c maintenance_work_mem=2GB -c checkpoint_completion_target=0.9 -c wal_buffers=16MB -c default_statistics_target=100 -c random_page_cost=1.1 -c effective_io_concurrency=200 -c work_mem=10485kB -c min_wal_size=1GB -c max_wal_size=4GB -c max_worker_processes=16 -c max_parallel_workers_per_gather=4 -c max_parallel_workers=16 -c max_parallel_maintenance_workers=4 -c statement_timeout=300000 -c log_min_duration_statement=1000
    restart: always
    volumes:
      - jim-db-volume:/var/lib/postgresql
    env_file: .env
    environment:
      # Postgres uses different var names
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - jim-network

networks:
  jim-network:
    driver: bridge

volumes:
  jim-db-volume:
    name: jim-db-volume
  jim-logs-volume:
    name: jim-logs-volume
