@page "/admin/schema/object-types/{Id:int}"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.Core
@using JIM.Models.Logic
@using JIM.Models.Staging
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>Metaverse Object Type: @_metaverseObjectType?.Name</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-secondary-text">Metaverse Object Type:</span> @_metaverseObjectType?.Name</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>

@if (_metaverseObjectType != null)
{
    <MudText Typo="Typo.h5" Class="mt-5">Details</MudText>
    <MudPaper Class="pa-5 mt-5" Outlined="true">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudField Label="Name" Variant="Variant.Outlined">@_metaverseObjectType.Name</MudField>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudField Label="Plural Name" Variant="Variant.Outlined">@_metaverseObjectType.PluralName</MudField>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudField Label="Created" Variant="Variant.Outlined">@_metaverseObjectType.Created</MudField>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudField Label="Built-in?" Variant="Variant.Outlined">@(_metaverseObjectType.BuiltIn ? "Yes" : "No")</MudField>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <MudText Typo="Typo.h5" Class="mt-5">Deletion Rules</MudText>
    <MudText Typo="Typo.subtitle1" Class="mud-text-secondary mt-2">Configure when metaverse objects of this type should be automatically deleted.</MudText>

    <MudPaper Class="pa-5 mt-5" Outlined="true">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudSelect T="MetaverseObjectDeletionRule" Label="Deletion Rule" @bind-Value="_deletionRule"
                    Variant="Variant.Outlined" HelperText="@GetDeletionRuleHelperText()">
                    <MudSelectItem Value="MetaverseObjectDeletionRule.Manual">Manual</MudSelectItem>
                    <MudSelectItem Value="MetaverseObjectDeletionRule.WhenLastConnectorDisconnected">When Last Connector Disconnected</MudSelectItem>
                    <MudSelectItem Value="MetaverseObjectDeletionRule.WhenAuthoritativeSourceDisconnected">When Authoritative Source Disconnected</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudNumericField T="int?" Label="Grace Period (Days)" @bind-Value="_gracePeriodDays"
                    Variant="Variant.Outlined" Min="0" Max="3650"
                    HelperText="Days to wait before deletion. 0 or empty for immediate." />
            </MudItem>
        </MudGrid>

        @if (_deletionRule == MetaverseObjectDeletionRule.WhenAuthoritativeSourceDisconnected)
        {
            <div class="mt-4">
                <MudText Typo="Typo.subtitle2" Class="mb-2">Authoritative Sources</MudText>
                @if (_contributingSystems.Any())
                {
                    <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3">
                        Select the connected systems that are authoritative sources for this object type.
                        When ANY of these systems disconnects, the metaverse object will be scheduled for deletion.
                    </MudText>
                    @foreach (var system in _contributingSystems)
                    {
                        <MudCheckBox T="bool" Value="@_selectedAuthoritativeSources.Contains(system.Id)"
                            ValueChanged="@((bool val) => ToggleAuthoritativeSource(system.Id, val))"
                            Label="@system.Name" Color="Color.Primary" />
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Warning" Variant="Variant.Text" Dense="true">
                        No contributing systems found. Create inbound sync rules for this object type to enable authoritative source selection.
                    </MudAlert>
                }
            </div>
        }

        <MudStack Row="true" Class="mt-5" Spacing="2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveDeletionRulesAsync"
                Disabled="@(!CanSave())">
                Save Changes
            </MudButton>
            <MudButton Variant="Variant.Text" OnClick="ResetDeletionRules">Reset</MudButton>
        </MudStack>
    </MudPaper>

    <MudText Typo="Typo.h5" Class="mt-5">Attributes</MudText>
    <MudText Typo="Typo.subtitle1" Class="mud-text-secondary mt-2">These are the attributes bound to the metaverse object type:</MudText>

    <MudPaper Class="pa-5 mt-5 mb-5" Outlined="true">
        @foreach (var metaverseAttribute in _metaverseObjectType.Attributes)
        {
            <MudChip T="string" Variant="Variant.Filled" Color="Color.Primary">@metaverseAttribute.Name</MudChip>
        }
    </MudPaper>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private MetaverseObjectType? _metaverseObjectType;
    private List<BreadcrumbItem> _breadcrumbs = null!;

    // Deletion rules state
    private MetaverseObjectDeletionRule _deletionRule;
    private int? _gracePeriodDays;
    private HashSet<int> _selectedAuthoritativeSources = new();
    private List<ConnectedSystem> _contributingSystems = new();

    // Original values for change detection
    private MetaverseObjectDeletionRule _originalDeletionRule;
    private int? _originalGracePeriodDays;
    private HashSet<int> _originalAuthoritativeSources = new();

    protected override async Task OnInitializedAsync()
    {
        _metaverseObjectType = await Jim.Metaverse.GetMetaverseObjectTypeAsync(Id, true);
        if (_metaverseObjectType == null)
        {
            NavManager.NavigateTo("../");
            return;
        }

        _breadcrumbs = new List<BreadcrumbItem>
        {
            new("Home", href: "/", icon: Icons.Material.Filled.Home),
            new("Schema", href: "/admin/schema/"),
            new(_metaverseObjectType.Name, href: null, disabled: true)
        };

        // Load contributing systems (systems with inbound sync rules for this object type)
        await LoadContributingSystemsAsync();

        // Initialise deletion rules state
        InitialiseDeletionRulesState();
    }

    private async Task LoadContributingSystemsAsync()
    {
        var allSyncRules = await Jim.Repository.ConnectedSystems.GetSyncRulesAsync();
        var inboundRulesForType = allSyncRules
            .Where(sr => sr.Direction == SyncRuleDirection.Import && sr.MetaverseObjectTypeId == Id)
            .ToList();

        var connectedSystemIds = inboundRulesForType.Select(sr => sr.ConnectedSystemId).Distinct();
        _contributingSystems = new List<ConnectedSystem>();

        foreach (var csId in connectedSystemIds)
        {
            var cs = await Jim.ConnectedSystems.GetConnectedSystemAsync(csId);
            if (cs != null)
                _contributingSystems.Add(cs);
        }
    }

    private void InitialiseDeletionRulesState()
    {
        if (_metaverseObjectType == null) return;

        _deletionRule = _metaverseObjectType.DeletionRule;
        _gracePeriodDays = _metaverseObjectType.DeletionGracePeriodDays;
        _selectedAuthoritativeSources = new HashSet<int>(_metaverseObjectType.DeletionTriggerConnectedSystemIds ?? new List<int>());

        // Store original values
        _originalDeletionRule = _deletionRule;
        _originalGracePeriodDays = _gracePeriodDays;
        _originalAuthoritativeSources = new HashSet<int>(_selectedAuthoritativeSources);
    }

    private void ResetDeletionRules()
    {
        _deletionRule = _originalDeletionRule;
        _gracePeriodDays = _originalGracePeriodDays;
        _selectedAuthoritativeSources = new HashSet<int>(_originalAuthoritativeSources);
    }

    private void ToggleAuthoritativeSource(int systemId, bool selected)
    {
        if (selected)
            _selectedAuthoritativeSources.Add(systemId);
        else
            _selectedAuthoritativeSources.Remove(systemId);
    }

    private string GetDeletionRuleHelperText()
    {
        return _deletionRule switch
        {
            MetaverseObjectDeletionRule.Manual => "Objects must be manually deleted by an administrator.",
            MetaverseObjectDeletionRule.WhenLastConnectorDisconnected => "Delete when all connected system objects are disconnected.",
            MetaverseObjectDeletionRule.WhenAuthoritativeSourceDisconnected => "Delete when any selected authoritative source disconnects.",
            _ => string.Empty
        };
    }

    private bool CanSave()
    {
        // Check if WhenAuthoritativeSourceDisconnected requires at least one source selected
        if (_deletionRule == MetaverseObjectDeletionRule.WhenAuthoritativeSourceDisconnected &&
            !_selectedAuthoritativeSources.Any())
        {
            return false;
        }

        // Check if there are actual changes
        return HasChanges();
    }

    private bool HasChanges()
    {
        if (_deletionRule != _originalDeletionRule) return true;
        if (_gracePeriodDays != _originalGracePeriodDays) return true;
        if (!_selectedAuthoritativeSources.SetEquals(_originalAuthoritativeSources)) return true;
        return false;
    }

    private async Task SaveDeletionRulesAsync()
    {
        if (_metaverseObjectType == null) return;

        try
        {
            // Update the object type
            _metaverseObjectType.DeletionRule = _deletionRule;
            _metaverseObjectType.DeletionGracePeriodDays = _gracePeriodDays == 0 ? null : _gracePeriodDays;
            _metaverseObjectType.DeletionTriggerConnectedSystemIds = _deletionRule == MetaverseObjectDeletionRule.WhenAuthoritativeSourceDisconnected
                ? _selectedAuthoritativeSources.ToList()
                : new List<int>();

            await Jim.Metaverse.UpdateMetaverseObjectTypeAsync(_metaverseObjectType);

            // Update original values to reflect saved state
            _originalDeletionRule = _deletionRule;
            _originalGracePeriodDays = _gracePeriodDays;
            _originalAuthoritativeSources = new HashSet<int>(_selectedAuthoritativeSources);

            Snackbar.Add("Deletion rules saved successfully.", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save deletion rules: {ex.Message}", Severity.Error);
        }
    }
}
