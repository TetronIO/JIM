@page "/admin/example-data/templates/{Id:int}"
@attribute [Authorize(Roles = "Administrators")]
@using JIM.Application
@using JIM.Models.DataGeneration
@using JIM.Models.Core
@using JIM.Models.Tasking
@using System.Diagnostics
@inject JimApplication Jim
@inject NavigationManager NavManager

<PageTitle>Data Generation Template: @template?.Name</PageTitle>
<MudText Typo="Typo.h4" Class="mt-5"><span class="mud-secondary-text">Data Generation Template:</span> @template?.Name</MudText>

@if (template != null)
{
    foreach (var objectType in template.ObjectTypes)
    {
        <MudTable Items="@objectType.TemplateAttributes" Hover="true" Breakpoint="Breakpoint.Sm" Class="mt-5 mb-5" SortLabel="Sort By">
            <ToolBarContent>
                <MudText Typo="Typo.h6">@objectType.MetaverseObjectType.Name</MudText>
            </ToolBarContent>
            <HeaderContent>
                <MudTh><MudTableSortLabel SortBy="new Func<DataGenerationTemplateAttribute, object>(x => x.MetaverseAttribute.Name)">Attribute</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<DataGenerationTemplateAttribute, object>(x => x.MetaverseAttribute.Type)">Type</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<DataGenerationTemplateAttribute, object>(x => x.PopulatedValuesPercentage)">Population %</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<DataGenerationTemplateAttribute, object>(x => SimplifyAttributeConstraints(x))">Rules</MudTableSortLabel></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Attribute">@context.MetaverseAttribute?.Name</MudTd>
                <MudTd DataLabel="Type">@context.MetaverseAttribute?.Type</MudTd>
                <MudTd DataLabel="Population &">@context.PopulatedValuesPercentage</MudTd>
                <MudTd DataLabel="Rules">@((MarkupString)SimplifyAttributeConstraints(context))</MudTd>
            </RowTemplate>
            <NoRecordsContent>
                No template attributes
            </NoRecordsContent>
        </MudTable>
    }
}

<MudAlert Severity="Severity.Warning" Class="mb-5">
    <MudText Typo="Typo.h6">Warning</MudText>
    <MudText>
        Executing this template will cause example data to be inserted into the Metaverse. It's not recommended to do this on a system with Connectors and that is already initialised.
        This feature is primarily designed to enable demo or proof of concept work. There is no easy way to undo this once performed.
    </MudText>
    <MudButton Class="mt-5"
               Variant="Variant.Filled"
               StartIcon="@Icons.Material.Filled.BuildCircle"
               Color="Color.Warning"
               Disabled="@(status != null)"
               OnClick="ExecuteTemplateAsync">
        @if (status != null && status == ServiceTaskStatus.Processing)
        {
            <text>Processing...</text>
        }
        else if (status != null && status == ServiceTaskStatus.Queued)
        {
            <text>Queued...</text>
        }
        else
        {
            <text>Execute Template</text>
        }
    </MudButton>
</MudAlert>

@code {
    [Parameter]
    public int Id { get; set; }

    private DataGenerationTemplate? template;
    private DataGenerationTemplateServiceTask? task;
    private ServiceTaskStatus? status;

    protected override async Task OnInitializedAsync()
    {
        template = await Jim.DataGeneration.GetTemplateAsync(Id, false);
        if (template == null)
        {
            // template not found, redirect to index page
            NavManager.NavigateTo("../");
            return;
        }

        // has this template already been scheduled, or is already being processed on the service queue?
        // continuously update the UI to show any change in status
        // POLLING_TO_REPLACE - tagging this functionality for replacement with an event-based ui update approach in the future
        var timer = new Timer(new TimerCallback(async _ =>
        {
            Debug.WriteLine("Timer loop executing...");
            if (template != null)
            {
                status = await Jim.Tasking.GetFirstDataGenerationTemplateServiceTaskStatus(template.Id);
                if (status != null)
                    Debug.WriteLine("TimerLoop: status is " + status);
                else
                    Debug.WriteLine("TimerLoop: status is null");
            }
            else
            {
                Debug.WriteLine("TimerLoop: template is null");
            }

            await InvokeAsync(() =>
            {
                StateHasChanged();
            });
        }), null, 2000, 2000);
    }

    private string SimplifyAttributeConstraints(DataGenerationTemplateAttribute dgta)
    {
        string response = "";
        if (dgta.MetaverseAttribute?.Type == AttributeDataType.String)
        {
            if (!string.IsNullOrEmpty(dgta.Pattern))
                response += CreateBadgeHtml("Pattern", dgta.Pattern);

            if (dgta.ExampleDataSetInstances != null && dgta.ExampleDataSetInstances.Count > 0)
            {
                var setValues = "";
                foreach (var set in dgta.ExampleDataSetInstances)
                    setValues += set.ExampleDataSet.Name + ", ";

                if (setValues.EndsWith(", "))
                    setValues = setValues.Substring(0, setValues.Length - 2);

                response += CreateBadgeHtml("Data set(s)", setValues);
            }

            if (dgta.MinNumber.HasValue)
                response += CreateBadgeHtml("Min", dgta.MinNumber.Value.ToString("N0"));

            if (dgta.MaxNumber.HasValue)
                response += CreateBadgeHtml("Max", dgta.MaxNumber.Value.ToString("N0"));

            if (dgta.WeightedStringValues != null && dgta.WeightedStringValues.Count > 0)
            {
                string weightedStringValues = "";
                foreach (var wsv in dgta.WeightedStringValues)
                    weightedStringValues += $"{wsv.Value}: {wsv.Weight}, ";

                weightedStringValues = weightedStringValues.Substring(0, weightedStringValues.Length -2);
                response += CreateBadgeHtml("Weighted Values", weightedStringValues);
            }
        }
        else if (dgta.MetaverseAttribute?.Type == AttributeDataType.Number)
        {
            if (dgta.MinNumber.HasValue)
                response += CreateBadgeHtml("Min", dgta.MinNumber.Value.ToString("N0"));

            if (dgta.MaxNumber.HasValue)
                response += CreateBadgeHtml("Max", dgta.MaxNumber.Value.ToString("N0"));

            if (dgta.SequentialNumbers.HasValue)
                response += CreateBadgeHtml("Sequential", dgta.SequentialNumbers.Value.ToString());

            if (dgta.RandomNumbers.HasValue)
                response += CreateBadgeHtml("Random", dgta.RandomNumbers.Value.ToString());
        }
        else if (dgta.MetaverseAttribute?.Type == AttributeDataType.Bool)
        {
            if (dgta.BoolShouldBeRandom.HasValue)
                response += CreateBadgeHtml("Random", dgta.BoolShouldBeRandom.Value.ToString());

            if (dgta.BoolTrueDistribution.HasValue)
                response += CreateBadgeHtml("True distribution", dgta.BoolTrueDistribution.Value.ToString("N0"));
        }
        else if (dgta.MetaverseAttribute?.Type == AttributeDataType.DateTime && (dgta.MinDate.HasValue || dgta.MaxDate.HasValue))
        {
            if (dgta.MinDate.HasValue)
                response += CreateBadgeHtml("Min", dgta.MinDate.Value.ToShortDateString());

            if (dgta.MaxDate.HasValue)
                response += CreateBadgeHtml("Min", dgta.MaxDate.Value.ToShortDateString());
        }
        else if (dgta.MetaverseAttribute?.Type == AttributeDataType.Reference)
        {
            if (dgta.MvaRefMinAssignments.HasValue)
                response += CreateBadgeHtml("MVA min assignments", dgta.MvaRefMinAssignments.Value.ToString("N0"));

            if (dgta.MvaRefMaxAssignments.HasValue)
                response += CreateBadgeHtml("MVA max assignments", dgta.MvaRefMaxAssignments.Value.ToString("N0"));

            if (dgta.ReferenceMetaverseObjectTypes != null && dgta.ReferenceMetaverseObjectTypes.Count > 0)
            {
                var refTypes = "";
                foreach (var refType in dgta.ReferenceMetaverseObjectTypes)
                    refTypes += refType.Name + ", ";

                if (refTypes.EndsWith(", "))
                    refTypes = refTypes.Substring(0, refTypes.Length - 2);

                response += CreateBadgeHtml("Reference type(s)", refTypes);
            }

            if (dgta.ManagerDepthPercentage.HasValue)
                response += CreateBadgeHtml("Manager depth", dgta.ManagerDepthPercentage + "%");
        }

        return response;
    }

    private string CreateBadgeHtml(string prefix, string value)
    {
        return "<span class=\"badge badge-bigger bg-secondary inline me-2\"><span class=\"fw-normal\">" + prefix + ":</span> " + value + "</span>";
    }

    private async Task ExecuteTemplateAsync()
    {
        if (template == null)
            return;

        task = new DataGenerationTemplateServiceTask(template.Id);
        await Jim.Tasking.CreateServiceTaskAsync(task);
    }
}