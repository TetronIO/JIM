@page "/activity"
@attribute [Authorize(Roles = "Users")]
@using JIM.Application
@using JIM.Models.Activities
@using JIM.Models.Utility;
@using JIM.Utilities;
@inject JimApplication Jim

<PageTitle>Activity</PageTitle>

<MudText Typo="Typo.h4">Activity</MudText>
<MudText Typo="Typo.subtitle1">
    See what JIM has been used for here. Everything that happens in JIM is tracked by an Activity. 
    Activities can be initiated by an individual, or by the system via automation in response to synchronisation schedules, workflows, etc.
</MudText>

@if (activities != null)
{
    <ActivityItemPaginator Results="@activities" />

    <MudTable T="JIM.Models.Activities.Activity" Items="@activities.Results" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm" Class="mt-5" Outlined="true" Elevation="0">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Target</MudTh>
            <MudTh>Operation</MudTh>
            <MudTh>Created</MudTh>
            <MudTh>Initiated By</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Completion Time</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Name">
                <MudLink Href="@($"/activity/{context.Id}")">@context.TargetName</MudLink>
            </MudTd>
            <MudTd DataLabel="Target"><MudText Class="mud-text-secondary">@context.TargetType.ToString().SplitOnCapitalLetters()</MudText></MudTd>
            <MudTd DataLabel="Operation"><MudText Class="mud-text-secondary">@context.TargetOperationType</MudText></MudTd>
            <MudTd DataLabel="Created"><MudText Class="mud-text-secondary">@context.Created</MudText></MudTd>
            <MudTd DataLabel="Initiated By">
                @if (context.InitiatedBy != null)
                {
                    <MudLink Href="@Utilities.GetMetaverseObjectHref(context.InitiatedBy)">@Utilities.GetMetaverseObjectHrefText(context.InitiatedBy)</MudLink>
                }
                else if (!string.IsNullOrEmpty(context.InitiatedByName))
                {
                    @context.InitiatedByName
                }
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip Variant="Variant.Text" Color="Helpers.GetActivityMudBlazorColorForStatus(context.Status)">@context.Status.ToString().SplitOnCapitalLetters()</MudChip>
            </MudTd>
            <MudTd DataLabel="Completion Time"><MudText Class="mud-text-secondary">@context.CompletionTime</MudText></MudTd>
        </RowTemplate>
        <NoRecordsContent>
            There is no activity to show yet.
        </NoRecordsContent>
    </MudTable>
}

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "p")]
    public int? Page { get; set; }
    
    private PagedResultSet<JIM.Models.Activities.Activity>? activities;

    protected override async Task OnParametersSetAsync()
    {
        if (Page == null || Page < 1)
            Page = 1;

        activities = await Jim.Activities.GetActivitiesAsync(Page.Value, 20, 500);
    }
}