#!/bin/bash
set -e

echo "ğŸš€ Setting up JIM development environment..."
echo ""

# Color codes for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_step() {
    echo -e "${BLUE}â–¶${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# 1. Install .NET EF Core tools
print_step "Installing .NET Entity Framework Core tools..."
# Clean up any corrupted tool state first, then install fresh
# This handles cases where the tool cache becomes corrupted after container rebuilds
rm -rf ~/.dotnet/tools/dotnet-ef ~/.dotnet/tools/.store/dotnet-ef 2>/dev/null || true
# Use explicit version to avoid "Settings file not found" errors with latest package
if dotnet tool install --global dotnet-ef --version 9.0.0; then
    print_success "dotnet-ef 9.0.0 installed globally"
else
    print_warning "dotnet-ef installation failed - you may need to install manually: dotnet tool install --global dotnet-ef --version 9.0.0"
fi

# Add .NET tools to PATH
export PATH="$PATH:$HOME/.dotnet/tools"
echo 'export PATH="$PATH:$HOME/.dotnet/tools"' >> ~/.zshrc
echo 'export PATH="$PATH:$HOME/.dotnet/tools"' >> ~/.bashrc

# 2. Restore NuGet packages
print_step "Restoring NuGet packages..."
dotnet restore JIM.sln --verbosity quiet
print_success "NuGet packages restored"

# 3. Create .env file
print_step "Creating .env file..."

# Check if .env already exists
if [ -f .env ]; then
    print_warning ".env file already exists, skipping creation"
else
    # Check for GitHub Codespaces secrets
    if [ -n "$DOTENV_BASE64" ]; then
        # Restore from base64-encoded secret
        echo "$DOTENV_BASE64" | base64 -d > .env
        print_success ".env restored from GitHub Codespaces secret (DOTENV_BASE64)"
    else
        # Create .env with defaults and any available secrets
        cat > .env << EOF
# JIM Development Environment Configuration
# Auto-generated by .devcontainer/setup.sh

# Database Configuration (matches db.yml)
JIM_DB_NAME=jim
JIM_DB_USERNAME=jim
JIM_DB_PASSWORD=${JIM_DB_PASSWORD:-password}
JIM_DB_LOG_SENSITIVE_INFO=${JIM_DB_LOG_SENSITIVE_INFO:-false}

# SSO/OIDC Configuration
# IMPORTANT: These are development defaults. For real SSO, set GitHub Codespaces secrets.
JIM_SSO_AUTHORITY=${JIM_SSO_AUTHORITY:-https://login.microsoftonline.com/your-tenant-id/v2.0}
JIM_SSO_CLIENT_ID=${JIM_SSO_CLIENT_ID:-jim-dev-client-id}
JIM_SSO_SECRET=${JIM_SSO_SECRET:-dev-secret-change-me}
JIM_SSO_CLAIM_TYPE=${JIM_SSO_CLAIM_TYPE:-preferred_username}
JIM_SSO_MV_ATTRIBUTE=${JIM_SSO_MV_ATTRIBUTE:-userPrincipalName}
JIM_SSO_INITIAL_ADMIN=${JIM_SSO_INITIAL_ADMIN:-admin@example.com}

# Logging
JIM_LOG_LEVEL=${JIM_LOG_LEVEL:-Information}
JIM_LOG_PATH=${JIM_LOG_PATH:-/var/log/jim}
JIM_LOG_REQUESTS=${JIM_LOG_REQUESTS:-true}
EOF
        print_success ".env created with development defaults"
        print_warning "Remember to update SSO settings for real authentication!"
    fi
fi

# 4. Wait for PostgreSQL to be ready
print_step "Waiting for PostgreSQL database to be ready..."
MAX_RETRIES=30
RETRY_COUNT=0
until docker compose -f db.yml exec -T jim.database pg_isready -U jim > /dev/null 2>&1 || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
    RETRY_COUNT=$((RETRY_COUNT+1))
    echo -n "."
    sleep 1
done
echo ""

if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
    print_warning "PostgreSQL didn't start in time, you may need to start it manually: docker compose -f db.yml up -d"
else
    print_success "PostgreSQL is ready"
fi

# 5. Apply Entity Framework migrations
print_step "Applying Entity Framework migrations..."
if [ $RETRY_COUNT -ne $MAX_RETRIES ]; then
    # Set connection string for migrations
    export ConnectionStrings__DefaultConnection="Host=localhost;Database=jim;Username=jim;Password=${JIM_DB_PASSWORD:-password}"

    if dotnet ef database update --project JIM.PostgresData --no-build 2>/dev/null; then
        print_success "Database migrations applied successfully"
    else
        print_warning "Could not apply migrations (database might not be ready). Run manually: dotnet ef database update --project JIM.PostgresData"
    fi
else
    print_warning "Skipping migrations (database not ready)"
fi

# 6. Build the solution
print_step "Building JIM solution..."
if dotnet build JIM.sln --verbosity quiet --no-restore; then
    print_success "Solution built successfully"
else
    print_warning "Build had warnings or errors. Run 'dotnet build JIM.sln' to see details."
fi

# 7. Create connector-files directory with symlink to test data
print_step "Setting up connector-files directory..."
mkdir -p connector-files

# Create symlink to test/Data directory (dynamic - new files appear automatically)
if [ ! -L connector-files/test-data ]; then
    if [ -d "test/Data" ]; then
        ln -s "$(pwd)/test/Data" connector-files/test-data
        print_success "Symlink created: connector-files/test-data -> test/Data"
    else
        print_warning "test/Data directory not found, skipping symlink"
    fi
else
    print_success "Symlink already exists: connector-files/test-data"
fi

# 8. Configure Git SSH commit signing
print_step "Configuring Git SSH commit signing..."

# Check if SSH agent has keys forwarded
if ssh-add -l &>/dev/null; then
    # Get the first SSH key from the agent
    SSH_KEY=$(ssh-add -L | head -1)

    if [ -n "$SSH_KEY" ]; then
        # Configure git to use SSH signing
        git config --global gpg.format ssh
        git config --global commit.gpgsign true
        git config --global user.signingkey "key::$SSH_KEY"

        # Create allowed_signers file for local verification
        # Uses the git user email (if configured) or a placeholder
        GIT_EMAIL=$(git config --global user.email || echo "developer@local")
        mkdir -p ~/.ssh
        echo "$GIT_EMAIL $SSH_KEY" > ~/.ssh/allowed_signers
        git config --global gpg.ssh.allowedSignersFile ~/.ssh/allowed_signers

        print_success "Git SSH signing configured (key from SSH agent)"
    else
        print_warning "SSH agent has no keys - commit signing not configured"
    fi
else
    print_warning "SSH agent not available - commit signing not configured"
    print_warning "To enable signing, ensure SSH agent forwarding is working"
fi

# 9. Create useful shell aliases
print_step "Creating shell aliases..."

# Add source line to .zshrc if not already present
if ! grep -q "source.*jim-aliases.sh" ~/.zshrc; then
    echo "" >> ~/.zshrc
    echo "# Source JIM development aliases" >> ~/.zshrc
    echo "if [ -f \"\$HOME/.devcontainer/jim-aliases.sh\" ]; then" >> ~/.zshrc
    echo "    source \"\$HOME/.devcontainer/jim-aliases.sh\"" >> ~/.zshrc
    echo "elif [ -f \"/workspaces/JIM/.devcontainer/jim-aliases.sh\" ]; then" >> ~/.zshrc
    echo "    source \"/workspaces/JIM/.devcontainer/jim-aliases.sh\"" >> ~/.zshrc
    echo "fi" >> ~/.zshrc
    print_success "Shell aliases configured (restart terminal or run: source ~/.zshrc)"
else
    print_success "Shell aliases already configured"
fi

# Also add to .bashrc for bash users
if ! grep -q "source.*jim-aliases.sh" ~/.bashrc; then
    echo "" >> ~/.bashrc
    echo "# Source JIM development aliases" >> ~/.bashrc
    echo "if [ -f \"\$HOME/.devcontainer/jim-aliases.sh\" ]; then" >> ~/.bashrc
    echo "    source \"\$HOME/.devcontainer/jim-aliases.sh\"" >> ~/.bashrc
    echo "elif [ -f \"/workspaces/JIM/.devcontainer/jim-aliases.sh\" ]; then" >> ~/.bashrc
    echo "    source \"/workspaces/JIM/.devcontainer/jim-aliases.sh\"" >> ~/.bashrc
    echo "fi" >> ~/.bashrc
fi

# 10. Display useful information
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${GREEN}âœ“ JIM Development Environment Ready!${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“š Quick Start Commands:"
echo "  jim                â†’ List all available jim aliases"
echo "  jim-compile        â†’ Build the entire solution"
echo "  jim-test           â†’ Run all tests"
echo "  jim-web            â†’ Run the Blazor web application (local, debuggable)"
echo "  jim-db             â†’ Start PostgreSQL database only"
echo ""
echo "ğŸ³ Docker Stack Commands:"
echo "  jim-stack          â†’ Start Docker stack (uses existing images)"
echo "  jim-stack-logs     â†’ View Docker stack logs"
echo "  jim-stack-down     â†’ Stop Docker stack"
echo ""
echo "ğŸ”¨ Docker Builds (rebuild services):"
echo "  jim-build          â†’ Build all services + start"
echo "  jim-build-web      â†’ Build jim.web + start"
echo "  jim-build-worker   â†’ Build jim.worker + start"
echo "  jim-build-scheduler â†’ Build jim.scheduler + start"
echo ""
echo "ğŸ”„ Reset:"
echo "  jim-reset          â†’ Reset JIM (delete database & logs volumes)"
echo ""
echo "ğŸ”§ Database Commands:"
echo "  jim-migrate        â†’ Apply pending migrations"
echo "  jim-migration [N]  â†’ Create a new migration"
echo "  jim-db-logs        â†’ View database logs"
echo "  jim-adminer        â†’ Get Adminer URL"
echo ""
echo "ğŸŒ Available Services:"
echo "  PostgreSQL:        localhost:5432"
echo "  Adminer:           http://localhost:8080"
echo ""
echo "  When running locally (F5):"
echo "    JIM Web:         https://localhost:7000"
echo "    JIM API:         https://localhost:7203"
echo ""
echo "  When running Docker stack:"
echo "    JIM Web:         http://localhost:5200"
echo "    JIM API:         http://localhost:5202"
echo ""
echo "ğŸ“– Documentation:"
echo "  Developer Guide:   docs/DEVELOPER_GUIDE.md"
echo "  Quick Reference:   CLAUDE.md"
echo ""
echo "ğŸš€ To start developing (choose one):"
echo ""
echo "  Option 1 - Local Debug (Recommended):"
echo "    1. Press F5 in VS Code"
echo "    2. Select 'JIM Full Stack' or 'JIM Web Stack'"
echo "    3. Set breakpoints and debug"
echo ""
echo "  Option 2 - Docker Stack:"
echo "    1. Review .env file and update SSO settings"
echo "    2. Run: jim-stack"
echo "    3. Open: http://localhost:5200"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
