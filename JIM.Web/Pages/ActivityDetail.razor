@page "/activity/{Id:guid}"
@attribute [Authorize(Roles = "User")]
@using JIM.Application
@using JIM.Models.Activities;
@using JIM.Models.Activities.DTOs;
@using JIM.Models.Core.DTOs;
@using JIM.Models.Enums;
@using JIM.Models.Staging.DTOs
@using JIM.Models.Utility;
@using JIM.Utilities;
@inject JimApplication Jim
@inject NavigationManager NavManager

<PageTitle>Activity: @_activity?.TargetOperationType @_activity?.TargetType.ToString().SplitOnCapitalLetters(): @_activity?.TargetName</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-secondary-text">Activity:</span> @_activity?.TargetOperationType @_activity?.TargetType.ToString().SplitOnCapitalLetters(): <span class="mud-primary-text">@(!string.IsNullOrEmpty(_activity?.TargetName) ? _activity?.TargetName : "(no name)")</span></MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>

@if (_activity != null)
{
    <MudText Typo="Typo.h5" Class="mt-5">Details</MudText>
    <MudPaper Class="pa-5 mt-5" Outlined="true">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">ID:</MudText>
                <MudText Class="mud-text-secondary jim-text-code">@_activity.Id</MudText>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Target:</MudText>
                <MudText Class="mud-text-secondary">
                    @switch (_activity.TargetType)
                    {
                        case ActivityTargetType.DataGenerationTemplate:
                            <MudLink Href="@($"/admin/example-data/templates/{_activity.DataGenerationTemplateId}")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.ConnectedSystem:
                            <MudLink Href="@($"/admin/connected-systems/{_activity.ConnectedSystemId}/")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.ConnectedSystemRunProfile when _connectedSystemHeader != null:
                            <MudLink Href="@($"/admin/connected-systems/{_activity.ConnectedSystemId}/")">@_connectedSystemHeader.Name</MudLink> @:/ @_activity.TargetName
                            break;
                        case ActivityTargetType.MetaverseObject when _metaverseObjectHeader != null:
                            <MudLink Href="@Utilities.GetMetaverseObjectHref(_metaverseObjectHeader)">@Utilities.GetMetaverseObjectHrefText(_metaverseObjectHeader)</MudLink>
                            break;
                        case ActivityTargetType.SyncRule:
                            <MudLink Href="@($"/admin/connected-systems/sync-rules/{_activity.SyncRuleId}")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.TrustedCertificate:
                            <MudLink Href="/admin/certificates">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.MetaverseAttribute:
                            <MudLink Href="/admin/schema/metaverse">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.ObjectMatchingRule:
                        case ActivityTargetType.NotSet:
                        default:
                            @(_activity.TargetName ?? "-")
                            break;
                    }
                </MudText>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">When:</MudText>
                <MudText Class="mud-text-secondary" title="@_activity.Created.ToLocalTime().ToFriendlyDate()">@_activity.Created.ToLocalTime().ToRelativeTime()</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Initiated By:</MudText>
                @{
                    if (_activity.InitiatedByType == ActivityInitiatorType.User && _activity.InitiatedByMetaverseObject != null)
                    {
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            <MudLink Href="@Utilities.GetMetaverseObjectHref(_activity.InitiatedByMetaverseObject)">@Utilities.GetMetaverseObjectHrefText(_activity.InitiatedByMetaverseObject)</MudLink>
                        </MudText>
                    }
                    else if (_activity.InitiatedByType == ActivityInitiatorType.ApiKey)
                    {
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                            @if (_activity.InitiatedById.HasValue)
                            {
                                <MudLink Href="@Utilities.GetApiKeyHref(_activity.InitiatedById.Value)">@_activity.InitiatedByName</MudLink>
                            }
                            else
                            {
                                <span>@_activity.InitiatedByName</span>
                            }
                        </MudText>
                    }
                    else if (!string.IsNullOrEmpty(_activity.InitiatedByName))
                    {
                        <MudText>@_activity.InitiatedByName</MudText>
                    }
                }
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Status:</MudText><br />
                <MudChip T="string" Variant="Variant.Text" Color="Helpers.GetActivityMudBlazorColorForStatus(_activity.Status)" Class="ml-0">@_activity.Status.ToString().SplitOnCapitalLetters()</MudChip>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Execution Time:</MudText>
                <MudText Class="mud-text-secondary">@(_activity.ExecutionTime?.ToAbbreviatedString() ?? "-")</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button">Total Activity Time:</MudText>
                <MudText Class="mud-text-secondary">@(_activity.TotalActivityTime?.ToAbbreviatedString() ?? "-")</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (!string.IsNullOrEmpty(_activity.ErrorMessage) || !string.IsNullOrEmpty(_activity.ErrorStackTrace))
    {
        <MudPaper Class="pa-4 mt-4" Style="@($"color:{Colors.Shades.White}; background:{Colors.Red.Default};")" Outlined="true">
            @if (!string.IsNullOrEmpty(_activity.ErrorMessage))
            {
                <MudText Typo="Typo.button">Error Message:</MudText>
                <MudText>@_activity.ErrorMessage</MudText>
                <br />
            }

            @if (!string.IsNullOrEmpty(_activity.ErrorStackTrace))
            {
                <MudText Typo="Typo.button">Error Stack:</MudText>
                <pre style="white-space: pre-wrap; word-wrap: break-word; overflow-x: auto; max-width: 100%;">@_activity.ErrorStackTrace</pre>
            }
        </MudPaper>
    }

    @if (_activity.TargetType == ActivityTargetType.ConnectedSystemRunProfile && _activity.TargetOperationType == ActivityTargetOperationType.Execute)
    {
        @if (_activityRunProfileExecutionStats != null)
        {
            <MudText Typo="Typo.h5" Class="mt-5">Synchronisation Results</MudText>
            <MudStack Row="true" Class="mt-5 mb-5">

                <MudPaper Class="pa-5" Outlined="true">
                    <MudText Typo="Typo.button">Total Objects</MudText>
                    <MudText Typo="Typo.h3">@_activityRunProfileExecutionStats.TotalObjectChangeCount.ToString("N0")</MudText>
                </MudPaper>

                <MudPaper Class="pa-5" Outlined="true">
                    <MudText Typo="Typo.button">Objects Created</MudText>
                    <MudText Typo="Typo.h3">@_activityRunProfileExecutionStats.TotalObjectCreates.ToString("N0")</MudText>
                </MudPaper>

                <MudPaper Class="pa-5" Outlined="true">
                    <MudText Typo="Typo.button">Objects Updated</MudText>
                    <MudText Typo="Typo.h3">@_activityRunProfileExecutionStats.TotalObjectUpdates.ToString("N0")</MudText>
                </MudPaper>

                <MudPaper Class="pa-5" Outlined="true">
                    <MudText Typo="Typo.button">Objects Deleted</MudText>
                    <MudText Typo="Typo.h3">@_activityRunProfileExecutionStats.TotalObjectDeletes.ToString("N0")</MudText>
                </MudPaper>

                @if (_activityRunProfileExecutionStats.TotalMvoNoAttributeChanges > 0 || _activityRunProfileExecutionStats.TotalCsoAlreadyCurrent > 0)
                {
                    <MudPaper Class="pa-5" Outlined="true" Style="@($"color:{Colors.Blue.Default};")">
                        <MudText Typo="Typo.button">MVO No Changes</MudText>
                        <MudText Typo="Typo.h3">@_activityRunProfileExecutionStats.TotalMvoNoAttributeChanges.ToString("N0")</MudText>
                    </MudPaper>

                    <MudPaper Class="pa-5" Outlined="true" Style="@($"color:{Colors.Blue.Default};")">
                        <MudText Typo="Typo.button">CSO Already Current</MudText>
                        <MudText Typo="Typo.h3">@_activityRunProfileExecutionStats.TotalCsoAlreadyCurrent.ToString("N0")</MudText>
                    </MudPaper>
                }

                <MudPaper Class="pa-5" Outlined="true">
                    <MudText Typo="Typo.button">Object Types</MudText>
                    <MudText Typo="Typo.h3">@_activityRunProfileExecutionStats.TotalObjectTypes.ToString("N0")</MudText>
                </MudPaper>

                <MudPaper Class="pa-5" Outlined="true" Style="@(_activityRunProfileExecutionStats.TotalObjectErrors > 0 ? $"color:{Colors.Red.Lighten5}; background:{Colors.Red.Default};" : null)">
                    <MudText Typo="Typo.button">Errors</MudText>
                    <MudText Typo="Typo.h3">@_activityRunProfileExecutionStats.TotalObjectErrors.ToString("N0")</MudText>
                </MudPaper>

            </MudStack>
        }

        @* Change Type Filter Chips - only show when there are items to filter *@
        @if (GetAvailableChangeTypes().Any())
        {
            <MudText Typo="Typo.body2" Class="mud-text-secondary mb-2">Filter by change type:</MudText>
            <MudChipSet T="ObjectChangeType"
                        SelectionMode="SelectionMode.MultiSelection"
                        SelectedValues="_selectedChangeTypes"
                        SelectedValuesChanged="OnChangeTypeFilterChanged"
                        Class="mb-3">
                @foreach (var changeType in GetAvailableChangeTypes())
                {
                    <MudChip Value="@changeType"
                             Color="@Helpers.GetRunItemMudBlazorColorForType(changeType)"
                             Variant="@(IsChangeTypeSelected(changeType) ? Variant.Filled : Variant.Outlined)"
                             SelectedColor="@Helpers.GetRunItemMudBlazorColorForType(changeType)">
                        @changeType.ToString().SplitOnCapitalLetters()
                        @if (GetChangeTypeCount(changeType) is var count && count > 0)
                        {
                            <MudText Typo="Typo.caption" Class="ml-1">(@count.ToString("N0"))</MudText>
                        }
                    </MudChip>
                }
            </MudChipSet>
        }

        <MudTable @ref="_table"
                  T="ActivityRunProfileExecutionItemHeader"
                  ServerData="ServerReload"
                  Hover="true"
                  Dense="true"
                  Breakpoint="Breakpoint.Sm"
                  Class="mt-3 mb-5"
                  Outlined="true"
                  Elevation="0"
                  OnRowClick="HandleRowClick"
                  RowClass="cursor-pointer"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary">
            <ToolBarContent>
                <MudSpacer />
                <MudTextField T="string"
                              ValueChanged="@(s => OnSearch(s))"
                              Placeholder="Search name, external ID, or object type"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Medium"
                              Class="mt-0"
                              Style="min-width: 300px;" />
            </ToolBarContent>
            <HeaderContent>
                <MudTh>
                    <MudTableSortLabel SortLabel="id" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">Internal Id</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="externalid" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">External Id</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="displayname" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">Name</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="objecttype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">External Object Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="changetype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">Change Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="errortype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button">Error Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Internal Id"><MudLink Href="@($"/activity/sync/{context.Id}")">@context.Id</MudLink></MudTd>
                <MudTd DataLabel="External Id" class="jim-text-code">@(!string.IsNullOrEmpty(context.ExternalIdValue) ? context.ExternalIdValue : "-")</MudTd>
                <MudTd DataLabel="Display Name">@(!string.IsNullOrEmpty(context.DisplayName) ? context.DisplayName : "-")</MudTd>
                <MudTd DataLabel="External Object Type">@(context.ConnectedSystemObjectType != null ? context.ConnectedSystemObjectType.ToString().SplitOnCapitalLetters() : "-")</MudTd>
                <MudTd DataLabel="Change Type">
                    <MudChip T="string" Variant="Variant.Text" Color="Helpers.GetRunItemMudBlazorColorForType(context.ObjectChangeType)">@context.ObjectChangeType.ToString().SplitOnCapitalLetters()</MudChip>
                </MudTd>
                <MudTd DataLabel="Error Type">
                    @if (context.ErrorType != null && context.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
                    {
                        <MudChip T="string" Variant="Variant.Text" Color="Color.Error">@context.ErrorType.Value.ToString().SplitOnCapitalLetters()</MudChip>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                @if (string.IsNullOrWhiteSpace(_searchString))
                {
                    <MudText>There are no sync results to show.</MudText>
                }
                else
                {
                    <MudText>No sync results found matching "@_searchString".</MudText>
                }
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private MudTable<ActivityRunProfileExecutionItemHeader>? _table;
    private Activity? _activity;
    private ConnectedSystemHeader? _connectedSystemHeader;
    private MetaverseObjectHeader? _metaverseObjectHeader;
    private ActivityRunProfileExecutionStats? _activityRunProfileExecutionStats;
    private string _searchString = "";
    private bool _loading;

    // Change type filter - when chips are selected, the table reloads with the filter applied
    private IReadOnlyCollection<ObjectChangeType> _selectedChangeTypes = new List<ObjectChangeType>();

    private readonly List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new("Home", href: "/", icon: Icons.Material.Filled.Home),
        new("Activity", href: "/activity"),
        new("Activity Detail", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        _activity = await Jim.Activities.GetActivityAsync(Id);
        if (_activity == null)
        {
            NavManager.NavigateTo("../");
            return;
        }

        if (_activity.ConnectedSystemId.HasValue)
            _connectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(_activity.ConnectedSystemId.Value);

        if (_activity.TargetType is ActivityTargetType.MetaverseObject or ActivityTargetType.ConnectedSystemRunProfile && _activity.MetaverseObjectId != null)
            _metaverseObjectHeader = await Jim.Metaverse.GetMetaverseObjectHeaderAsync(_activity.MetaverseObjectId.Value);

        if (_activity.TargetType == ActivityTargetType.ConnectedSystemRunProfile && _activity.TargetOperationType == ActivityTargetOperationType.Execute)
            _activityRunProfileExecutionStats = await Jim.Activities.GetActivityRunProfileExecutionStatsAsync(_activity.Id);
    }

    private async Task<TableData<ActivityRunProfileExecutionItemHeader>> ServerReload(TableState state, CancellationToken token)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Convert MudBlazor's 0-indexed page to our 1-indexed page
            var page = state.Page + 1;
            var sortDescending = state.SortDirection == SortDirection.Descending;

            // Get selected change types for filtering (null means show all)
            IEnumerable<ObjectChangeType>? changeTypeFilter = _selectedChangeTypes.Count > 0 ? _selectedChangeTypes : null;

            var result = await Jim.Activities.GetActivityRunProfileExecutionItemHeadersAsync(
                Id,
                page,
                state.PageSize,
                string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                state.SortLabel,
                sortDescending,
                changeTypeFilter);

            return new TableData<ActivityRunProfileExecutionItemHeader>
            {
                TotalItems = result.TotalResults,
                Items = result.Results
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _table?.ReloadServerData();
    }

    private void OnChangeTypeFilterChanged(IReadOnlyCollection<ObjectChangeType> selectedTypes)
    {
        _selectedChangeTypes = selectedTypes;
        _table?.ReloadServerData();
    }

    private void HandleRowClick(TableRowClickEventArgs<ActivityRunProfileExecutionItemHeader> args)
    {
        if (_loading || args.Item == null)
            return;

        NavManager.NavigateTo($"/activity/sync/{args.Item.Id}");
    }

    /// <summary>
    /// Returns the change types that have at least one RPEI in this activity.
    /// Shows all possible change types with non-zero counts first, ordered logically.
    /// </summary>
    private IEnumerable<ObjectChangeType> GetAvailableChangeTypes()
    {
        if (_activityRunProfileExecutionStats == null)
            return Enumerable.Empty<ObjectChangeType>();

        // Return change types in logical order: Import → Sync → Export → Other
        var availableTypes = new List<ObjectChangeType>();

        // Import operations
        if (_activityRunProfileExecutionStats.TotalCsoAdds > 0)
            availableTypes.Add(ObjectChangeType.Add);
        if (_activityRunProfileExecutionStats.TotalCsoUpdates > 0)
            availableTypes.Add(ObjectChangeType.Update);
        if (_activityRunProfileExecutionStats.TotalCsoDeletes > 0)
            availableTypes.Add(ObjectChangeType.Delete);

        // Sync operations
        if (_activityRunProfileExecutionStats.TotalProjections > 0)
            availableTypes.Add(ObjectChangeType.Projected);
        if (_activityRunProfileExecutionStats.TotalJoins > 0)
            availableTypes.Add(ObjectChangeType.Joined);
        if (_activityRunProfileExecutionStats.TotalAttributeFlows > 0)
            availableTypes.Add(ObjectChangeType.AttributeFlow);
        if (_activityRunProfileExecutionStats.TotalDisconnections > 0)
            availableTypes.Add(ObjectChangeType.Disconnected);

        // Export operations
        if (_activityRunProfileExecutionStats.TotalProvisioned > 0)
            availableTypes.Add(ObjectChangeType.Provisioned);
        if (_activityRunProfileExecutionStats.TotalExported > 0)
            availableTypes.Add(ObjectChangeType.Exported);
        if (_activityRunProfileExecutionStats.TotalDeprovisioned > 0)
            availableTypes.Add(ObjectChangeType.Deprovisioned);

        // Other
        if (_activityRunProfileExecutionStats.TotalNoChanges > 0)
            availableTypes.Add(ObjectChangeType.NoChange);

        return availableTypes;
    }

    /// <summary>
    /// Gets the count of RPEIs for a specific change type from the stats.
    /// </summary>
    private int GetChangeTypeCount(ObjectChangeType changeType)
    {
        if (_activityRunProfileExecutionStats == null)
            return 0;

        return changeType switch
        {
            ObjectChangeType.Add => _activityRunProfileExecutionStats.TotalCsoAdds,
            ObjectChangeType.Update => _activityRunProfileExecutionStats.TotalCsoUpdates,
            ObjectChangeType.Delete => _activityRunProfileExecutionStats.TotalCsoDeletes,
            ObjectChangeType.Projected => _activityRunProfileExecutionStats.TotalProjections,
            ObjectChangeType.Joined => _activityRunProfileExecutionStats.TotalJoins,
            ObjectChangeType.AttributeFlow => _activityRunProfileExecutionStats.TotalAttributeFlows,
            ObjectChangeType.Disconnected => _activityRunProfileExecutionStats.TotalDisconnections,
            ObjectChangeType.Provisioned => _activityRunProfileExecutionStats.TotalProvisioned,
            ObjectChangeType.Exported => _activityRunProfileExecutionStats.TotalExported,
            ObjectChangeType.Deprovisioned => _activityRunProfileExecutionStats.TotalDeprovisioned,
            ObjectChangeType.NoChange => _activityRunProfileExecutionStats.TotalNoChanges,
            _ => 0
        };
    }

    /// <summary>
    /// Checks if a change type is currently selected in the filter.
    /// </summary>
    private bool IsChangeTypeSelected(ObjectChangeType changeType)
    {
        return _selectedChangeTypes.Contains(changeType);
    }
}
