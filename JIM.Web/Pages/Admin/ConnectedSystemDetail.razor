@page "/admin/connected-systems/{Id:int}"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.Core
@using JIM.Models.Logic
@using JIM.Models.Staging
@using JIM.Web.Pages.Admin.Components
@using JIM.Web.Shared
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>Connected System: @_connectedSystem?.Name</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-primary-text">Connected System:</span> @_connectedSystem?.Name</MudText>
<div class="d-flex justify-space-between align-center">
    <MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>
    @if (_connectedSystem != null)
    {
        <AuditInfo Entity="@_connectedSystem" />
    }
</div>

@if (_connectedSystem != null)
{
    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="false" PanelClass="pt-5" Class="mt-2" Outlined="true">

        <MudTabPanel Text="Details">
            <ConnectedSystemDetailsTab ConnectedSystem="_connectedSystem" PendingExportCount="_pendingExportCount" />
        </MudTabPanel>

        <MudTabPanel Text="Settings">
            <ConnectedSystemSettingsTab ConnectedSystem="_connectedSystem"
                                        SettingCategories="_settingCategories!"
                                        OnConnectedSystemChanged="ReloadConnectedSystemAsync" />
        </MudTabPanel>

        <MudTabPanel Text="Schema" Disabled="@AreSettingDependentTabsDisabled()">
            <ConnectedSystemSchemaTab ConnectedSystem="_connectedSystem"
                                      OnConnectedSystemChanged="ReloadConnectedSystemAsync" />
        </MudTabPanel>

        @if (_connectedSystem.ConnectorDefinition.SupportsPartitions)
        {
            <MudTabPanel Text="Partitions & Containers" Disabled="@AreSettingDependentTabsDisabled()">
                <ConnectedSystemPartitionsTab ConnectedSystem="_connectedSystem"
                                              PartitionsAndHierarchiesText="@_partitionsAndHierarchiesText"
                                              PartitionAndHierarchyText="@_partitionAndHierarchyText"
                                              OnConnectedSystemChanged="ReloadConnectedSystemAsync" />
            </MudTabPanel>
        }

        <MudTabPanel Text="Object Matching" Disabled="@IsObjectMatchingTabDisabled()">
            <ConnectedSystemObjectMatchingTab ConnectedSystem="_connectedSystem"
                                              MetaverseAttributes="_metaverseAttributes!" />
        </MudTabPanel>

        <MudTabPanel Text="Run Profiles" Disabled="@IsRunProfilesTabDisabled()">
            <ConnectedSystemRunProfilesTab ConnectedSystem="_connectedSystem" />
        </MudTabPanel>

        <MudTabPanel Text="Danger Zone" Icon="@Icons.Material.Filled.Warning" BadgeColor="Color.Error" ID="@("danger-zone")">
            <ConnectedSystemDangerZoneTab ConnectedSystem="_connectedSystem" />
        </MudTabPanel>

    </MudTabs>

}

@code {
    [Parameter]
    public int Id { get; set; }
    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }
    private ConnectedSystem? _connectedSystem;
    private List<ConnectedSystemSettingCategory>? _settingCategories;
    private string? _partitionsAndHierarchiesText;
    private string? _partitionAndHierarchyText;
    private int _pendingExportCount;
    private List<BreadcrumbItem> _breadcrumbs = null!;

    private IList<MetaverseAttribute>? _metaverseAttributes;


    protected override async Task OnInitializedAsync()
    {
        await LoadConnectedSystemAsync();
    }

    private async Task LoadConnectedSystemAsync()
    {
        _connectedSystem = await Jim.ConnectedSystems.GetConnectedSystemAsync(Id);
        if (_connectedSystem == null)
        {
            NavManager.NavigateTo("../");
            return;
        }

        _breadcrumbs =
        [
            new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
            new BreadcrumbItem("Connected Systems", href: "/admin/connected-systems/"),
            new BreadcrumbItem(_connectedSystem.Name, href: null, disabled: true)
        ];

        _settingCategories = _connectedSystem.SettingValues
            .Select(q => q.Setting.Category)
            .Distinct()
            .Where(category => ShouldShowCategory(category))
            .OrderBy(category => GetCategoryDisplayOrder(category))
            .ToList();

        if (_connectedSystem.ConnectorDefinition is { SupportsPartitions: true, SupportsPartitionContainers: true })
        {
            _partitionsAndHierarchiesText = "partitions and containers";
            _partitionAndHierarchyText = "partition and container";
        }
        else if (_connectedSystem.ConnectorDefinition.SupportsPartitions)
        {
            _partitionsAndHierarchiesText = "partitions";
            _partitionAndHierarchyText = "partition";
        }

        _pendingExportCount = await Jim.ConnectedSystems.GetPendingExportsCountAsync(Id);
        _metaverseAttributes ??= await Jim.Metaverse.GetMetaverseAttributesAsync();
    }

    private async Task ReloadConnectedSystemAsync()
    {
        await LoadConnectedSystemAsync();
        StateHasChanged();
    }

    private bool AreSettingDependentTabsDisabled()
    {
        if (_connectedSystem == null)
            return true;

        return !_connectedSystem.SettingValuesValid;
    }

    /// <summary>
    /// Determines whether a setting category should be displayed based on connector capabilities.
    /// </summary>
    private bool ShouldShowCategory(ConnectedSystemSettingCategory category)
    {
        if (_connectedSystem?.ConnectorDefinition == null)
            return true;

        return category switch
        {
            // Only show Import category if the connector supports full or delta import
            ConnectedSystemSettingCategory.Import =>
                _connectedSystem.ConnectorDefinition.SupportsFullImport ||
                _connectedSystem.ConnectorDefinition.SupportsDeltaImport,

            // Only show Export category if the connector supports export
            ConnectedSystemSettingCategory.Export =>
                _connectedSystem.ConnectorDefinition.SupportsExport,

            // Always show other categories
            _ => true
        };
    }

    /// <summary>
    /// Returns the display order for setting categories.
    /// Order: Import, Export, General, Schema, Connectivity, Capabilities
    /// </summary>
    private static int GetCategoryDisplayOrder(ConnectedSystemSettingCategory category)
    {
        return category switch
        {
            ConnectedSystemSettingCategory.Import => 0,
            ConnectedSystemSettingCategory.Export => 1,
            ConnectedSystemSettingCategory.General => 2,
            ConnectedSystemSettingCategory.Schema => 3,
            ConnectedSystemSettingCategory.Connectivity => 4,
            ConnectedSystemSettingCategory.Capabilities => 5,
            _ => 99
        };
    }

    private bool IsRunProfilesTabDisabled()
    {
        if (_connectedSystem == null)
            return true;

        // Disable if settings are invalid
        if (!_connectedSystem.SettingValuesValid)
            return true;

        // Disable if the connector supports partitions but none are selected (with containers if applicable)
        if (_connectedSystem.ConnectorDefinition.SupportsPartitions)
            return !_connectedSystem.HasPartitionsOrContainersSelected();

        return false;
    }

    private bool IsObjectMatchingTabDisabled()
    {
        if (_connectedSystem == null)
            return true;

        // Disable if settings are invalid
        if (!_connectedSystem.SettingValuesValid)
            return true;

        // Disable if the connector supports partitions but none are selected (with containers if applicable)
        if (_connectedSystem.ConnectorDefinition.SupportsPartitions)
            return !_connectedSystem.HasPartitionsOrContainersSelected();

        return false;
    }
}
