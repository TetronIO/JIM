@using JIM.Application
@using JIM.Models.Activities
@using JIM.Models.Staging
@using JIM.Models.Utility
@using JIM.Utilities
@using JIM.Web.Services
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject IUserPreferenceService PreferenceService
@implements IDisposable

@if (_preferencesLoaded)
{
    <MudTable @ref="_table" T="Activity" ServerData="ServerReload" @bind-CurrentPage="_currentPage"
              RowsPerPage="@_rowsPerPage" RowsPerPageChanged="OnRowsPerPageChanged"
              Hover="true" Dense="true" Breakpoint="Breakpoint.Sm"
              Outlined="true" Elevation="0" OnRowClick="HandleRowClick" RowClass="cursor-pointer"
              Loading="@_loading" LoadingProgressColor="Color.Primary">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Execution History</MudText>
            <MudSpacer />
            <MudTextField T="string" ValueChanged="@(s => OnSearch(s))" Placeholder="Search..."
                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium" Class="mt-0" Style="max-width: 300px;" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>
                <MudText Typo="Typo.button">Connected System</MudText>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="target" T="Activity">
                    <MudText Typo="Typo.button">Run Profile</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudText Typo="Typo.button">Stats</MudText>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="status" T="Activity">
                    <MudText Typo="Typo.button">Status</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="created" T="Activity" InitialDirection="SortDirection.Descending">
                    <MudText Typo="Typo.button">Executed</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="executiontime" T="Activity">
                    <MudText Typo="Typo.button">Duration</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="initiatedby" T="Activity">
                    <MudText Typo="Typo.button">Initiated By</MudText>
                </MudTableSortLabel>
            </MudTh>
        </HeaderContent>
        <RowTemplate Context="context">
            <MudTd DataLabel="Connected System">
                @if (!string.IsNullOrEmpty(context.TargetContext))
                {
                    @context.TargetContext
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-disabled">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Run Profile">
                @if (!string.IsNullOrEmpty(context.TargetName))
                {
                    @context.TargetName
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-disabled">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Stats">
                @if (context.Status != ActivityStatus.InProgress)
                {
                    @if (context.TotalObjectCreates > 0 || context.TotalObjectUpdates > 0 || context.TotalObjectFlows > 0 || context.TotalObjectDeletes > 0 || context.TotalObjectErrors > 0)
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            @if (context.TotalObjectCreates > 0)
                            {
                                <MudTooltip Text="@GetCreatesTooltip(context.ConnectedSystemRunType, context.TargetName)" Arrow="true" Placement="Placement.Top">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Text"
                                             Icon="@Icons.Material.Filled.Add" Class="px-2">
                                        @context.TotalObjectCreates
                                    </MudChip>
                                </MudTooltip>
                            }
                            @if (context.TotalObjectUpdates > 0)
                            {
                                <MudTooltip Text="@GetUpdatesTooltip(context.ConnectedSystemRunType, context.TargetName)" Arrow="true" Placement="Placement.Top">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text"
                                             Icon="@Icons.Material.Filled.Sync" Class="px-2">
                                        @context.TotalObjectUpdates
                                    </MudChip>
                                </MudTooltip>
                            }
                            @if (context.TotalObjectFlows > 0)
                            {
                                <MudTooltip Text="Attribute Flow" Arrow="true" Placement="Placement.Top">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text"
                                             Icon="@Icons.Material.Filled.SwapHoriz" Class="px-2">
                                        @context.TotalObjectFlows
                                    </MudChip>
                                </MudTooltip>
                            }
                            @if (context.TotalObjectDeletes > 0)
                            {
                                <MudTooltip Text="@GetDeletesTooltip(context.ConnectedSystemRunType, context.TargetName)" Arrow="true" Placement="Placement.Top">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Text"
                                             Icon="@Icons.Material.Filled.Delete" Class="px-2">
                                        @context.TotalObjectDeletes
                                    </MudChip>
                                </MudTooltip>
                            }
                            @if (context.TotalObjectErrors > 0)
                            {
                                <MudTooltip Text="Errors" Arrow="true" Placement="Placement.Top">
                                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Filled"
                                             Icon="@Icons.Material.Filled.Error" Class="px-2">
                                        @context.TotalObjectErrors
                                    </MudChip>
                                </MudTooltip>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudTooltip Text="No changes" Arrow="true" Placement="Placement.Top">
                            <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Text"
                                     Icon="@Icons.Material.Outlined.CheckCircle" Class="px-2">
                                0
                            </MudChip>
                        </MudTooltip>
                    }
                }
                else
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" Size="Size.Small" Style="width: 80px;" />
                }
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Variant="Variant.Text" Size="Size.Small"
                         Color="Helpers.GetActivityMudBlazorColorForStatus(context.Status)">
                    @context.Status.ToString().SplitOnCapitalLetters()
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Executed">
                <MudTooltip Text="@context.Executed.ToLocalTime().ToFriendlyDate()" Arrow="true" Placement="Placement.Top">
                    @context.Executed.ToLocalTime().ToRelativeTime()
                </MudTooltip>
            </MudTd>
            <MudTd DataLabel="Duration">
                @if (context.ExecutionTime.HasValue)
                {
                    @context.ExecutionTime.Value.ToCasualString()
                }
                else if (context.Status == ActivityStatus.InProgress)
                {
                    <MudText Typo="Typo.body2" Class="mud-text-disabled">Running...</MudText>
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-disabled">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Initiated By">
                @if (context.InitiatedByType == ActivityInitiatorType.User && context.InitiatedById != null)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                    <span>@context.InitiatedByName</span>
                }
                else if (context.InitiatedByType == ActivityInitiatorType.ApiKey)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                    <span>@context.InitiatedByName</span>
                }
                else if (context.InitiatedByType == ActivityInitiatorType.System)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mr-1" Style="vertical-align: middle;" />
                    <span>@(context.InitiatedByName ?? "Scheduler")</span>
                }
                else if (!string.IsNullOrEmpty(context.InitiatedByName))
                {
                    <span>@context.InitiatedByName</span>
                }
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            No execution history to display.
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}

@* Activity Detail Panel with Overlay *@
<MudOverlay @bind-Visible="_panelOpen" DarkBackground="true" AutoClose="true" ZIndex="1250" />
<div class="jim-activity-panel @(_panelOpen ? "jim-activity-panel-open" : "")">
    @if (_selectedActivity != null)
    {
        <div class="d-flex flex-column gap-4 pa-4" style="height: 100%; overflow-y: auto;">
            @* Header with close button *@
            <div class="d-flex justify-space-between align-center">
                <MudText Typo="Typo.h6">Execution Details</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@(() => _panelOpen = false)" />
            </div>

            @* Status *@
            <div class="d-flex gap-4 align-center flex-wrap">
                <MudChip T="string" Size="Size.Medium" Variant="Variant.Filled"
                         Color="Helpers.GetActivityMudBlazorColorForStatus(_selectedActivity.Status)">
                    @_selectedActivity.Status.ToString().SplitOnCapitalLetters()
                </MudChip>
            </div>

            @* Target Information *@
            <MudPaper Elevation="0" Class="pa-3" Outlined="true">
                <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Primary">Target</MudText>
                @if (!string.IsNullOrEmpty(_selectedActivity.TargetContext))
                {
                    <MudText Typo="Typo.body1"><strong>@_selectedActivity.TargetContext</strong> â†’ @_selectedActivity.TargetName</MudText>
                }
                else
                {
                    <MudText Typo="Typo.body1">@_selectedActivity.TargetName</MudText>
                }
                <MudText Typo="Typo.caption" Class="mud-text-secondary mt-1">
                    @_selectedActivity.TargetType.ToString().SplitOnCapitalLetters()
                </MudText>
            </MudPaper>

            @* Statistics *@
            @if (_selectedActivity.Status != ActivityStatus.InProgress)
            {
                <MudPaper Elevation="0" Class="pa-3" Outlined="true">
                    <MudText Typo="Typo.subtitle2" Class="mb-3" Color="Color.Primary">Statistics</MudText>
                    <MudStack Row="true" Spacing="3" Justify="Justify.SpaceEvenly">
                        <div class="text-center">
                            <MudText Typo="Typo.h5" Color="Color.Success">@_selectedActivity.TotalObjectCreates</MudText>
                            <MudText Typo="Typo.caption">Creates</MudText>
                        </div>
                        <div class="text-center">
                            <MudText Typo="Typo.h5" Color="Color.Info">@_selectedActivity.TotalObjectUpdates</MudText>
                            <MudText Typo="Typo.caption">Updates</MudText>
                        </div>
                        <div class="text-center">
                            <MudText Typo="Typo.h5" Color="Color.Info">@_selectedActivity.TotalObjectFlows</MudText>
                            <MudText Typo="Typo.caption">Flows</MudText>
                        </div>
                        <div class="text-center">
                            <MudText Typo="Typo.h5" Color="Color.Warning">@_selectedActivity.TotalObjectDeletes</MudText>
                            <MudText Typo="Typo.caption">Deletes</MudText>
                        </div>
                        <div class="text-center">
                            <MudText Typo="Typo.h5" Color="@(_selectedActivity.TotalObjectErrors > 0 ? Color.Error : Color.Default)">
                                @_selectedActivity.TotalObjectErrors
                            </MudText>
                            <MudText Typo="Typo.caption">Errors</MudText>
                        </div>
                    </MudStack>
                </MudPaper>
            }

            @* Timing *@
            <MudPaper Elevation="0" Class="pa-3" Outlined="true">
                <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Primary">Timing</MudText>
                <MudSimpleTable Dense="true" Hover="true">
                    <tbody>
                        <tr>
                            <td><MudText Typo="Typo.body2">Created</MudText></td>
                            <td><MudText Typo="Typo.body2">@_selectedActivity.Created.ToLocalTime().ToFriendlyDate()</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.body2">Executed</MudText></td>
                            <td><MudText Typo="Typo.body2">@_selectedActivity.Executed.ToLocalTime().ToFriendlyDate()</MudText></td>
                        </tr>
                        @if (_selectedActivity.ExecutionTime.HasValue)
                        {
                            <tr>
                                <td><MudText Typo="Typo.body2">Duration</MudText></td>
                                <td><MudText Typo="Typo.body2">@_selectedActivity.ExecutionTime.Value.ToCasualString()</MudText></td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            </MudPaper>

            @* Initiator *@
            <MudPaper Elevation="0" Class="pa-3" Outlined="true">
                <MudText Typo="Typo.subtitle2" Class="mb-2" Color="Color.Primary">Initiated By</MudText>
                <div class="d-flex align-center gap-2">
                    @if (_selectedActivity.InitiatedByType == ActivityInitiatorType.User)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                    }
                    else if (_selectedActivity.InitiatedByType == ActivityInitiatorType.ApiKey)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" />
                    }
                    else if (_selectedActivity.InitiatedByType == ActivityInitiatorType.System)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                    }
                    <MudText Typo="Typo.body1">@(_selectedActivity.InitiatedByName ?? "Unknown")</MudText>
                </div>
            </MudPaper>

            @* Error Details *@
            @if (!string.IsNullOrEmpty(_selectedActivity.ErrorMessage))
            {
                <MudExpansionPanels Elevation="0">
                    <MudExpansionPanel Expanded="true">
                        <TitleContent>
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Small" />
                                <MudText Color="Color.Error">Error Details</MudText>
                            </div>
                        </TitleContent>
                        <ChildContent>
                            <MudText Typo="Typo.body2" Style="white-space: pre-wrap; word-break: break-word;">
                                @_selectedActivity.ErrorMessage
                            </MudText>
                            @if (!string.IsNullOrEmpty(_selectedActivity.ErrorStackTrace))
                            {
                                <MudDivider Class="my-2" />
                                <pre class="jim-text-code" style="white-space: pre-wrap; word-break: break-word; font-size: 0.75rem; margin: 0; padding: 12px; background: var(--mud-palette-background); border-radius: 4px; overflow-x: auto;">@_selectedActivity.ErrorStackTrace</pre>
                            }
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }

            @* View Full Details Link *@
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                       EndIcon="@Icons.Material.Filled.ArrowForward"
                       Href="@($"/activity/{_selectedActivity.Id}")">
                View Full Details
            </MudButton>
        </div>
    }
</div>

@code {
    private MudTable<Activity>? _table;
    private string _searchString = "";
    private bool _loading;
    private int _currentPage;
    private int _rowsPerPage = 10;
    private bool _preferencesLoaded;
    private bool _panelOpen;
    private Activity? _selectedActivity;
    private readonly CancellationTokenSource _pollingCancellationTokenSource = new();

    // Filter for worker task activities only
    private static readonly ActivityTargetType[] WorkerTaskTargetTypes =
    [
        ActivityTargetType.ConnectedSystemRunProfile,
        ActivityTargetType.DataGenerationTemplate,
        ActivityTargetType.ConnectedSystem
    ];

    private static readonly ActivityTargetOperationType[] WorkerTaskOperationTypes =
    [
        ActivityTargetOperationType.Execute,
        ActivityTargetOperationType.Clear,
        ActivityTargetOperationType.Delete
    ];

    protected override void OnInitialized()
    {
        // Setup polling for auto-refresh
        var token = _pollingCancellationTokenSource.Token;
        _ = Task.Run(async () =>
        {
            while (!token.IsCancellationRequested)
            {
                try
                {
                    // Use a reasonable default polling interval (5 seconds for history is fine)
                    await Task.Delay(TimeSpan.FromSeconds(5), token);

                    // Only auto-refresh when on page 1 and panel is closed to avoid jarring UX
                    // When on other pages, items shifting would be confusing
                    if (_table != null && !_loading && _currentPage == 0 && !_panelOpen)
                    {
                        await InvokeAsync(() => _table.ReloadServerData());
                    }
                }
                catch (TaskCanceledException)
                {
                    break;
                }
                catch
                {
                    // Ignore errors during polling, will retry on next interval
                }
            }
        }, token);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_preferencesLoaded)
        {
            try
            {
                var preferredSize = await PreferenceService.GetRowsPerPageAsync();
                _rowsPerPage = preferredSize;
                _preferencesLoaded = true;
                StateHasChanged();
            }
            catch
            {
                // JS interop not yet available, will retry on next render
            }
        }
    }

    void IDisposable.Dispose()
    {
        _pollingCancellationTokenSource.Cancel();
    }

    private async Task OnRowsPerPageChanged(int newSize)
    {
        _rowsPerPage = newSize;
        await PreferenceService.SetRowsPerPageAsync(newSize);
    }

    private async Task<TableData<Activity>> ServerReload(TableState state, CancellationToken token)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var page = state.Page + 1;
            var sortDescending = state.SortDirection == SortDirection.Descending;

            // Get activities filtered for worker tasks
            var result = await Jim.Activities.GetWorkerTaskActivitiesAsync(
                page,
                state.PageSize,
                string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                state.SortLabel,
                sortDescending);

            return new TableData<Activity>
            {
                TotalItems = result.TotalResults,
                Items = result.Results
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _table?.ReloadServerData();
    }

    private void HandleRowClick(TableRowClickEventArgs<Activity> args)
    {
        if (_loading || args.Item == null)
            return;

        _selectedActivity = args.Item;
        _panelOpen = true;
    }

    private static string GetCreatesTooltip(ConnectedSystemRunType? runType, string? targetName)
    {
        var effectiveRunType = GetEffectiveRunType(runType, targetName);
        return effectiveRunType switch
        {
            "Import" => "Added",
            "Sync" => "Projected",
            "Export" => "Provisioned",
            _ => "Created"
        };
    }

    private static string GetUpdatesTooltip(ConnectedSystemRunType? runType, string? targetName)
    {
        var effectiveRunType = GetEffectiveRunType(runType, targetName);
        return effectiveRunType switch
        {
            "Import" => "Updated",
            "Sync" => "Joined",
            "Export" => "Exported",
            _ => "Updated"
        };
    }

    private static string GetDeletesTooltip(ConnectedSystemRunType? runType, string? targetName)
    {
        var effectiveRunType = GetEffectiveRunType(runType, targetName);
        return effectiveRunType switch
        {
            "Import" => "Deleted",
            "Sync" => "Disconnected",
            "Export" => "Deprovisioned",
            _ => "Deleted"
        };
    }

    private static string GetEffectiveRunType(ConnectedSystemRunType? runType, string? targetName)
    {
        if (runType is ConnectedSystemRunType.FullImport or ConnectedSystemRunType.DeltaImport)
            return "Import";
        if (runType is ConnectedSystemRunType.FullSynchronisation or ConnectedSystemRunType.DeltaSynchronisation)
            return "Sync";
        if (runType is ConnectedSystemRunType.Export)
            return "Export";

        if (!string.IsNullOrEmpty(targetName))
        {
            if (targetName.Contains("Import", StringComparison.OrdinalIgnoreCase))
                return "Import";
            if (targetName.Contains("Sync", StringComparison.OrdinalIgnoreCase))
                return "Sync";
            if (targetName.Contains("Export", StringComparison.OrdinalIgnoreCase))
                return "Export";
        }

        return "Unknown";
    }
}
