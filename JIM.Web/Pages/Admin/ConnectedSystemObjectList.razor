@page "/admin/connected-systems/{Id:int}/objects"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.Staging
@using JIM.Models.Staging.DTOs
@using JIM.Models.Tasking
@using JIM.Models.Utility
@using JIM.Utilities
@using JIM.Web.Services
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject IUserPreferenceService PreferenceService

<PageTitle>Connected System Objects: @_connectedSystemHeader?.Name</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-secondary-text">Connected System Objects:</span> @_connectedSystemHeader?.Name</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>
<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
    A view of the objects that are staged within JIM for this connected system. This is where changes either, to the connected system are staged ahead of synchronisation,
    or where changes from the system are staged before being committed to the Metaverse within JIM.
</MudText>

@if (_connectedSystemHeader != null && _preferencesLoaded)
{
    @* Status Filter Chips with Options Menu *@
    <MudText Typo="Typo.body2" Class="mud-text-secondary mt-4 mb-2">Filter by status:</MudText>
    <div class="d-flex justify-space-between align-center mb-3">
        <MudChipSet T="ConnectedSystemObjectStatus"
                    SelectionMode="SelectionMode.MultiSelection"
                    SelectedValues="_selectedStatuses"
                    SelectedValuesChanged="OnStatusFilterChanged">
            @foreach (var status in GetAvailableStatuses())
            {
                <MudChip Value="@status"
                         Color="@GetStatusColor(status)"
                         Variant="@GetStatusVariant(status)"
                         SelectedColor="@GetStatusColor(status)">
                    @status.ToString().SplitOnCapitalLetters()
                </MudChip>
            }
        </MudChipSet>
        <MudMenu Label="Options" Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.KeyboardArrowDown" IconColor="Color.Default" DropShadow="false" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem IconColor="Color.Primary" Icon="@Icons.Material.Filled.Delete" OnClick="HandleDeleteAllObjectsClickAsync">Delete all objects</MudMenuItem>
        </MudMenu>
    </div>

    <MudTable @ref="_table"
              T="ConnectedSystemObjectHeader"
              ServerData="ServerReload"
              RowsPerPage="@_rowsPerPage"
              RowsPerPageChanged="OnRowsPerPageChanged"
              Hover="true"
              Dense="true"
              Breakpoint="Breakpoint.Sm"
              Class="mt-5 mb-5"
              Outlined="true"
              Elevation="0"
              OnRowClick="HandleRowClick"
              RowClass="cursor-pointer"
              Loading="@_loading"
              LoadingProgressColor="Color.Primary">
        <ToolBarContent>
            <MudSpacer />
            <MudTextField T="string"
                          ValueChanged="@(s => OnSearch(s))"
                          Placeholder="Search external ID, secondary ID, or display name"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0"
                          Style="min-width: 350px;" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh Style="width: 1px;"></MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="externalid" T="ConnectedSystemObjectHeader">
                    <MudText Typo="Typo.button">@_externalIdColumnHeader</MudText>
                </MudTableSortLabel>
            </MudTh>
            @if (_hasSecondaryExternalId)
            {
                <MudTh>
                    <MudTableSortLabel SortLabel="secondaryexternalid" T="ConnectedSystemObjectHeader">
                        <MudText Typo="Typo.button">@_secondaryExternalIdColumnHeader</MudText>
                    </MudTableSortLabel>
                </MudTh>
            }
            <MudTh>
                <MudTableSortLabel SortLabel="displayname" T="ConnectedSystemObjectHeader">
                    <MudText Typo="Typo.button">Display Name</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="type" T="ConnectedSystemObjectHeader">
                    <MudText Typo="Typo.button">Type</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="created" T="ConnectedSystemObjectHeader" InitialDirection="SortDirection.Descending">
                    <MudText Typo="Typo.button">Created</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="datejoined" T="ConnectedSystemObjectHeader">
                    <MudText Typo="Typo.button">Date Joined</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="status" T="ConnectedSystemObjectHeader">
                    <MudText Typo="Typo.button">Status</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="jointype" T="ConnectedSystemObjectHeader">
                    <MudText Typo="Typo.button">Join Type</MudText>
                </MudTableSortLabel>
            </MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>
                <MudButton Variant="Variant.Outlined"
                           Size="Size.Small"
                           Color="Color.Primary"
                           Href="@(Utilities.GetConnectedSystemObjectHref(context))">
                    View
                </MudButton>
            </MudTd>
            <MudTd DataLabel="External Id">
                @if (!string.IsNullOrEmpty(context.PendingExternalId))
                {
                    <MudTooltip Text="Pending export - not yet confirmed" Arrow="true" Placement="Placement.Top">
                        <MudText Typo="Typo.body2" Color="Color.Info">@context.PendingExternalId</MudText>
                    </MudTooltip>
                }
                else
                {
                    @context.ExternalIdAttributeValue
                }
            </MudTd>
            @if (_hasSecondaryExternalId)
            {
                <MudTd DataLabel="Secondary External Id">
                    @if (context.SecondaryExternalIdAttributeValue != null)
                    {
                        @context.SecondaryExternalIdAttributeValue
                    }
                    else if (!string.IsNullOrEmpty(context.PendingSecondaryExternalId))
                    {
                        <MudTooltip Text="Pending export - not yet confirmed" Arrow="true" Placement="Placement.Top">
                            <MudText Typo="Typo.body2" Color="Color.Info">@context.PendingSecondaryExternalId</MudText>
                        </MudTooltip>
                    }
                </MudTd>
            }
            <MudTd DataLabel="Display Name">
                @if (!string.IsNullOrEmpty(context.DisplayName))
                {
                    @context.DisplayName
                }
                else if (!string.IsNullOrEmpty(context.PendingDisplayName))
                {
                    <MudTooltip Text="Pending export - not yet confirmed" Arrow="true" Placement="Placement.Top">
                        <MudText Typo="Typo.body2" Color="Color.Info">@context.PendingDisplayName</MudText>
                    </MudTooltip>
                }
            </MudTd>
            <MudTd DataLabel="Type">@context.TypeName</MudTd>
            <MudTd DataLabel="Created">
                <MudTooltip Text="@context.Created.ToString("O")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.body2">@context.Created.ToLocalTime().ToRelativeTime()</MudText>
                </MudTooltip>
            </MudTd>
            <MudTd DataLabel="Date Joined">
                @if (context.DateJoined != null)
                {
                    <MudTooltip Text="@context.DateJoined.Value.ToString("O")" Arrow="true" Placement="Placement.Top">
                        <MudText Typo="Typo.body2">@context.DateJoined.Value.ToLocalTime().ToRelativeTime()</MudText>
                    </MudTooltip>
                }
                else
                {
                    <MudText Typo="Typo.body2">-</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Text="@context.Status.ToString().SplitOnCapitalLetters()" Variant="Variant.Text" />
            </MudTd>
            <MudTd DataLabel="Join Type">@context.JoinType.ToString().SplitOnCapitalLetters()</MudTd>
        </RowTemplate>
        <NoRecordsContent>
            @if (string.IsNullOrWhiteSpace(_searchString))
            {
                <MudText>There are no objects for this connected system. Have you performed a full import?</MudText>
            }
            else
            {
                <MudText>No objects found matching "@_searchString".</MudText>
            }
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>

    <MudMessageBox @ref="DeleteAllObjectsMessageBox" Title="Warning" CancelText="Cancel">
        <MessageContent>
            Deleting the connected system objects does not cause objects to be deleted in the external system.
            It just removes the objects from JIM. A full-import on this connect system and full-synchronisation on all connected system is needed to rebuild the correct state.
            <br/><br/>
            The deletes will be executed via a task and may take some time. Check the <MudLink Href="/admin/operations" Target="_blank">Operations</MudLink> page or refresh this one to see progress.
        </MessageContent>
        <YesButton>
            <MudButton Variant="Variant.Filled" Color="Color.Error" DropShadow="false" StartIcon="@Icons.Material.Filled.DeleteForever" Class="ml-2">Delete all objects</MudButton>
        </YesButton>
    </MudMessageBox>
}
else
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mt-5" />
}

@code {
    [Parameter]
    public int Id { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

    private MudTable<ConnectedSystemObjectHeader>? _table;
    private MudMessageBox? DeleteAllObjectsMessageBox { get; set; }
    private ConnectedSystemHeader? _connectedSystemHeader;
    private string _searchString = "";
    private List<BreadcrumbItem> _breadcrumbs = null!;
    private bool _loading;
    private bool _hasSecondaryExternalId;
    private string _externalIdColumnHeader = "External Id";
    private string _secondaryExternalIdColumnHeader = "Secondary External Id";
    private int _rowsPerPage = 10;
    private bool _preferencesLoaded;

    // Status filter - by default, hide Obsolete CSOs to reduce noise
    // Users can click the Obsolete chip to see deleted objects
    private IReadOnlyCollection<ConnectedSystemObjectStatus> _selectedStatuses = new List<ConnectedSystemObjectStatus>
    {
        ConnectedSystemObjectStatus.Normal,
        ConnectedSystemObjectStatus.PendingProvisioning
    };

    protected override async Task OnInitializedAsync()
    {
        _connectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(Id);
        if (_connectedSystemHeader == null)
        {
            NavManager.NavigateTo("../");
            return;
        }

        _breadcrumbs = new List<BreadcrumbItem>
        {
            new("Home", href: "/", icon: Icons.Material.Filled.Home),
            new("Connected Systems", href: "/admin/connected-systems/"),
            new(_connectedSystemHeader.Name, href: Utilities.GetConnectedSystemHref(_connectedSystemHeader)),
            new("Objects", href: null, disabled: true)
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_preferencesLoaded)
        {
            try
            {
                var preferredSize = await PreferenceService.GetRowsPerPageAsync();
                _rowsPerPage = preferredSize;
                _preferencesLoaded = true;
                StateHasChanged(); // Re-render to show the table now that preference is loaded
            }
            catch
            {
                // JS interop not yet available, will retry on next render
            }
        }
    }

    private async Task OnRowsPerPageChanged(int newSize)
    {
        _rowsPerPage = newSize;
        await PreferenceService.SetRowsPerPageAsync(newSize);
    }

    private async Task<TableData<ConnectedSystemObjectHeader>> ServerReload(TableState state, CancellationToken token)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Convert MudBlazor's 0-indexed page to our 1-indexed page
            var page = state.Page + 1;
            var sortDescending = state.SortDirection == SortDirection.Descending;

            // Get selected statuses for filtering (null means show all)
            IEnumerable<ConnectedSystemObjectStatus>? statusFilter = _selectedStatuses.Count > 0 ? _selectedStatuses : null;

            var result = await Jim.ConnectedSystems.GetConnectedSystemObjectHeadersAsync(
                Id,
                page,
                state.PageSize,
                string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                state.SortLabel,
                sortDescending,
                statusFilter);

            // Update column headers based on first result
            UpdateColumnHeaders(result.Results);

            return new TableData<ConnectedSystemObjectHeader>
            {
                TotalItems = result.TotalResults,
                Items = result.Results
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void UpdateColumnHeaders(List<ConnectedSystemObjectHeader> results)
    {
        if (results.Count == 0)
        {
            _externalIdColumnHeader = "External Id";
            _secondaryExternalIdColumnHeader = "Secondary External Id";
            _hasSecondaryExternalId = false;
            return;
        }

        var first = results.First();
        _externalIdColumnHeader = string.IsNullOrEmpty(first.ExternalIdAttributeName)
            ? "External Id"
            : $"External Id ({first.ExternalIdAttributeName})";

        // Show secondary external ID column if any confirmed OR pending values exist
        _hasSecondaryExternalId = results.Any(r =>
            r.SecondaryExternalIdAttributeValue != null || !string.IsNullOrEmpty(r.PendingSecondaryExternalId));
        if (_hasSecondaryExternalId)
        {
            var secondaryAttrName = results
                .FirstOrDefault(r => r.SecondaryExternalIdAttributeValue != null)?.SecondaryExternalIdAttributeName;
            _secondaryExternalIdColumnHeader = string.IsNullOrEmpty(secondaryAttrName)
                ? "Secondary External Id"
                : $"Secondary External Id ({secondaryAttrName})";
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _table?.ReloadServerData();
    }

    private void HandleRowClick(TableRowClickEventArgs<ConnectedSystemObjectHeader> args)
    {
        if (_loading || args.Item == null)
            return;

        NavManager.NavigateTo(Utilities.GetConnectedSystemObjectHref(args.Item));
    }

    private async Task HandleDeleteAllObjectsClickAsync()
    {
        if (DeleteAllObjectsMessageBox == null)
            return;

        var userPromptResult = await DeleteAllObjectsMessageBox.ShowAsync();
        if (!userPromptResult.HasValue || !userPromptResult.Value)
            return;

        // attribute the execution to the user
        var user = await Helpers.GetUserAsync(Jim, AuthenticationStateTask);
        var task = new ClearConnectedSystemObjectsWorkerTask(Id, user);
        var result = await Jim.Tasking.CreateWorkerTaskAsync(task);

        if (!result.Success)
        {
            Snackbar.Add(result.ErrorMessage ?? "Failed to create task.", Severity.Error);
            return;
        }

        Snackbar.Add("Connected system objects queued for deletion.", Severity.Info);
    }

    /// <summary>
    /// Returns all available CSO statuses for filtering.
    /// </summary>
    private static IEnumerable<ConnectedSystemObjectStatus> GetAvailableStatuses()
    {
        return new[]
        {
            ConnectedSystemObjectStatus.Normal,
            ConnectedSystemObjectStatus.PendingProvisioning,
            ConnectedSystemObjectStatus.Obsolete
        };
    }

    /// <summary>
    /// Gets the colour for a CSO status chip.
    /// </summary>
    private static Color GetStatusColor(ConnectedSystemObjectStatus status)
    {
        return status switch
        {
            ConnectedSystemObjectStatus.Normal => Color.Success,
            ConnectedSystemObjectStatus.PendingProvisioning => Color.Info,
            ConnectedSystemObjectStatus.Obsolete => Color.Default,
            _ => Color.Default
        };
    }

    /// <summary>
    /// Gets the variant for a CSO status chip based on selection state.
    /// Obsolete uses Text variant (no outline) when not selected to de-emphasise it.
    /// </summary>
    private Variant GetStatusVariant(ConnectedSystemObjectStatus status)
    {
        // When selected, all chips use Outlined variant (shows the outline)
        if (IsStatusSelected(status))
            return Variant.Outlined;

        // When not selected, Obsolete uses Text (no outline) to de-emphasise it
        // Other statuses also use Text variant when not selected
        return Variant.Text;
    }

    /// <summary>
    /// Checks if a status is currently selected in the filter.
    /// </summary>
    private bool IsStatusSelected(ConnectedSystemObjectStatus status)
    {
        return _selectedStatuses.Contains(status);
    }

    /// <summary>
    /// Called when status filter chips are selected/deselected.
    /// </summary>
    private void OnStatusFilterChanged(IReadOnlyCollection<ConnectedSystemObjectStatus> selectedStatuses)
    {
        _selectedStatuses = selectedStatuses;
        _table?.ReloadServerData();
    }
}
