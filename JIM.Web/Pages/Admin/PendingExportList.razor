@page "/admin/connected-systems/{Id:int}/pending-exports"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.Staging.DTOs
@using JIM.Models.Transactional
@using JIM.Models.Transactional.DTOs
@using JIM.Models.Utility
@using JIM.Utilities
@using JIM.Web.Services
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject IUserPreferenceService PreferenceService

<PageTitle>Pending Exports: @_connectedSystemHeader?.Name</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-secondary-text">Pending Exports:</span> @_connectedSystemHeader?.Name</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>
<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
    Pending exports are changes that need to be applied to the connected system. These are created when metaverse objects
    change and need to be synchronised to this target system.
</MudText>

@if (_connectedSystemHeader != null && _preferencesLoaded)
{
    <MudGrid Class="mt-5">
        <MudItem xs="6">
            <MudSelect T="PendingExportStatus" Label="Filter by Status" MultiSelection="true"
                       SelectedValues="_statusFilters" SelectedValuesChanged="OnStatusFiltersChanged"
                       MultiSelectionTextFunc="@GetStatusFilterText"
                       Variant="Variant.Outlined" Clearable="true" Dense="true" Style="max-width: 350px;">
                <MudSelectItem T="PendingExportStatus" Value="@PendingExportStatus.Pending">Pending</MudSelectItem>
                <MudSelectItem T="PendingExportStatus" Value="@PendingExportStatus.Executing">Executing</MudSelectItem>
                <MudSelectItem T="PendingExportStatus" Value="@PendingExportStatus.ExportNotConfirmed">Export Not Confirmed</MudSelectItem>
                <MudSelectItem T="PendingExportStatus" Value="@PendingExportStatus.Failed">Failed</MudSelectItem>
                <MudSelectItem T="PendingExportStatus" Value="@PendingExportStatus.Exported">Exported</MudSelectItem>
            </MudSelect>
        </MudItem>
    </MudGrid>

    <MudTable @ref="_table"
              T="PendingExportHeader"
              ServerData="ServerReload"
              RowsPerPage="@_rowsPerPage"
              RowsPerPageChanged="OnRowsPerPageChanged"
              Hover="true"
              Dense="true"
              Breakpoint="Breakpoint.Sm"
              Class="mt-5"
              Outlined="true"
              Elevation="0"
              OnRowClick="HandleRowClick"
              RowClass="cursor-pointer"
              Loading="@_loading"
              LoadingProgressColor="Color.Primary">
        <ToolBarContent>
            <MudSpacer />
            <MudTextField T="string"
                          ValueChanged="@(s => OnSearch(s))"
                          Placeholder="Search target, source MVO, or errors"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          IconSize="Size.Medium"
                          Class="mt-0" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>
                <MudTableSortLabel SortLabel="changetype" T="PendingExportHeader">
                    <MudText Typo="Typo.button">Change Type</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="status" T="PendingExportHeader">
                    <MudText Typo="Typo.button">Status</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="targetobject" T="PendingExportHeader">
                    <MudText Typo="Typo.button">Target Object</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="sourcemvo" T="PendingExportHeader">
                    <MudText Typo="Typo.button">Source MVO</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="changes" T="PendingExportHeader">
                    <MudText Typo="Typo.button">Changes</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="created" T="PendingExportHeader" InitialDirection="SortDirection.Descending">
                    <MudText Typo="Typo.button">Created</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="errors" T="PendingExportHeader">
                    <MudText Typo="Typo.button">Errors</MudText>
                </MudTableSortLabel>
            </MudTh>
            <MudTh>
                <MudTableSortLabel SortLabel="nextretry" T="PendingExportHeader">
                    <MudText Typo="Typo.button">Next Retry</MudText>
                </MudTableSortLabel>
            </MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Change Type">
                <MudChip T="string" Variant="Variant.Text" Color="Helpers.GetPendingExportChangeTypeColor(context.ChangeType)" Style="font-size: 1rem;">
                    @context.ChangeType
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Variant="Variant.Text" Color="Helpers.GetPendingExportStatusColor(context.Status)" Style="font-size: 1rem;">
                    @context.Status.ToString().SplitOnCapitalLetters()
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Target Object">
                @if (context.ConnectedSystemObjectId.HasValue)
                {
                    <MudLink Href="@($"/admin/connected-systems/{Id}/objects/{context.ConnectedSystemObjectId}")">
                        @(context.TargetObjectIdentifier ?? context.ConnectedSystemObjectId.ToString())
                    </MudLink>
                }
                else
                {
                    <span class="mud-text-secondary">New object</span>
                }
            </MudTd>
            <MudTd DataLabel="Source MVO">
                @if (context.SourceMetaverseObjectId.HasValue)
                {
                    <MudLink Href="@($"/admin/metaverse/objects/{context.SourceMetaverseObjectId}")">
                        @(context.SourceMetaverseObjectDisplayName ?? context.SourceMetaverseObjectId.ToString())
                    </MudLink>
                }
                else
                {
                    <span>-</span>
                }
            </MudTd>
            <MudTd DataLabel="Changes">@context.AttributeChangeCount</MudTd>
            <MudTd DataLabel="Created">
                <MudTooltip Text="@context.CreatedAt.ToLocalTime().ToFriendlyDate()" Arrow="true" Placement="Placement.Top">
                    <span>@context.CreatedAt.ToLocalTime().ToRelativeTime()</span>
                </MudTooltip>
            </MudTd>
            <MudTd DataLabel="Errors">
                @if (context.ErrorCount > 0)
                {
                    <MudChip T="string" Variant="Variant.Text" Color="Color.Error">
                        @context.ErrorCount / @context.MaxRetries
                    </MudChip>
                }
                else
                {
                    <span>0</span>
                }
            </MudTd>
            <MudTd DataLabel="Next Retry">
                @if (context.NextRetryAt.HasValue)
                {
                    @context.NextRetryAt.Value.ToFriendlyDate()
                }
                else
                {
                    <span>-</span>
                }
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>There are no pending exports for this connected system.</MudText>
        </NoRecordsContent>
        <PagerContent>
            <MudTablePager />
        </PagerContent>
    </MudTable>
}
else
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Class="mt-5" />
}

@code {
    [Parameter]
    public int Id { get; set; }

    private MudTable<PendingExportHeader>? _table;
    private ConnectedSystemHeader? _connectedSystemHeader;
    private string _searchString = "";
    private IEnumerable<PendingExportStatus> _statusFilters = new HashSet<PendingExportStatus>();
    private List<BreadcrumbItem> _breadcrumbs = null!;
    private bool _loading;
    private int _rowsPerPage = 10;
    private bool _preferencesLoaded;

    protected override async Task OnInitializedAsync()
    {
        _connectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(Id);
        if (_connectedSystemHeader == null)
        {
            NavManager.NavigateTo("../");
            return;
        }

        _breadcrumbs = new List<BreadcrumbItem>
        {
            new("Home", href: "/", icon: Icons.Material.Filled.Home),
            new("Connected Systems", href: "/admin/connected-systems/"),
            new(_connectedSystemHeader.Name, href: Utilities.GetConnectedSystemHref(_connectedSystemHeader)),
            new("Pending Exports", href: null, disabled: true)
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_preferencesLoaded)
        {
            try
            {
                var preferredSize = await PreferenceService.GetRowsPerPageAsync();
                _rowsPerPage = preferredSize;
                _preferencesLoaded = true;
                StateHasChanged(); // Re-render to show the table now that preference is loaded
            }
            catch
            {
                // JS interop not yet available, will retry on next render
            }
        }
    }

    private async Task OnRowsPerPageChanged(int newSize)
    {
        _rowsPerPage = newSize;
        await PreferenceService.SetRowsPerPageAsync(newSize);
    }

    private async Task<TableData<PendingExportHeader>> ServerReload(TableState state, CancellationToken token)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Convert MudBlazor's 0-indexed page to our 1-indexed page
            var page = state.Page + 1;
            var sortDescending = state.SortDirection == SortDirection.Descending;

            var result = await Jim.ConnectedSystems.GetPendingExportHeadersAsync(
                Id,
                page,
                state.PageSize,
                _statusFilters.Any() ? _statusFilters : null,
                string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                state.SortLabel,
                sortDescending);

            return new TableData<PendingExportHeader>
            {
                TotalItems = result.TotalResults,
                Items = result.Results
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _table?.ReloadServerData();
    }

    private string GetStatusFilterText(List<string> selectedValues)
    {
        if (selectedValues == null || selectedValues.Count == 0)
            return "All";

        if (selectedValues.Count == 1)
            return selectedValues[0].SplitOnCapitalLetters();

        return $"{selectedValues.Count} selected";
    }

    private void OnStatusFiltersChanged(IEnumerable<PendingExportStatus> newFilters)
    {
        _statusFilters = newFilters;
        _table?.ReloadServerData();
    }

    private void HandleRowClick(TableRowClickEventArgs<PendingExportHeader> args)
    {
        if (args.Item != null)
            NavManager.NavigateTo($"/admin/connected-systems/{Id}/pending-exports/{args.Item.Id}");
    }
}
