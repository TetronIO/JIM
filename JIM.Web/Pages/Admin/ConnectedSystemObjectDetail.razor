@page "/admin/connected-systems/{CsId:int}/objects/{CsoId}"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.Staging
@using JIM.Models.Staging.DTOs
@using JIM.Models.Transactional
@using JIM.Models.Core
@using JIM.Models.Enums
@using JIM.Utilities
@inject JimApplication Jim
@inject NavigationManager NavManager

<PageTitle>Connected System Object: @ConnectedSystemObject?.Id</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-secondary-text">Connected System Object:</span> @ConnectedSystemObject?.Id
</MudText>
<MudBreadcrumbs Items="Breadcrumbs" Class="ps-0"></MudBreadcrumbs>

<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
    A view of this object as staged within JIM. This includes any attribute values imported from the connected system,
    as well as any pending export changes awaiting export.
</MudText>

@if (ConnectedSystemHeader != null && ConnectedSystemObject != null)
{
    <MudPaper Class="pa-4 mt-4 mb-4" Outlined="true">
        @* First row: Type, Status, Created, Updated, MVO Link *@
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="flex-wrap" Spacing="3">
            @* Object Type *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body2" Class="mud-text-secondary">Type:</MudText>
                <MudText Typo="Typo.body2">@ConnectedSystemObject.Type.Name</MudText>
            </MudStack>
            <MudDivider Vertical="true" FlexItem="true" Class="my-1" />

            @* Status *@
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body2" Class="mud-text-secondary">Status:</MudText>
                <MudChip T="string" Variant="Variant.Text" Color="GetStatusColor(ConnectedSystemObject.Status)" Size="Size.Small">
                    @ConnectedSystemObject.Status.ToString().SplitOnCapitalLetters()
                </MudChip>
            </MudStack>
            <MudDivider Vertical="true" FlexItem="true" Class="my-1" />

            @* Created *@
            <MudTooltip Text="@ConnectedSystemObject.Created.ToFriendlyDate()" Arrow="true" Placement="Placement.Top">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Created:</MudText>
                    <MudText Typo="Typo.body2">@ConnectedSystemObject.Created.ToRelativeTime()</MudText>
                </MudStack>
            </MudTooltip>

            @* Last Updated *@
            @if (ConnectedSystemObject.LastUpdated.HasValue)
            {
                <MudDivider Vertical="true" FlexItem="true" Class="my-1" />
                <MudTooltip Text="@ConnectedSystemObject.LastUpdated.Value.ToFriendlyDate()" Arrow="true" Placement="Placement.Top">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudText Typo="Typo.body2" Class="mud-text-secondary">Updated:</MudText>
                        <MudText Typo="Typo.body2">@ConnectedSystemObject.LastUpdated.Value.ToRelativeTime()</MudText>
                    </MudStack>
                </MudTooltip>
            }

            @* Metaverse Link *@
            @if (ConnectedSystemObject.MetaverseObjectId.HasValue && ConnectedSystemObject.MetaverseObject != null)
            {
                <MudDivider Vertical="true" FlexItem="true" Class="my-1" />
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Metaverse Object:</MudText>
                    <MudLink Typo="Typo.body2" Href="@Utilities.GetMetaverseObjectHref(ConnectedSystemObject.MetaverseObject)">
                        @(Utilities.GetMetaverseObjectHrefText(ConnectedSystemObject.MetaverseObject) ?? ConnectedSystemObject.MetaverseObjectId.ToString())
                    </MudLink>
                    <MudDivider Vertical="true" FlexItem="true" Class="my-1" />
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Join Type:</MudText>
                    <MudChip T="string" Variant="Variant.Text" Color="GetJoinTypeColor(ConnectedSystemObject.JoinType)" Size="Size.Small">
                        @ConnectedSystemObject.JoinType
                    </MudChip>
                </MudStack>
            }
        </MudStack>

        @* External IDs table *@
        @if (ExternalIdAttributeValue != null || SecondaryExternalIdAttributeValue != null)
        {
            <MudSimpleTable Dense="true" Hover="true" Class="mt-3" Style="background: transparent;" Elevation="0">
                <tbody>
                    @if (ExternalIdAttributeValue != null)
                    {
                        <tr>
                            <td style="width: 200px;"><MudText Typo="Typo.body2" Class="mud-text-secondary">@ExternalIdAttributeValue.Attribute.Name</MudText></td>
                            <td><MudText Typo="Typo.body2" Class="jim-text-code">@ExternalIdAttributeValue.ToStringNoName()</MudText></td>
                        </tr>
                    }
                    @if (SecondaryExternalIdAttributeValue != null)
                    {
                        <tr>
                            <td><MudText Typo="Typo.body2" Class="mud-text-secondary">@SecondaryExternalIdAttributeValue.Attribute.Name</MudText></td>
                            <td><MudText Typo="Typo.body2" Class="jim-text-code">@SecondaryExternalIdAttributeValue.ToStringNoName()</MudText></td>
                        </tr>
                    }
                </tbody>
            </MudSimpleTable>
        }
    </MudPaper>

    @if (PendingExport != null && PendingExport.AttributeValueChanges.Count > 0)
    {
        <MudPaper Class="pa-5 mt-5 mb-5 jim-paper-info" Outlined="true">
            <MudText Typo="Typo.h6">Pending Exports</MudText>
            <MudText Typo="Typo.subtitle1" Class="my-3">
                The following attribute changes are pending for this connected system. These may be awaiting export, or have
                already been exported
                and are awaiting confirmation via a subsequent import. Once confirmed, these changes will be reflected in the
                CSO attribute values below.
            </MudText>
            <MudTable Items="@PendingExport.AttributeValueChanges" Hover="true" Dense="true" Outlined="true" Elevation="0">
                <HeaderContent>
                    <MudTh>Attribute</MudTh>
                    <MudTh>Change Type</MudTh>
                    <MudTh>Value</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Export Attempts</MudTh>
                    <MudTh>Last Exported</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Attribute">@(context.Attribute?.Name ?? $"Attribute {context.AttributeId}")</MudTd>
                    <MudTd DataLabel="Change Type">
                        <MudChip T="string" Variant="Variant.Text" Color="GetAttributeChangeTypeColor(context.ChangeType)"
                            Size="Size.Small">
                            @context.ChangeType
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Value">@GetAttributeValue(context)</MudTd>
                    <MudTd DataLabel="Status">
                        <MudChip T="string" Variant="Variant.Text" Color="GetAttributeChangeStatusColor(context.Status)"
                            Size="Size.Small">
                            @context.Status.ToString().SplitOnCapitalLetters()
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Export Attempts">@context.ExportAttemptCount</MudTd>
                    <MudTd DataLabel="Last Exported">@(context.LastExportedAt?.ToFriendlyDate() ?? "-")</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }

    <style>
        .mud-table-cell-custom-group {
            font-weight: 500;
        }

        .mud-table-cell-custom-group-footer {
            padding-bottom: 50px;
            text-align: right;
        }
    </style>

    <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-0 mt-4">
        <MudTabPanel Text="Attributes">
            <MudPaper Class="pa-5" Outlined="true">
                <MudTable Hover="true" Breakpoint="Breakpoint.Sm" Elevation="0"
                    Items="@(ConnectedSystemObject.AttributeValues.OrderBy(q => q.Attribute.Name))" GroupBy="@_groupDefinition"
                    GroupHeaderStyle="background-color:var(--mud-palette-background-grey)" GroupFooterClass="mb-4" Dense="true">
                    <ColGroup>
                        <col style="width: 60px;" />
                        <col />
                        <col />
                    </ColGroup>
                    <HeaderContent>
                        <MudTh>Attribute Value Type</MudTh>
                        <MudTh>Attribute Value</MudTh>
                    </HeaderContent>
                    <GroupHeaderTemplate>
                        <MudTh Class="mud-table-cell-custom-group" colspan="5">@(context.GroupName): <span
                                class="mud-secondary-text">@(context.Key)</span></MudTh>
                    </GroupHeaderTemplate>
                    <RowTemplate>
                        <MudTd DataLabel="Type">@context.Attribute.Type</MudTd>
                        <MudTd DataLabel="Value">
                            @if (context.ReferenceValue != null)
                            {
                                <MudChip T="string" Color="Color.Default" Size="Size.Small">@context.ReferenceValue.Type.Name</MudChip>
                                <text> </text>
                                <MudLink Href="@Utilities.GetConnectedSystemObjectHref(context.ReferenceValue)">
                                    @context.ReferenceValue.DisplayNameOrId</MudLink>

                                if (context.ReferenceValue.SecondaryExternalIdAttributeValue != null)
                                {
                                    <span class="mud-text-secondary">
                                        (@context.ReferenceValue.SecondaryExternalIdAttributeValue.ToString())</span>
                                }
                            }
                            else if (context.UnresolvedReferenceValue != null)
                            {
                                <MudText>Unresolved reference: <span
                                        Style="@($"color:{Colors.Gray.Darken2};")">@context.ToString()</span></MudText>
                            }
                            else
                            {
                                @context.ToStringNoName()
                            }
                        </MudTd>
                    </RowTemplate>
                    <GroupFooterTemplate>
                        <MudTh Class="mud-table-cell-custom-group mud-table-cell-custom-group-footer" colspan="5">Total Values:
                            @context.Items.Count()</MudTh>
                    </GroupFooterTemplate>
                </MudTable>
            </MudPaper>
        </MudTabPanel>
        <MudTabPanel Text="Change History">
            <MudPaper Class="pa-5" Outlined="true">
                @if (CsoChanges == null)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                    <MudText>Loading change history...</MudText>
                }
                else
                {
                    <ChangeHistoryTimeline Changes="@GetCsoChangeHistory()" />
                }
            </MudPaper>
        </MudTabPanel>
    </MudTabs>
}

@code {
    /// <summary>
    /// Connected System ID.
    /// </summary>
    [Parameter]
    public int CsId { get; set; }

    /// <summary>
    /// Connected System Object ID.
    /// </summary>
    [Parameter]
    public string CsoId { get; set; } = null!;

    private ConnectedSystemHeader? ConnectedSystemHeader { get; set; }

    private ConnectedSystemObject? ConnectedSystemObject { get; set; }

    private ConnectedSystemObjectAttributeValue? ExternalIdAttributeValue { get; set; }

    private ConnectedSystemObjectAttributeValue? SecondaryExternalIdAttributeValue { get; set; }

    private PendingExport? PendingExport { get; set; }

    private List<ConnectedSystemObjectChange>? CsoChanges { get; set; }

    private List<BreadcrumbItem> Breadcrumbs { get; set; } = null!;

    protected override async Task OnParametersSetAsync()
    {
        ConnectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(CsId);
        if (ConnectedSystemHeader == null)
        {
            // ConnectedSystem not found, redirect to the Connected Systems index page
            NavManager.NavigateTo($"/admin/connected-systems/");
            return;
        }

        var csoIdValid = Guid.TryParse(CsoId, out var connectedSystemObjectId);
        if (!csoIdValid)
        {
            NavManager.NavigateTo(Utilities.GetConnectedSystemObjectsHref(CsId));
            return;
        }

        ConnectedSystemObject = await Jim.ConnectedSystems.GetConnectedSystemObjectAsync(CsId, connectedSystemObjectId);
        if (ConnectedSystemObject == null)
        {
            // ConnectedSystemObject not found, redirect to Connected System Objects index page
            NavManager.NavigateTo(Utilities.GetConnectedSystemObjectsHref(CsId));
            return;
        }

        Breadcrumbs = new List<BreadcrumbItem>
{
new("Home", href: "/", icon: Icons.Material.Filled.Home),
new("Connected Systems", href: "/admin/connected-systems/"),
new(ConnectedSystemHeader.Name, href: Utilities.GetConnectedSystemHref(ConnectedSystemHeader)),
new("Objects", href: Utilities.GetConnectedSystemObjectsHref(ConnectedSystemHeader)),
new(CsoId.ToString(), href: null, disabled: true)
};

        ExternalIdAttributeValue = ConnectedSystemObject.ExternalIdAttributeValue;
        SecondaryExternalIdAttributeValue = ConnectedSystemObject.SecondaryExternalIdAttributeValue;

        // Fetch pending export for this CSO
        PendingExport = await Jim.ConnectedSystems.GetPendingExportForObjectAsync(connectedSystemObjectId);

        // Fetch change history for this CSO
        CsoChanges = await Jim.ConnectedSystems.GetConnectedSystemObjectChangesAsync(connectedSystemObjectId);
    }

    private readonly TableGroupDefinition<ConnectedSystemObjectAttributeValue> _groupDefinition = new()
    {
        GroupName = "Group",
        Indentation = false,
        Expandable = true,
        Selector = (e) => e.Attribute.Name
    };

    private static string GetAttributeValue(PendingExportAttributeValueChange change)
    {
        if (!string.IsNullOrEmpty(change.UnresolvedReferenceValue))
            return $"[Unresolved Reference: {change.UnresolvedReferenceValue}]";

        if (change.StringValue != null)
            return change.StringValue;

        if (change.DateTimeValue.HasValue)
            return change.DateTimeValue.Value.ToFriendlyDate();

        if (change.IntValue.HasValue)
            return change.IntValue.Value.ToString();

        if (change.ByteValue != null)
            return $"[Binary data: {change.ByteValue.Length} bytes]";

        return "[null]";
    }

    private static MudBlazor.Color GetAttributeChangeTypeColor(PendingExportAttributeChangeType changeType)
    {
        return changeType switch
        {
            PendingExportAttributeChangeType.Add => MudBlazor.Color.Primary,
            PendingExportAttributeChangeType.Update => MudBlazor.Color.Info,
            PendingExportAttributeChangeType.Remove => MudBlazor.Color.Warning,
            PendingExportAttributeChangeType.RemoveAll => MudBlazor.Color.Error,
            _ => MudBlazor.Color.Default,
        };
    }

    private static MudBlazor.Color GetAttributeChangeStatusColor(PendingExportAttributeChangeStatus status)
    {
        return status switch
        {
            PendingExportAttributeChangeStatus.Pending => MudBlazor.Color.Default,
            PendingExportAttributeChangeStatus.ExportedPendingConfirmation => MudBlazor.Color.Info,
            PendingExportAttributeChangeStatus.ExportedNotConfirmed => MudBlazor.Color.Warning,
            PendingExportAttributeChangeStatus.Failed => MudBlazor.Color.Error,
            _ => MudBlazor.Color.Default,
        };
    }

    private static MudBlazor.Color GetStatusColor(ConnectedSystemObjectStatus status)
    {
        return status switch
        {
            ConnectedSystemObjectStatus.Normal => MudBlazor.Color.Success,
            ConnectedSystemObjectStatus.Obsolete => MudBlazor.Color.Warning,
            ConnectedSystemObjectStatus.PendingProvisioning => MudBlazor.Color.Info,
            _ => MudBlazor.Color.Default,
        };
    }

    private static MudBlazor.Color GetJoinTypeColor(ConnectedSystemObjectJoinType joinType)
    {
        return joinType switch
        {
            ConnectedSystemObjectJoinType.Projected => MudBlazor.Color.Primary,
            ConnectedSystemObjectJoinType.Provisioned => MudBlazor.Color.Secondary,
            ConnectedSystemObjectJoinType.Joined => MudBlazor.Color.Info,
            ConnectedSystemObjectJoinType.NotJoined => MudBlazor.Color.Default,
            _ => MudBlazor.Color.Default,
        };
    }

    private List<ChangeHistoryTimeline.ChangeGroup> GetCsoChangeHistory()
    {
        if (CsoChanges == null)
            return new List<ChangeHistoryTimeline.ChangeGroup>();

        return CsoChanges
            .OrderByDescending(c => c.ChangeTime)
            .Select(change => new ChangeHistoryTimeline.ChangeGroup
            {
                ChangeType = change.ChangeType,
                ChangeTime = change.ChangeTime,
                // CSO changes don't have the same initiator tracking as MVO changes
                // The RPEI can be used to track back to the activity if needed
                ChangeInitiatorType = "Import",
                ChangeInitiatorName = ConnectedSystemHeader?.Name ?? "Connected System",
                ChangeInitiatorId = null,
                ChangeMechanismType = "Import",
                SyncRuleId = null,
                SyncRuleName = null,
                ActivityRunProfileExecutionItemId = change.ActivityRunProfileExecutionItemId,
                AttributeChanges = change.AttributeChanges
                    .OrderBy(ac => ac.Attribute.Name)
                    .SelectMany(ac => ac.ValueChanges.Select(vc => new ChangeHistoryTimeline.AttributeChange
                    {
                        AttributeName = ac.Attribute.Name,
                        ChangeType = vc.ValueChangeType,
                        Value = vc.ReferenceValue == null ? vc.ToString() : null,
                        ReferenceValue = vc.ReferenceValue != null ? new ChangeHistoryTimeline.ReferenceValueInfo
                        {
                            TypeName = vc.ReferenceValue.Type.Name,
                            DisplayName = vc.ReferenceValue.DisplayNameOrId ?? vc.ReferenceValue.Id.ToString(),
                            SecondaryId = vc.ReferenceValue.SecondaryExternalIdAttributeValue?.ToStringNoName(),
                            Href = Utilities.GetConnectedSystemObjectHref(vc.ReferenceValue)
                        } : null,
                        IsMultiValued = ac.Attribute.AttributePlurality == AttributePlurality.MultiValued
                    }))
                    .ToList()
            })
            .ToList();
    }
}
