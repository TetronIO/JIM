@page "/activity/{Id:guid}"
@attribute [Authorize(Roles = "User")]
@using JIM.Application
@using JIM.Models.Activities;
@using JIM.Models.Activities.DTOs;
@using JIM.Models.Core.DTOs;
@using JIM.Models.Enums;
@using JIM.Models.Staging
@using JIM.Models.Staging.DTOs
@using JIM.Models.Utility;
@using JIM.Utilities;
@using JIM.Web.Services
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject IUserPreferenceService PreferenceService

<PageTitle>Activity: @_activity?.TargetOperationType @_activity?.TargetType.ToString().SplitOnCapitalLetters()@(ShowTargetInTitle() ? $": {GetTargetDisplayText()}" : "")</PageTitle>
<MudText Typo="Typo.h4"><span class="jim-title-segment mud-primary-text">Activity:</span> <span class="jim-title-segment">@_activity?.TargetOperationType @_activity?.TargetType.ToString().SplitOnCapitalLetters()</span>@if (ShowTargetInTitle()) {<span class="jim-title-segment">: <span class="jim-title-accent">@GetTargetDisplayText()</span></span>}</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>

@if (_activity != null)
{
    <MudText Typo="Typo.h5" Class="mt-5">Summary</MudText>
    <MudPaper Class="pa-5 mt-5" Outlined="true">
        <MudGrid>
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button" Class="mud-text-secondary">ID:</MudText>
                <MudText Class="jim-text-code">@_activity.Id</MudText>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button" Class="mud-text-secondary">Target:</MudText>
                <MudText>
                    @switch (_activity.TargetType)
                    {
                        case ActivityTargetType.DataGenerationTemplate:
                            <MudLink Href="@($"/admin/example-data/templates/{_activity.DataGenerationTemplateId}")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.ConnectedSystem:
                            <MudLink Href="@($"/admin/connected-systems/{_activity.ConnectedSystemId}/")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.ConnectedSystemRunProfile when _connectedSystemHeader != null:
                            <MudLink Href="@($"/admin/connected-systems/{_activity.ConnectedSystemId}/")">@_connectedSystemHeader.Name</MudLink> @:/ @_activity.TargetName
                            break;
                        case ActivityTargetType.MetaverseObject when _metaverseObjectHeader != null:
                            <MudLink Href="@Utilities.GetMetaverseObjectHref(_metaverseObjectHeader)">@Utilities.GetMetaverseObjectHrefText(_metaverseObjectHeader)</MudLink>
                            break;
                        case ActivityTargetType.SyncRule:
                            <MudLink Href="@($"/admin/sync-rules/{_activity.SyncRuleId}")">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.TrustedCertificate:
                            <MudLink Href="/admin/certificates">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.MetaverseAttribute:
                            <MudLink Href="/admin/schema/metaverse">@_activity.TargetName</MudLink>
                            break;
                        case ActivityTargetType.HistoryRetentionCleanup:
                            <MudIcon Icon="@Icons.Material.Filled.CleaningServices" Class="mr-1" Style="vertical-align: middle;" />
                            @(_activity.TargetName ?? "History Retention Cleanup")
                            break;
                        case ActivityTargetType.ObjectMatchingRule:
                        case ActivityTargetType.NotSet:
                        default:
                            @(_activity.TargetName ?? "-")
                            break;
                    }
                </MudText>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.button" Class="mud-text-secondary">When:</MudText>
                <MudText title="@_activity.Created.ToLocalTime().ToFriendlyDate()">@_activity.Created.ToLocalTime().ToRelativeTime()</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" Class="mt-3">
                <MudText Typo="Typo.button" Class="mud-text-secondary">Initiated By:</MudText>
                @{
                    if (_activity.InitiatedByType == ActivityInitiatorType.User)
                    {
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-1" Style="vertical-align: middle;" />
                            @if (_activity.InitiatedById.HasValue)
                            {
                                <MudLink Href="@($"/identity/person/{_activity.InitiatedById.Value}")">@_activity.InitiatedByName</MudLink>
                            }
                            else
                            {
                                <span>@_activity.InitiatedByName</span>
                            }
                        </MudText>
                    }
                    else if (_activity.InitiatedByType == ActivityInitiatorType.ApiKey)
                    {
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Key" Class="mr-1" Style="vertical-align: middle;" />
                            @if (_activity.InitiatedById.HasValue)
                            {
                                <MudLink Href="@Utilities.GetApiKeyHref(_activity.InitiatedById.Value)">@_activity.InitiatedByName</MudLink>
                            }
                            else
                            {
                                <span>@_activity.InitiatedByName</span>
                            }
                        </MudText>
                    }
                    else if (_activity.InitiatedByType == ActivityInitiatorType.System)
                    {
                        <MudText>
                            <MudIcon Icon="@Icons.Material.Filled.Schedule" Class="mr-1" Style="vertical-align: middle;" />
                            <span>@(_activity.InitiatedByName ?? "System")</span>
                        </MudText>
                    }
                    else if (!string.IsNullOrEmpty(_activity.InitiatedByName))
                    {
                        <MudText>@_activity.InitiatedByName</MudText>
                    }
                }
            </MudItem>
            <MudItem xs="12" sm="6" md="4" Class="mt-3">
                <MudText Typo="Typo.button" Class="mud-text-secondary">Status:</MudText><br />
                <MudChip T="string" Variant="Variant.Text" Color="Helpers.GetActivityMudBlazorColorForStatus(_activity.Status)" Class="ml-0">@_activity.Status.ToString().SplitOnCapitalLetters()</MudChip>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" Class="mt-3">
                <MudText Typo="Typo.button" Class="mud-text-secondary">Execution Time:</MudText>
                <MudText>@(_activity.ExecutionTime?.ToAbbreviatedString() ?? "-")</MudText>
            </MudItem>
            <MudItem xs="12" sm="6" md="4" Class="mt-3">
                <MudText Typo="Typo.button" Class="mud-text-secondary">Total Activity Time:</MudText>
                <MudText>@(_activity.TotalActivityTime?.ToAbbreviatedString() ?? "-")</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (!string.IsNullOrEmpty(_activity.ErrorMessage) || !string.IsNullOrEmpty(_activity.ErrorStackTrace))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Class="mt-4 jim-alert-error">
            @if (!string.IsNullOrEmpty(_activity.ErrorMessage))
            {
                <MudText Typo="Typo.body1" Style="font-weight: 500;">@_activity.ErrorMessage</MudText>
            }

            @if (!string.IsNullOrEmpty(_activity.ErrorStackTrace))
            {
                <MudText Typo="Typo.button" Class="mt-3">Stack Trace:</MudText>
                <pre style="white-space: pre-wrap; word-wrap: break-word; overflow-x: auto; max-width: 100%; margin-top: 8px;">@_activity.ErrorStackTrace</pre>
            }
        </MudAlert>
    }

    @if (_activity.TargetType == ActivityTargetType.HistoryRetentionCleanup)
    {
        var csoCount = _activity.DeletedCsoChangeCount ?? 0;
        var mvoCount = _activity.DeletedMvoChangeCount ?? 0;
        var activityCount = _activity.DeletedActivityCount ?? 0;
        var totalDeleted = csoCount + mvoCount + activityCount;

        <MudText Typo="Typo.h5" Class="mt-5">Cleanup Summary</MudText>
        <MudText Typo="Typo.body2" Class="mud-text-secondary mt-2 mb-4">
            Automated retention cleanup removed expired change history and activity records.
            Retention periods can be configured in <MudLink Href="/admin/settings">Settings</MudLink>.
        </MudText>

        <MudStack Row="true" Class="mt-2 mb-5 flex-wrap" Spacing="3">
            @* Total card *@
            <MudPaper Class="pa-4" Outlined="true" Style="min-width: 120px;">
                <MudText Typo="Typo.button" Class="mud-text-secondary">Total Deleted</MudText>
                <MudText Typo="Typo.h4">@totalDeleted.ToString("N0")</MudText>
            </MudPaper>

            @* CSO Changes *@
            <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Orange.Default}; min-width: 120px;")">
                <MudText Typo="Typo.button" Class="mud-text-secondary">CSO Changes</MudText>
                <MudText Typo="Typo.h4" Color="Color.Warning">@csoCount.ToString("N0")</MudText>
            </MudPaper>

            @* MVO Changes *@
            <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Orange.Default}; min-width: 120px;")">
                <MudText Typo="Typo.button" Class="mud-text-secondary">MVO Changes</MudText>
                <MudText Typo="Typo.h4" Color="Color.Warning">@mvoCount.ToString("N0")</MudText>
            </MudPaper>

            @* Activities *@
            <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Orange.Default}; min-width: 120px;")">
                <MudText Typo="Typo.button" Class="mud-text-secondary">Activities</MudText>
                <MudText Typo="Typo.h4" Color="Color.Warning">@activityCount.ToString("N0")</MudText>
            </MudPaper>

            @* Date range card *@
            @if (_activity.DeletedRecordsFromDate.HasValue && _activity.DeletedRecordsToDate.HasValue)
            {
                <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Gray.Default}; min-width: 200px;")">
                    <MudText Typo="Typo.button" Class="mud-text-secondary">Oldest Record Deleted</MudText>
                    <MudText Typo="Typo.h6" title="@_activity.DeletedRecordsFromDate.Value.ToLocalTime().ToFriendlyDate()">
                        @_activity.DeletedRecordsFromDate.Value.ToLocalTime().ToRelativeTime()
                    </MudText>
                    <MudText Typo="Typo.button" Class="mud-text-secondary mt-3">Newest Record Deleted</MudText>
                    <MudText Typo="Typo.h6" title="@_activity.DeletedRecordsToDate.Value.ToLocalTime().ToFriendlyDate()">
                        @_activity.DeletedRecordsToDate.Value.ToLocalTime().ToRelativeTime()
                    </MudText>
                </MudPaper>
            }
        </MudStack>
    }

    @if (_activity.TargetType == ActivityTargetType.ConnectedSystemRunProfile && _activity.TargetOperationType == ActivityTargetOperationType.Execute && _preferencesLoaded)
    {
        @if (_activityRunProfileExecutionStats != null)
        {
            @* Summary Section *@
            <MudText Typo="Typo.h5" Class="mt-5">Stats</MudText>
            <MudStack Row="true" Class="mt-4 mb-5 flex-wrap" Spacing="3">
                @* Total card *@
                <MudPaper Class="pa-4" Outlined="true" Style="min-width: 120px;">
                    <MudText Typo="Typo.button" Class="mud-text-secondary">Total</MudText>
                    <MudText Typo="Typo.h4">@_activityRunProfileExecutionStats.TotalObjectChangeCount.ToString("N0")</MudText>
                </MudPaper>

                @* Import-specific cards *@
                @if (IsImportRun())
                {
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Green.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Added</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success">@_activityRunProfileExecutionStats.TotalCsoAdds.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Teal.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Updated</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Info">@_activityRunProfileExecutionStats.TotalCsoUpdates.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Red.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Deleted</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Error">@_activityRunProfileExecutionStats.TotalCsoDeletes.ToString("N0")</MudText>
                    </MudPaper>

                    @* Pending export confirmation stats - shown during confirming import *@
                    @if (_activityRunProfileExecutionStats.TotalPendingExportsConfirmed > 0)
                    {
                        <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Green.Default}; min-width: 120px;")">
                            <MudText Typo="Typo.button" Class="mud-text-secondary">Exports Confirmed</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Success">@_activityRunProfileExecutionStats.TotalPendingExportsConfirmed.ToString("N0")</MudText>
                        </MudPaper>
                    }
                    @if (_activityRunProfileExecutionStats.TotalPendingExportsRetrying > 0)
                    {
                        <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Orange.Default}; min-width: 120px;")">
                            <MudText Typo="Typo.button" Class="mud-text-secondary">Exports Retrying</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Warning">@_activityRunProfileExecutionStats.TotalPendingExportsRetrying.ToString("N0")</MudText>
                        </MudPaper>
                    }
                    @if (_activityRunProfileExecutionStats.TotalPendingExportsFailed > 0)
                    {
                        <MudPaper Class="pa-4" Outlined="true" Style="@($"background-color: {Colors.Red.Default}; color: {Colors.Shades.White}; border-left: 4px solid {Colors.Red.Darken3}; min-width: 120px;")">
                            <MudText Typo="Typo.button" Style="@($"color: {Colors.Shades.White};")">Exports Failed</MudText>
                            <MudText Typo="Typo.h4" Style="@($"color: {Colors.Shades.White};")">@_activityRunProfileExecutionStats.TotalPendingExportsFailed.ToString("N0")</MudText>
                        </MudPaper>
                    }
                }

                @* Sync-specific cards *@
                @if (IsSyncRun())
                {
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid var(--mud-palette-primary); min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Projected</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Primary">@_activityRunProfileExecutionStats.TotalProjections.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid var(--mud-palette-secondary); min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Joined</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Secondary">@_activityRunProfileExecutionStats.TotalJoins.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid var(--mud-palette-tertiary); min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Attribute Flow</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Tertiary">@_activityRunProfileExecutionStats.TotalAttributeFlows.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid var(--mud-palette-warning); min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Disconnected</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Warning">@_activityRunProfileExecutionStats.TotalDisconnections.ToString("N0")</MudText>
                    </MudPaper>

                    @* Drift Corrections - shown when drift was detected and corrective exports staged *@
                    @if (_activityRunProfileExecutionStats.TotalDriftCorrections > 0)
                    {
                        <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Orange.Default}; min-width: 120px;")">
                            <MudText Typo="Typo.button" Class="mud-text-secondary">Drift Correction</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Warning">@_activityRunProfileExecutionStats.TotalDriftCorrections.ToString("N0")</MudText>
                        </MudPaper>
                    }

                    @* Pending Exports - surfaced during sync to show what's awaiting confirmation *@
                    @if (_activityRunProfileExecutionStats.TotalPendingExports > 0)
                    {
                        <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Orange.Default}; min-width: 120px;")">
                            <MudText Typo="Typo.button" Class="mud-text-secondary">Pending Exports</MudText>
                            <MudText Typo="Typo.h4" Color="Color.Warning">@_activityRunProfileExecutionStats.TotalPendingExports.ToString("N0")</MudText>
                        </MudPaper>
                    }
                }

                @* Export-specific cards *@
                @if (IsExportRun())
                {
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Green.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Provisioned</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success">@_activityRunProfileExecutionStats.TotalProvisioned.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Teal.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Exported</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Info">@_activityRunProfileExecutionStats.TotalExported.ToString("N0")</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-4" Outlined="true" Style="@($"border-left: 4px solid {Colors.Red.Default}; min-width: 120px;")">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Deprovisioned</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Error">@_activityRunProfileExecutionStats.TotalDeprovisioned.ToString("N0")</MudText>
                    </MudPaper>
                }

                @* Unchanged card - always show *@
                <MudPaper Class="pa-4" Outlined="true" Style="border-left: 4px solid var(--mud-palette-grey-light); min-width: 120px;">
                    <MudText Typo="Typo.button" Class="mud-text-secondary">Unchanged</MudText>
                    <MudText Typo="Typo.h4" Class="mud-text-secondary">@_activityRunProfileExecutionStats.TotalUnchanged.ToString("N0")</MudText>
                </MudPaper>

                @* Object Types card *@
                <MudPaper Class="pa-4" Outlined="true" Style="min-width: 120px;">
                    <MudText Typo="Typo.button" Class="mud-text-secondary">Object Types</MudText>
                    <MudText Typo="Typo.h4">@_activityRunProfileExecutionStats.TotalObjectTypes.ToString("N0")</MudText>
                </MudPaper>

                @* Errors card - green border when 0, red background when > 0 *@
                <MudPaper Class="pa-4" Outlined="true"
                          Style="@(_activityRunProfileExecutionStats.TotalObjectErrors > 0
                                 ? $"background-color: {Colors.Red.Default}; color: {Colors.Shades.White}; border-left: 4px solid {Colors.Red.Darken3}; min-width: 120px;"
                                 : $"border-left: 4px solid {Colors.Green.Default}; min-width: 120px;")">
                    <MudText Typo="Typo.button" Class="mud-text-secondary" Style="@(_activityRunProfileExecutionStats.TotalObjectErrors > 0 ? $"color: {Colors.Shades.White};" : "")">Errors</MudText>
                    <MudText Typo="Typo.h4" Style="@(_activityRunProfileExecutionStats.TotalObjectErrors > 0 ? $"color: {Colors.Shades.White};" : "")">@_activityRunProfileExecutionStats.TotalObjectErrors.ToString("N0")</MudText>
                </MudPaper>
            </MudStack>
        }

        @* Results Section with Filter and Table *@
        <MudText Typo="Typo.h5">@Helpers.GetRunTypeResultsTitle(_activity.ConnectedSystemRunType)</MudText>

        @* Filter Chips Section *@
        @if (GetAvailableChangeTypes().Any() || GetAvailableObjectTypes().Any() || GetAvailableErrorTypes().Any())
        {
            <MudStack Row="true" Spacing="6" Class="mt-3 mb-3 flex-wrap" AlignItems="AlignItems.Start">
                @* Change Type Filter *@
                @if (GetAvailableChangeTypes().Any())
                {
                    <div>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary mb-2">Filter by Change Type:</MudText>
                        <MudChipSet T="ObjectChangeType"
                                    SelectionMode="SelectionMode.MultiSelection"
                                    SelectedValues="_selectedChangeTypes"
                                    SelectedValuesChanged="OnChangeTypeFilterChanged">
                            @foreach (var changeType in GetAvailableChangeTypes())
                            {
                                <MudChip Value="@changeType"
                                         Color="@(IsChangeTypeSelected(changeType) ? Color.Default : Helpers.GetRunItemMudBlazorColorForType(changeType))"
                                         Variant="@(IsChangeTypeSelected(changeType) ? Variant.Outlined : Variant.Text)"
                                         SelectedColor="@Helpers.GetRunItemMudBlazorColorForType(changeType)">
                                    @Helpers.GetChangeTypeDisplayName(changeType)
                                    @if (GetChangeTypeCount(changeType) is var count && count > 0)
                                    {
                                        <MudText Typo="Typo.caption" Class="ml-1">(@count.ToString("N0"))</MudText>
                                    }
                                </MudChip>
                            }
                            @* Disabled Unchanged chip *@
                            <MudChip T="ObjectChangeType"
                                     Variant="Variant.Text"
                                     Color="Color.Default"
                                     Disabled="true">
                                Unchanged
                                <MudText Typo="Typo.caption" Class="ml-1">(@GetUnchangedCount().ToString("N0"))</MudText>
                            </MudChip>
                        </MudChipSet>
                    </div>
                }

                @* External Object Type Filter *@
                @if (GetAvailableObjectTypes().Any())
                {
                    <div>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary mb-2">Filter by External Object Type:</MudText>
                        <MudChipSet T="string"
                                    SelectionMode="SelectionMode.MultiSelection"
                                    SelectedValues="_selectedObjectTypes"
                                    SelectedValuesChanged="OnObjectTypeFilterChanged">
                            @foreach (var objectType in GetAvailableObjectTypes())
                            {
                                <MudChip Value="@objectType.Key"
                                         Color="Color.Default"
                                         Variant="@(IsObjectTypeSelected(objectType.Key) ? Variant.Outlined : Variant.Text)"
                                         SelectedColor="Color.Default">
                                    @objectType.Key.SplitOnCapitalLetters()
                                    <MudText Typo="Typo.caption" Class="ml-1">(@objectType.Value.ToString("N0"))</MudText>
                                </MudChip>
                            }
                        </MudChipSet>
                    </div>
                }

                @* Error Type Filter *@
                @if (GetAvailableErrorTypes().Any())
                {
                    <div>
                        <MudText Typo="Typo.body2" Class="mud-text-secondary mb-2">Filter by Error Type:</MudText>
                        <MudChipSet T="ActivityRunProfileExecutionItemErrorType"
                                    SelectionMode="SelectionMode.MultiSelection"
                                    SelectedValues="_selectedErrorTypes"
                                    SelectedValuesChanged="OnErrorTypeFilterChanged">
                            @foreach (var errorType in GetAvailableErrorTypes())
                            {
                                <MudChip Value="@errorType.Key"
                                         Color="@(IsErrorTypeSelected(errorType.Key) ? Color.Default : Color.Error)"
                                         Variant="@(IsErrorTypeSelected(errorType.Key) ? Variant.Outlined : Variant.Text)"
                                         SelectedColor="Color.Error">
                                    @errorType.Key.ToString().SplitOnCapitalLetters()
                                    <MudText Typo="Typo.caption" Class="ml-1">(@errorType.Value.ToString("N0"))</MudText>
                                </MudChip>
                            }
                        </MudChipSet>
                    </div>
                }
            </MudStack>
        }

        <MudTable @ref="_table"
                  T="ActivityRunProfileExecutionItemHeader"
                  ServerData="ServerReload"
                  RowsPerPage="@_rowsPerPage"
                  RowsPerPageChanged="OnRowsPerPageChanged"
                  Hover="true"
                  Dense="true"
                  Breakpoint="Breakpoint.Sm"
                  Class="mt-3 mb-5"
                  Outlined="true"
                  Elevation="0"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary">
            <ToolBarContent>
                <MudSpacer />
                <MudTextField T="string"
                              ValueChanged="@(s => OnSearch(s))"
                              Variant="Variant.Outlined"
                              Placeholder="Search name, external ID, or object type"
                              Margin="Margin.Dense"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              IconSize="Size.Medium"
                              Class="mt-0"
                              Style="min-width: 300px;" />
            </ToolBarContent>
            <HeaderContent>
                <MudTh Style="width: 1px;"></MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="externalid" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">External Id</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="displayname" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Name</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="objecttype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">External Object Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="changetype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Change Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
                <MudTh>
                    <MudTableSortLabel SortLabel="errortype" T="ActivityRunProfileExecutionItemHeader">
                        <MudText Typo="Typo.button" Class="mud-text-secondary">Error Type</MudText>
                    </MudTableSortLabel>
                </MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudButton Variant="Variant.Outlined"
                               Size="Size.Small"
                               Color="Color.Primary"
                               Href="@($"/activity/item/{context.Id}")">View</MudButton>
                </MudTd>
                <MudTd DataLabel="External Id" Class="jim-text-code">@(!string.IsNullOrEmpty(context.ExternalIdValue) ? context.ExternalIdValue : "-")</MudTd>
                <MudTd DataLabel="Display Name">@(!string.IsNullOrEmpty(context.DisplayName) ? context.DisplayName : "-")</MudTd>
                <MudTd DataLabel="External Object Type">@(context.ConnectedSystemObjectType != null ? context.ConnectedSystemObjectType.ToString().SplitOnCapitalLetters() : "-")</MudTd>
                <MudTd DataLabel="Change Type">
                    <MudChip T="string" Variant="Variant.Text" Color="Helpers.GetRunItemMudBlazorColorForType(context.ObjectChangeType)">@context.ObjectChangeType.ToString().SplitOnCapitalLetters()</MudChip>
                </MudTd>
                <MudTd DataLabel="Error Type">
                    @if (context.ErrorType != null && context.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
                    {
                        <MudChip T="string" Variant="Variant.Text" Color="Color.Error">@context.ErrorType.Value.ToString().SplitOnCapitalLetters()</MudChip>
                    }
                    else
                    {
                        <span>-</span>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                @if (string.IsNullOrWhiteSpace(_searchString))
                {
                    <MudText>There are no sync results to show.</MudText>
                }
                else
                {
                    <MudText>No sync results found matching "@_searchString".</MudText>
                }
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
        </MudTable>
    }
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private MudTable<ActivityRunProfileExecutionItemHeader>? _table;
    private Activity? _activity;
    private ConnectedSystemHeader? _connectedSystemHeader;
    private MetaverseObjectHeader? _metaverseObjectHeader;
    private ActivityRunProfileExecutionStats? _activityRunProfileExecutionStats;
    private string _searchString = "";
    private bool _loading;
    private int _rowsPerPage = 10;
    private bool _preferencesLoaded;

    // Change type filter - when chips are selected, the table reloads with the filter applied
    private IReadOnlyCollection<ObjectChangeType> _selectedChangeTypes = new List<ObjectChangeType>();

    // Object type filter - when chips are selected, the table reloads with the filter applied
    private IReadOnlyCollection<string> _selectedObjectTypes = new List<string>();

    // Error type filter - when chips are selected, the table reloads with the filter applied
    private IReadOnlyCollection<ActivityRunProfileExecutionItemErrorType> _selectedErrorTypes = new List<ActivityRunProfileExecutionItemErrorType>();

    private readonly List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new("Home", href: "/", icon: Icons.Material.Filled.Home),
        new("Activity", href: "/activity"),
        new("Activity Detail", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        _activity = await Jim.Activities.GetActivityAsync(Id);
        if (_activity == null)
        {
            NavManager.NavigateTo("../");
            return;
        }

        // Note: These queries run sequentially because EF Core's DbContext is not thread-safe.
        // The main performance win comes from the optimised GROUP BY query in GetActivityRunProfileExecutionStatsAsync.
        if (_activity.ConnectedSystemId.HasValue)
            _connectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(_activity.ConnectedSystemId.Value);

        if (_activity.TargetType is ActivityTargetType.MetaverseObject or ActivityTargetType.ConnectedSystemRunProfile && _activity.MetaverseObjectId != null)
            _metaverseObjectHeader = await Jim.Metaverse.GetMetaverseObjectHeaderAsync(_activity.MetaverseObjectId.Value);

        if (_activity.TargetType == ActivityTargetType.ConnectedSystemRunProfile && _activity.TargetOperationType == ActivityTargetOperationType.Execute)
            _activityRunProfileExecutionStats = await Jim.Activities.GetActivityRunProfileExecutionStatsAsync(_activity.Id);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_preferencesLoaded)
        {
            try
            {
                var preferredSize = await PreferenceService.GetRowsPerPageAsync();
                _rowsPerPage = preferredSize;
                _preferencesLoaded = true;
                StateHasChanged(); // Re-render to show the table now that preference is loaded
            }
            catch
            {
                // JS interop not yet available, will retry on next render
            }
        }
    }

    private async Task OnRowsPerPageChanged(int newSize)
    {
        _rowsPerPage = newSize;
        await PreferenceService.SetRowsPerPageAsync(newSize);
    }

    private async Task<TableData<ActivityRunProfileExecutionItemHeader>> ServerReload(TableState state, CancellationToken token)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Convert MudBlazor's 0-indexed page to our 1-indexed page
            var page = state.Page + 1;
            var sortDescending = state.SortDirection == SortDirection.Descending;

            // Get selected change types for filtering (null means show all)
            IEnumerable<ObjectChangeType>? changeTypeFilter = _selectedChangeTypes.Count > 0 ? _selectedChangeTypes : null;

            // Get selected object types for filtering (null means show all)
            IEnumerable<string>? objectTypeFilter = _selectedObjectTypes.Count > 0 ? _selectedObjectTypes : null;

            // Get selected error types for filtering (null means show all)
            IEnumerable<ActivityRunProfileExecutionItemErrorType>? errorTypeFilter = _selectedErrorTypes.Count > 0 ? _selectedErrorTypes : null;

            var result = await Jim.Activities.GetActivityRunProfileExecutionItemHeadersAsync(
                Id,
                page,
                state.PageSize,
                string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                state.SortLabel,
                sortDescending,
                changeTypeFilter,
                objectTypeFilter,
                errorTypeFilter);

            return new TableData<ActivityRunProfileExecutionItemHeader>
            {
                TotalItems = result.TotalResults,
                Items = result.Results
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _table?.ReloadServerData();
    }

    private void OnChangeTypeFilterChanged(IReadOnlyCollection<ObjectChangeType> selectedTypes)
    {
        _selectedChangeTypes = selectedTypes;
        _table?.ReloadServerData();
    }

    private void OnObjectTypeFilterChanged(IReadOnlyCollection<string> selectedTypes)
    {
        _selectedObjectTypes = selectedTypes;
        _table?.ReloadServerData();
    }

    private void OnErrorTypeFilterChanged(IReadOnlyCollection<ActivityRunProfileExecutionItemErrorType> selectedTypes)
    {
        _selectedErrorTypes = selectedTypes;
        _table?.ReloadServerData();
    }

    /// <summary>
    /// Returns the object types that have at least one RPEI in this activity, ordered by name.
    /// </summary>
    private IEnumerable<KeyValuePair<string, int>> GetAvailableObjectTypes()
    {
        if (_activityRunProfileExecutionStats == null)
            return Enumerable.Empty<KeyValuePair<string, int>>();

        return _activityRunProfileExecutionStats.ObjectTypeCounts
            .OrderBy(x => x.Key);
    }

    /// <summary>
    /// Checks if an object type is currently selected in the filter.
    /// </summary>
    private bool IsObjectTypeSelected(string objectType)
    {
        return _selectedObjectTypes.Contains(objectType);
    }

    /// <summary>
    /// Returns the error types that have at least one RPEI in this activity, ordered by count descending.
    /// </summary>
    private IEnumerable<KeyValuePair<ActivityRunProfileExecutionItemErrorType, int>> GetAvailableErrorTypes()
    {
        if (_activityRunProfileExecutionStats == null)
            return Enumerable.Empty<KeyValuePair<ActivityRunProfileExecutionItemErrorType, int>>();

        return _activityRunProfileExecutionStats.ErrorTypeCounts
            .OrderByDescending(x => x.Value);
    }

    /// <summary>
    /// Checks if an error type is currently selected in the filter.
    /// </summary>
    private bool IsErrorTypeSelected(ActivityRunProfileExecutionItemErrorType errorType)
    {
        return _selectedErrorTypes.Contains(errorType);
    }

    /// <summary>
    /// Returns the change types that have at least one RPEI in this activity.
    /// Shows all possible change types with non-zero counts first, ordered logically.
    /// </summary>
    private IEnumerable<ObjectChangeType> GetAvailableChangeTypes()
    {
        if (_activityRunProfileExecutionStats == null)
            return Enumerable.Empty<ObjectChangeType>();

        // Return change types in logical order: Import → Sync → Export → Other
        var availableTypes = new List<ObjectChangeType>();

        // Import operations
        if (_activityRunProfileExecutionStats.TotalCsoAdds > 0)
            availableTypes.Add(ObjectChangeType.Added);
        if (_activityRunProfileExecutionStats.TotalCsoUpdates > 0)
            availableTypes.Add(ObjectChangeType.Updated);
        if (_activityRunProfileExecutionStats.TotalCsoDeletes > 0)
            availableTypes.Add(ObjectChangeType.Deleted);

        // Sync operations
        if (_activityRunProfileExecutionStats.TotalProjections > 0)
            availableTypes.Add(ObjectChangeType.Projected);
        if (_activityRunProfileExecutionStats.TotalJoins > 0)
            availableTypes.Add(ObjectChangeType.Joined);
        if (_activityRunProfileExecutionStats.TotalAttributeFlows > 0)
            availableTypes.Add(ObjectChangeType.AttributeFlow);
        if (_activityRunProfileExecutionStats.TotalDisconnections > 0)
            availableTypes.Add(ObjectChangeType.Disconnected);
        if (_activityRunProfileExecutionStats.TotalDriftCorrections > 0)
            availableTypes.Add(ObjectChangeType.DriftCorrection);

        // Export operations
        if (_activityRunProfileExecutionStats.TotalProvisioned > 0)
            availableTypes.Add(ObjectChangeType.Provisioned);
        if (_activityRunProfileExecutionStats.TotalExported > 0)
            availableTypes.Add(ObjectChangeType.Exported);
        if (_activityRunProfileExecutionStats.TotalDeprovisioned > 0)
            availableTypes.Add(ObjectChangeType.Deprovisioned);

        // Pending export visibility (surfaced during sync)
        if (_activityRunProfileExecutionStats.TotalPendingExports > 0)
            availableTypes.Add(ObjectChangeType.PendingExport);

        // Note: NoChange RPEIs are filtered out from GetAvailableChangeTypes
        // as unchanged objects are shown separately via TotalUnchanged

        return availableTypes;
    }

    /// <summary>
    /// Gets the count of RPEIs for a specific change type from the stats.
    /// </summary>
    private int GetChangeTypeCount(ObjectChangeType changeType)
    {
        if (_activityRunProfileExecutionStats == null)
            return 0;

        return changeType switch
        {
            ObjectChangeType.Added => _activityRunProfileExecutionStats.TotalCsoAdds,
            ObjectChangeType.Updated => _activityRunProfileExecutionStats.TotalCsoUpdates,
            ObjectChangeType.Deleted => _activityRunProfileExecutionStats.TotalCsoDeletes,
            ObjectChangeType.Projected => _activityRunProfileExecutionStats.TotalProjections,
            ObjectChangeType.Joined => _activityRunProfileExecutionStats.TotalJoins,
            ObjectChangeType.AttributeFlow => _activityRunProfileExecutionStats.TotalAttributeFlows,
            ObjectChangeType.Disconnected => _activityRunProfileExecutionStats.TotalDisconnections,
            ObjectChangeType.DriftCorrection => _activityRunProfileExecutionStats.TotalDriftCorrections,
            ObjectChangeType.Provisioned => _activityRunProfileExecutionStats.TotalProvisioned,
            ObjectChangeType.Exported => _activityRunProfileExecutionStats.TotalExported,
            ObjectChangeType.Deprovisioned => _activityRunProfileExecutionStats.TotalDeprovisioned,
            ObjectChangeType.PendingExport => _activityRunProfileExecutionStats.TotalPendingExports,
            ObjectChangeType.NoChange => 0, // NoChange items shown via TotalUnchanged
            _ => 0
        };
    }

    /// <summary>
    /// Checks if a change type is currently selected in the filter.
    /// </summary>
    private bool IsChangeTypeSelected(ObjectChangeType changeType)
    {
        return _selectedChangeTypes.Contains(changeType);
    }

    /// <summary>
    /// Gets the relevant change types for the current run type.
    /// Returns all possible change types for the run type, not just those with counts > 0.
    /// </summary>
    private IEnumerable<ObjectChangeType> GetRelevantChangeTypes()
    {
        return Helpers.GetChangeTypesForRunType(_activity?.ConnectedSystemRunType);
    }

    /// <summary>
    /// Checks if this is an Import run (Full or Delta).
    /// Falls back to checking if import stats are populated when run type is NotSet.
    /// </summary>
    private bool IsImportRun()
    {
        var runType = _activity?.ConnectedSystemRunType;
        if (runType is ConnectedSystemRunType.FullImport or ConnectedSystemRunType.DeltaImport)
            return true;

        // Fallback: check if this looks like an import based on stats or target name
        if (runType is null or ConnectedSystemRunType.NotSet)
        {
            // Check if the target name contains "Import" or if import stats exist
            if (_activity?.TargetName?.Contains("Import", StringComparison.OrdinalIgnoreCase) == true)
                return true;
            // If there are CSO adds/updates/deletes but no sync or export stats, it's likely import
            if (_activityRunProfileExecutionStats != null &&
                (_activityRunProfileExecutionStats.TotalCsoAdds > 0 ||
                 _activityRunProfileExecutionStats.TotalCsoUpdates > 0 ||
                 _activityRunProfileExecutionStats.TotalCsoDeletes > 0) &&
                _activityRunProfileExecutionStats.TotalProjections == 0 &&
                _activityRunProfileExecutionStats.TotalProvisioned == 0)
                return true;
        }

        return false;
    }

    /// <summary>
    /// Checks if this is a Sync run (Full or Delta).
    /// </summary>
    private bool IsSyncRun()
    {
        var runType = _activity?.ConnectedSystemRunType;
        if (runType is ConnectedSystemRunType.FullSynchronisation or ConnectedSystemRunType.DeltaSynchronisation)
            return true;

        // Fallback: check if this looks like a sync based on stats or target name
        if (runType is null or ConnectedSystemRunType.NotSet)
        {
            if (_activity?.TargetName?.Contains("Sync", StringComparison.OrdinalIgnoreCase) == true)
                return true;
            if (_activityRunProfileExecutionStats != null &&
                (_activityRunProfileExecutionStats.TotalProjections > 0 ||
                 _activityRunProfileExecutionStats.TotalJoins > 0 ||
                 _activityRunProfileExecutionStats.TotalAttributeFlows > 0 ||
                 _activityRunProfileExecutionStats.TotalDisconnections > 0))
                return true;
        }

        return false;
    }

    /// <summary>
    /// Checks if this is an Export run.
    /// </summary>
    private bool IsExportRun()
    {
        var runType = _activity?.ConnectedSystemRunType;
        if (runType == ConnectedSystemRunType.Export)
            return true;

        // Fallback: check if this looks like an export based on stats or target name
        if (runType is null or ConnectedSystemRunType.NotSet)
        {
            if (_activity?.TargetName?.Contains("Export", StringComparison.OrdinalIgnoreCase) == true)
                return true;
            if (_activityRunProfileExecutionStats != null &&
                (_activityRunProfileExecutionStats.TotalProvisioned > 0 ||
                 _activityRunProfileExecutionStats.TotalExported > 0 ||
                 _activityRunProfileExecutionStats.TotalDeprovisioned > 0))
                return true;
        }

        return false;
    }

    /// <summary>
    /// Gets the unchanged count safely.
    /// </summary>
    private int GetUnchangedCount()
    {
        return _activityRunProfileExecutionStats?.TotalUnchanged ?? 0;
    }

    /// <summary>
    /// Converts a MudBlazor Color to its CSS variable name suffix.
    /// </summary>
    private static string GetColorCssName(Color color)
    {
        return color switch
        {
            Color.Primary => "primary",
            Color.Secondary => "secondary",
            Color.Tertiary => "tertiary",
            Color.Info => "info",
            Color.Success => "success",
            Color.Warning => "warning",
            Color.Error => "error",
            Color.Dark => "dark",
            Color.Surface => "surface",
            _ => "default"
        };
    }

    /// <summary>
    /// Whether to show the target name in the page title. Some activity types have self-descriptive
    /// type names that make the target name redundant (e.g. HistoryRetentionCleanup).
    /// </summary>
    private bool ShowTargetInTitle()
    {
        return _activity?.TargetType != ActivityTargetType.HistoryRetentionCleanup;
    }

    /// <summary>
    /// Gets the display text for the target, including context if available.
    /// </summary>
    private string GetTargetDisplayText()
    {
        if (_activity == null)
            return "(no name)";

        var targetName = !string.IsNullOrEmpty(_activity.TargetName) ? _activity.TargetName : "(no name)";

        if (!string.IsNullOrEmpty(_activity.TargetContext))
            return $"{_activity.TargetContext} → {targetName}";

        return targetName;
    }
}
