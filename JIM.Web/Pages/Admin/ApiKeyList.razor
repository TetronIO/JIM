@page "/admin/apikeys"
@attribute [Authorize(Roles = "Administrators")]
@using JIM.Application
@using JIM.Models.Security
@using JIM.Web.Middleware.Api
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime

<PageTitle>API Keys</PageTitle>
<MudText Typo="Typo.h4">API Keys</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>
<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
    Manage API keys for non-interactive authentication. API keys can be used for CI/CD pipelines,
    integration testing, and automation scripts.
</MudText>

<MudPaper Elevation="0" Class="mt-5 pa-4" Outlined="true">
    <MudText Typo="Typo.h6">Create API Key</MudText>
    <MudText Typo="Typo.body2" Class="mud-text-secondary mt-2">
        Create a new API key for automated access to the JIM API.
    </MudText>
    <MudButton OnClick="ShowCreateDialog" StartIcon="@Icons.Material.Filled.Add"
               Variant="Variant.Outlined" Class="mt-3">Create API Key</MudButton>
</MudPaper>

<MudTable Items="@_apiKeys" Hover="true" Breakpoint="Breakpoint.Sm" Class="mt-5 mb-5" SortLabel="Sort By"
          Filter="new Func<ApiKey,bool>(FilterFunc)" Outlined="true" Elevation="0" Loading="@_loading">
    <ToolBarContent>
        <MudText Typo="Typo.h6">API Keys</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>Actions</MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ApiKey, object>(x => x.Name)"><MudText Typo="Typo.button">Name</MudText></MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ApiKey, object>(x => x.KeyPrefix)"><MudText Typo="Typo.button">Key Prefix</MudText></MudTableSortLabel></MudTh>
        <MudTh><MudText Typo="Typo.button">Roles</MudText></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ApiKey, object>(x => x.LastUsedAt ?? DateTime.MinValue)"><MudText Typo="Typo.button">Last Used</MudText></MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ApiKey, object>(x => x.ExpiresAt ?? DateTime.MaxValue)"><MudText Typo="Typo.button">Expires</MudText></MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ApiKey, object>(x => x.IsEnabled)"><MudText Typo="Typo.button">Status</MudText></MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="_ => ShowEditDialog(context)">Edit</MudMenuItem>
                <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="_ => HandleDeleteAsync(context)">Delete</MudMenuItem>
            </MudMenu>
        </MudTd>
        <MudTd DataLabel="Name">
            <MudText Typo="Typo.body2">@context.Name</MudText>
            @if (!string.IsNullOrEmpty(context.Description))
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.Description</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Key Prefix">
            <MudText Typo="Typo.body2" Class="mud-text-code">@context.KeyPrefix...</MudText>
        </MudTd>
        <MudTd DataLabel="Roles">
            @foreach (var role in context.Roles)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="mr-1">@role.Name</MudChip>
            }
            @if (context.Roles.Count == 0)
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary">No roles</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Last Used">
            @if (context.LastUsedAt.HasValue)
            {
                <MudTooltip Text="@($"From IP: {context.LastUsedFromIp ?? "Unknown"}")">
                    <MudText Typo="Typo.body2">@context.LastUsedAt.Value.ToString("yyyy-MM-dd HH:mm")</MudText>
                </MudTooltip>
            }
            else
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary">Never</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Expires">
            @if (context.ExpiresAt.HasValue)
            {
                @if (context.ExpiresAt.Value < DateTime.UtcNow)
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Error">Expired</MudChip>
                }
                else if (context.ExpiresAt.Value < DateTime.UtcNow.AddDays(30))
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Warning">@((context.ExpiresAt.Value - DateTime.UtcNow).Days) days</MudChip>
                }
                else
                {
                    <MudText Typo="Typo.body2">@context.ExpiresAt.Value.ToString("yyyy-MM-dd")</MudText>
                }
            }
            else
            {
                <MudText Typo="Typo.caption" Class="mud-text-secondary">Never</MudText>
            }
        </MudTd>
        <MudTd DataLabel="Status">
            @if (context.IsEnabled)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Success">Enabled</MudChip>
            }
            else
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Default">Disabled</MudChip>
            }
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudText>No API keys have been created yet.</MudText>
    </NoRecordsContent>
</MudTable>

@* Create API Key Dialog *@
<MudDialog @bind-Visible="_createDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Key" Class="mr-3" /> Create API Key
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField T="string" @bind-Value="_createName" Label="Name" Required="true"
                      RequiredError="A name is required" Variant="Variant.Outlined" Class="mt-3"
                      HelperText="A friendly name for this API key (e.g., 'CI/CD Pipeline')" />
        <MudTextField T="string" @bind-Value="_createDescription" Label="Description" Lines="2"
                      Variant="Variant.Outlined" Class="mt-4"
                      HelperText="Optional description of what this key is used for" />
        <MudText Typo="Typo.subtitle2" Class="mt-5 mb-2">Roles</MudText>
        <MudText Typo="Typo.caption" Class="mud-text-secondary mb-2">
            Select the roles to assign to this API key. Roles determine what actions the key can perform.
        </MudText>
        @foreach (var role in _availableRoles)
        {
            <MudCheckBox T="bool" Value="@_createSelectedRoleIds.Contains(role.Id)"
                         ValueChanged="@(value => ToggleRole(role.Id, value))"
                         Label="@role.Name" Class="ml-n2" />
        }
        <MudDatePicker @bind-Date="_createExpiresAt" Label="Expires (Optional)"
                       Variant="Variant.Outlined" Class="mt-4"
                       HelperText="Leave empty for no expiration" Clearable="true" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _createDialogVisible = false" DropShadow="false">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" DropShadow="false"
                   Disabled="@(string.IsNullOrWhiteSpace(_createName) || _creating)"
                   OnClick="HandleCreateAsync">
            @if (_creating)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Creating</MudText>
            }
            else
            {
                <MudText>Create</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@* Created Key Dialog (shows full key once) *@
<MudDialog @bind-Visible="_createdKeyDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Class="mr-3" /> API Key Created
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            Copy this API key now. You won't be able to see it again!
        </MudAlert>
        <MudTextField T="string" Value="@_createdFullKey" Label="API Key" ReadOnly="true"
                      Variant="Variant.Outlined" Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                      OnAdornmentClick="CopyKeyToClipboard" />
        <MudText Typo="Typo.caption" Class="mud-text-secondary mt-2">
            Use this key in the X-API-Key header when making API requests.
        </MudText>
        <MudText Typo="Typo.body2" Class="mt-4">
            <strong>Example usage:</strong>
        </MudText>
        <MudPaper Elevation="0" Class="pa-3 mt-2" Style="background-color: var(--mud-palette-background-gray);">
            <MudText Typo="Typo.body2" Class="mud-text-code" Style="white-space: pre-wrap; word-break: break-all;">
curl -H "X-API-Key: @_createdFullKey" \
     https://your-jim-server/api/v1/metaverse/objects</MudText>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" DropShadow="false"
                   OnClick="() => _createdKeyDialogVisible = false">Done</MudButton>
    </DialogActions>
</MudDialog>

@* Edit API Key Dialog *@
<MudDialog @bind-Visible="_editDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3" /> Edit API Key
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField T="string" @bind-Value="_editName" Label="Name" Required="true"
                      RequiredError="A name is required" Variant="Variant.Outlined" Class="mt-3" />
        <MudTextField T="string" @bind-Value="_editDescription" Label="Description" Lines="2"
                      Variant="Variant.Outlined" Class="mt-4" />
        <MudText Typo="Typo.subtitle2" Class="mt-5 mb-2">Roles</MudText>
        @foreach (var role in _availableRoles)
        {
            <MudCheckBox T="bool" Value="@_editSelectedRoleIds.Contains(role.Id)"
                         ValueChanged="@(value => ToggleEditRole(role.Id, value))"
                         Label="@role.Name" Class="ml-n2" />
        }
        <MudDatePicker @bind-Date="_editExpiresAt" Label="Expires (Optional)"
                       Variant="Variant.Outlined" Class="mt-4"
                       HelperText="Leave empty for no expiration" Clearable="true" />
        <MudSwitch @bind-Value="_editEnabled" Color="Color.Primary" Label="Enabled" Class="mt-4" />
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="() => _editDialogVisible = false" DropShadow="false">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" DropShadow="false"
                   Disabled="@(string.IsNullOrWhiteSpace(_editName) || _saving)"
                   OnClick="HandleSaveEditAsync">
            @if (_saving)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Saving</MudText>
            }
            else
            {
                <MudText>Save Changes</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<ApiKey>? _apiKeys;
    private List<Role> _availableRoles = new();
    private string _searchString = "";
    private bool _loading = true;

    private readonly List<BreadcrumbItem> _breadcrumbs = new()
    {
        new("Home", href: "/", icon: Icons.Material.Filled.Home),
        new("Admin", href: "/admin/operations"),
        new("API Keys", href: null, disabled: true)
    };

    private readonly DialogOptions _dialogOptions = new() { FullWidth = true, MaxWidth = MaxWidth.Small };

    // Create dialog
    private bool _createDialogVisible;
    private string _createName = "";
    private string _createDescription = "";
    private List<int> _createSelectedRoleIds = new();
    private DateTime? _createExpiresAt;
    private bool _creating;

    // Created key dialog
    private bool _createdKeyDialogVisible;
    private string _createdFullKey = "";

    // Edit dialog
    private bool _editDialogVisible;
    private ApiKey? _editingKey;
    private string _editName = "";
    private string _editDescription = "";
    private List<int> _editSelectedRoleIds = new();
    private DateTime? _editExpiresAt;
    private bool _editEnabled;
    private bool _saving;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        _apiKeys = await Jim.Repository.ApiKeys.GetAllAsync();
        _availableRoles = await Jim.Security.GetRolesAsync();
        _loading = false;
    }

    private bool FilterFunc(ApiKey element)
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;

        if (element.Name.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (element.KeyPrefix.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        if (element.Description?.Contains(_searchString, StringComparison.OrdinalIgnoreCase) == true)
            return true;

        return false;
    }

    private void ShowCreateDialog()
    {
        _createName = "";
        _createDescription = "";
        _createSelectedRoleIds = new List<int>();
        _createExpiresAt = null;
        _createDialogVisible = true;
    }

    private void ToggleRole(int roleId, bool selected)
    {
        if (selected && !_createSelectedRoleIds.Contains(roleId))
            _createSelectedRoleIds.Add(roleId);
        else if (!selected)
            _createSelectedRoleIds.Remove(roleId);
    }

    private void ToggleEditRole(int roleId, bool selected)
    {
        if (selected && !_editSelectedRoleIds.Contains(roleId))
            _editSelectedRoleIds.Add(roleId);
        else if (!selected)
            _editSelectedRoleIds.Remove(roleId);
    }

    private async Task HandleCreateAsync()
    {
        if (string.IsNullOrWhiteSpace(_createName))
            return;

        _creating = true;
        StateHasChanged();

        try
        {
            // Generate the API key
            var (fullKey, keyPrefix) = ApiKeyAuthenticationHandler.GenerateApiKey();
            var keyHash = ApiKeyAuthenticationHandler.HashApiKey(fullKey);

            // Get the roles
            var roles = _availableRoles.Where(r => _createSelectedRoleIds.Contains(r.Id)).ToList();

            // Create the API key entity
            var apiKey = new ApiKey
            {
                Id = Guid.NewGuid(),
                Name = _createName,
                Description = string.IsNullOrWhiteSpace(_createDescription) ? null : _createDescription,
                KeyHash = keyHash,
                KeyPrefix = keyPrefix,
                ExpiresAt = _createExpiresAt?.ToUniversalTime(),
                Roles = roles
            };

            await Jim.Repository.ApiKeys.CreateAsync(apiKey);

            Snackbar.Add("API key created successfully.", Severity.Success);
            _createDialogVisible = false;

            // Show the created key dialog
            _createdFullKey = fullKey;
            _createdKeyDialogVisible = true;

            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to create API key: {ex.Message}", Severity.Error);
        }
        finally
        {
            _creating = false;
        }
    }

    private async Task CopyKeyToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", _createdFullKey);
            Snackbar.Add("API key copied to clipboard.", Severity.Info);
        }
        catch
        {
            Snackbar.Add("Failed to copy to clipboard. Please copy manually.", Severity.Warning);
        }
    }

    private void ShowEditDialog(ApiKey apiKey)
    {
        _editingKey = apiKey;
        _editName = apiKey.Name;
        _editDescription = apiKey.Description ?? "";
        _editSelectedRoleIds = apiKey.Roles.Select(r => r.Id).ToList();
        _editExpiresAt = apiKey.ExpiresAt?.ToLocalTime();
        _editEnabled = apiKey.IsEnabled;
        _editDialogVisible = true;
    }

    private async Task HandleSaveEditAsync()
    {
        if (_editingKey == null || string.IsNullOrWhiteSpace(_editName))
            return;

        _saving = true;
        StateHasChanged();

        try
        {
            // Create a new ApiKey object with updated values to avoid EF tracking issues
            // The repository will fetch the actual entity and update it
            var updatedKey = new ApiKey
            {
                Id = _editingKey.Id,
                Name = _editName,
                Description = string.IsNullOrWhiteSpace(_editDescription) ? null : _editDescription,
                ExpiresAt = _editExpiresAt?.ToUniversalTime(),
                IsEnabled = _editEnabled,
                // Create stub Role objects with just IDs - the repository will fetch the real ones
                Roles = _editSelectedRoleIds.Select(id => new Role { Id = id }).ToList()
            };

            await Jim.Repository.ApiKeys.UpdateAsync(updatedKey);

            Snackbar.Add("API key updated successfully.", Severity.Success);
            _editDialogVisible = false;
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to update API key: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task HandleDeleteAsync(ApiKey apiKey)
    {
        var result = await DialogService.ShowMessageBox(
            "Delete API Key",
            $"Are you sure you want to delete the API key '{apiKey.Name}'? Any requests using this key will immediately fail.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (result != true)
            return;

        try
        {
            await Jim.Repository.ApiKeys.DeleteAsync(apiKey.Id);

            Snackbar.Add("API key deleted successfully.", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete API key: {ex.Message}", Severity.Error);
        }
    }
}
