@page "/activity/sync/{Id:guid}"
@attribute [Authorize(Roles = "User")]
@using JIM.Application
@using JIM.Models.Activities;
@using JIM.Models.Enums;
@using JIM.Models.Staging
@using JIM.Models.Staging.DTOs
@using JIM.Utilities;
@inject JimApplication Jim
@inject NavigationManager NavManager

<PageTitle>Sync Details: @(_externalIdAttributeValue?.ToStringNoName() ?? _activityRunProfileExecutionItem?.Id.ToString())</PageTitle>

@if (_activityRunProfileExecutionItem != null)
{
    @* Status Banner *@
    <MudPaper Class="pa-4 mb-4"
              Style="@GetStatusBannerStyle()"
              Elevation="0">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
            <MudIcon Icon="@GetStatusIcon()" Size="Size.Large" />
            <div>
                <MudText Typo="Typo.h5" Style="color: inherit;">
                    @GetStatusTitle()
                </MudText>
                <MudText Typo="Typo.body2" Style="color: inherit; opacity: 0.9;">
                    @GetStatusDescription()
                </MudText>
            </div>
        </MudStack>
    </MudPaper>

    <MudBreadcrumbs Items="_breadcrumbs" Class="ps-0 mb-4"></MudBreadcrumbs>

    @* Summary Section *@
    <MudText Typo="Typo.h6" Class="mb-3">
        Execution Summary
    </MudText>
    <MudPaper Class="pa-5 mb-5" Outlined="true">
        <MudGrid Spacing="3">
            @* Connected System *@
            @if (_connectedSystemHeader != null)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.overline" Class="mud-text-secondary">Connected System</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Small" Class="mud-text-secondary" />
                        <MudLink Href="@Utilities.GetConnectedSystemHref(_connectedSystemHeader)" Typo="Typo.body1">
                            @_connectedSystemHeader.Name
                        </MudLink>
                    </MudStack>
                </MudItem>
            }

            @* Run Profile *@
            @if (_activity != null)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.overline" Class="mud-text-secondary">Run Profile</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Small" Class="mud-text-secondary" />
                        <MudText Typo="Typo.body1">@_activity.TargetName</MudText>
                    </MudStack>
                </MudItem>

                <MudItem xs="12" sm="6" md="4">
                    <MudText Typo="Typo.overline" Class="mud-text-secondary">Executed</MudText>
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mud-text-secondary" />
                        <MudText Typo="Typo.body1" title="@_activity.Executed.ToLocalTime().ToString("F")">
                            @_activity.Executed.ToLocalTime().ToRelativeTime()
                        </MudText>
                    </MudStack>
                </MudItem>
            }

            @* Initiated By *@
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.overline" Class="mud-text-secondary">Initiated By</MudText>
                @if (_activity is { InitiatedByType: ActivityInitiatorType.User, InitiatedByMetaverseObject: not null })
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" Class="mud-text-secondary" />
                        <MudLink Href="@(Utilities.GetMetaverseObjectHref(_activity.InitiatedByMetaverseObject))" Typo="Typo.body1">
                            @_activity.InitiatedByMetaverseObject.DisplayName
                        </MudLink>
                    </MudStack>
                }
                else if (_activity is { InitiatedByType: ActivityInitiatorType.ApiKey })
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Small" Class="mud-text-secondary" />
                        @if (_activity.InitiatedByApiKey != null)
                        {
                            <MudLink Href="@Utilities.GetApiKeyHref(_activity.InitiatedByApiKey.Id)" Typo="Typo.body1">
                                @_activity.InitiatedByName
                            </MudLink>
                        }
                        else
                        {
                            <MudText Typo="Typo.body1">@_activity.InitiatedByName</MudText>
                        }
                    </MudStack>
                }
                else if (_activity != null && !string.IsNullOrEmpty(_activity.InitiatedByName))
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Class="mud-text-secondary" />
                        <MudText Typo="Typo.body1">@_activity.InitiatedByName</MudText>
                    </MudStack>
                }
                else
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.SmartToy" Size="Size.Small" Class="mud-text-secondary" />
                        <MudText Typo="Typo.body1">System (Automated)</MudText>
                    </MudStack>
                }
            </MudItem>

            @* Change Type *@
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.overline" Class="mud-text-secondary">Operation</MudText><br />
                <MudChip T="string"
                         Color="@Helpers.GetRunItemMudBlazorColorForType(_activityRunProfileExecutionItem.ObjectChangeType)"
                         Variant="Variant.Filled"
                         Size="Size.Medium"
                         Icon="@GetChangeTypeIcon()"
                         Class="ml-0 mt-1">
                    @_activityRunProfileExecutionItem.ObjectChangeType.ToString().SplitOnCapitalLetters()
                </MudChip>
            </MudItem>

            @* Connected System Object *@
            <MudItem xs="12" sm="6" md="4">
                <MudText Typo="Typo.overline" Class="mud-text-secondary">Connected System Object</MudText>
                @if (_activityRunProfileExecutionItem.ConnectedSystemObject != null)
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="flex-wrap">
                        <MudChip T="string" Color="Color.Default">
                            @_activityRunProfileExecutionItem.ConnectedSystemObject.Type.Name
                        </MudChip>
                        @if (_externalIdAttributeValue != null)
                        {
                            <MudLink Href="@(Utilities.GetConnectedSystemObjectHref(_activityRunProfileExecutionItem.ConnectedSystemObject))"
                                     Class="jim-text-code">
                                @_externalIdAttributeValue.ToStringNoName()
                            </MudLink>
                        }
                        else
                        {
                            <MudLink Href="@(Utilities.GetConnectedSystemObjectHref(_activityRunProfileExecutionItem.ConnectedSystemObject))">
                                View Object
                            </MudLink>
                        }
                    </MudStack>
                }
                else if (!string.IsNullOrEmpty(_activityRunProfileExecutionItem.ExternalIdSnapshot))
                {
                    @* CSO doesn't exist but we have an external ID snapshot - differentiate between error (rejected) vs deleted *@
                    @if (_activityRunProfileExecutionItem.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudTooltip Text="This object was not created due to an import error. The external ID shown is from the source data.">
                                <MudChip T="string" Color="Color.Error" Size="Size.Small" Icon="@Icons.Material.Filled.Block">
                                    Rejected
                                </MudChip>
                            </MudTooltip>
                            <MudText Class="jim-text-code">@_activityRunProfileExecutionItem.ExternalIdSnapshot</MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudTooltip Text="This object has been deleted. The external ID shown is preserved from when this operation was recorded.">
                                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.History">
                                    Deleted
                                </MudChip>
                            </MudTooltip>
                            <MudText Class="jim-text-code">@_activityRunProfileExecutionItem.ExternalIdSnapshot</MudText>
                        </MudStack>
                    }
                }
                else
                {
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">Not available</MudText>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    @* Attribute Changes Section *@
    @if (_activityRunProfileExecutionItem.ConnectedSystemObjectChange != null)
    {
        var changeCount = _activityRunProfileExecutionItem.ConnectedSystemObjectChange.AttributeChanges
            .Sum(c => c.ValueChanges.Count);

        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-3">
            <MudText Typo="Typo.h6">
                Attribute Changes
            </MudText>
            <MudChip T="string" Size="Size.Small" Color="Color.Primary">@changeCount</MudChip>
        </MudStack>

        <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3">
            The following attributes were modified during this synchronisation operation.
        </MudText>

        <MudTable Items="@GetFlattenedChanges()"
                  Hover="true"
                  Dense="true"
                  Outlined="true"
                  Elevation="0"
                  Class="mb-5">
            <HeaderContent>
                <MudTh Style="width: 25%;">Attribute</MudTh>
                <MudTh Style="width: 15%;">Change</MudTh>
                <MudTh Style="width: 60%;">Value</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Attribute">
                    <MudText Class="jim-text-code">@context.AttributeName</MudText>
                </MudTd>
                <MudTd DataLabel="Change">
                    <MudChip T="string"
                             Variant="Variant.Text"
                             Color="@Helpers.GetMudBlazorColorForValueChangeType(context.ChangeType)"
                             Class="ml-0">
                        @context.ChangeType
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Value">
                    @if (context.ReferenceValue != null)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudChip T="string" Color="Color.Default" Size="Size.Small">@context.ReferenceValue.Type.Name</MudChip>
                            <MudLink Href="@Utilities.GetConnectedSystemObjectHref(context.ReferenceValue)">
                                @context.ReferenceValue.DisplayNameOrId
                            </MudLink>
                            @if (context.ReferenceValue.SecondaryExternalIdAttributeValue != null)
                            {
                                <MudText Class="mud-text-secondary">(@context.ReferenceValue.SecondaryExternalIdAttributeValue.ToString())</MudText>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudText>@context.Value</MudText>
                    }
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Class="pa-4">No attribute changes recorded.</MudText>
            </NoRecordsContent>
        </MudTable>
    }
    else if (_activityRunProfileExecutionItem.ObjectChangeType == ObjectChangeType.NoChange)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-5">
            <MudText Typo="Typo.body1">No Changes Required</MudText>
            <MudText Typo="Typo.body2">
                @if (_activityRunProfileExecutionItem.NoChangeReason != null)
                {
                    @_activityRunProfileExecutionItem.NoChangeReason.ToString()!.SplitOnCapitalLetters()
                }
                else
                {
                    <text>The object was already up to date with no attribute changes needed.</text>
                }
            </MudText>
        </MudAlert>
    }

    @* Error Section *@
    @if (_activityRunProfileExecutionItem.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
    {
        <MudText Typo="Typo.h6" Class="mb-3">
            <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Small" Class="mr-2" Style="vertical-align: middle;" />
            Error Details
        </MudText>

        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-3">
            <MudText Typo="Typo.body1" Style="font-weight: 500;">
                @_activityRunProfileExecutionItem.ErrorType.ToString()!.SplitOnCapitalLetters()
            </MudText>
            @if (!string.IsNullOrEmpty(_activityRunProfileExecutionItem.ErrorMessage))
            {
                <MudText Typo="Typo.body2" Class="mt-2">@_activityRunProfileExecutionItem.ErrorMessage</MudText>
            }
        </MudAlert>

        @if (!string.IsNullOrEmpty(_activityRunProfileExecutionItem.ErrorStackTrace))
        {
            <MudExpansionPanels Class="mb-5">
                <MudExpansionPanel Text="Stack Trace" MaxHeight="400">
                    <pre class="jim-text-code" style="white-space: pre-wrap; word-wrap: break-word; overflow-x: auto; font-size: 0.8rem; margin: 0;">@_activityRunProfileExecutionItem.ErrorStackTrace</pre>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
    }
}
else
{
    <MudProgressCircular Indeterminate="true" />
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private ActivityRunProfileExecutionItem? _activityRunProfileExecutionItem;
    private Activity? _activity;
    private ConnectedSystemHeader? _connectedSystemHeader;
    private List<BreadcrumbItem> _breadcrumbs = null!;
    private ConnectedSystemObjectAttributeValue? _externalIdAttributeValue;

    /// <summary>
    /// Helper record for flattened changes display in the table.
    /// </summary>
    private record FlattenedChange(
        string AttributeName,
        ValueChangeType ChangeType,
        string? Value,
        ConnectedSystemObject? ReferenceValue);

    protected override async Task OnParametersSetAsync()
    {
        _activityRunProfileExecutionItem = await Jim.Activities.GetActivityRunProfileExecutionItemAsync(Id);
        if (_activityRunProfileExecutionItem == null)
        {
            NavManager.NavigateTo("/activity");
            return;
        }

        _breadcrumbs = new List<BreadcrumbItem>
        {
            new("Home", href: "/", icon: Icons.Material.Filled.Home),
            new("Activity", href: "/activity"),
            new("Activity Detail", href: $"/activity/{_activityRunProfileExecutionItem.ActivityId}"),
            new("Sync Details", href: null, disabled: true)
        };

        _activity = await Jim.Activities.GetActivityAsync(_activityRunProfileExecutionItem.ActivityId);
        _externalIdAttributeValue = _activityRunProfileExecutionItem.GetExternalIdAttributeValue();

        var connectedSystemId = _activityRunProfileExecutionItem.GetConnectedSystemId();
        if (connectedSystemId != null)
            _connectedSystemHeader = await Jim.ConnectedSystems.GetConnectedSystemHeaderAsync(connectedSystemId.Value);
    }

    private string GetStatusBannerStyle()
    {
        if (_activityRunProfileExecutionItem?.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
            return $"background: {Colors.Red.Default}; color: {Colors.Shades.White};";

        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => $"background: {Colors.Green.Default}; color: {Colors.Shades.White};",
            ObjectChangeType.Updated => $"background: {Colors.Teal.Default}; color: {Colors.Shades.White};",
            ObjectChangeType.Deleted => $"background: {Colors.DeepOrange.Default}; color: {Colors.Shades.White};",
            // Sync operations
            ObjectChangeType.Projected => $"background: {Colors.Blue.Default}; color: {Colors.Shades.White};",
            ObjectChangeType.Joined => $"background: {Colors.Purple.Default}; color: {Colors.Shades.White};",
            ObjectChangeType.AttributeFlow => $"background: {Colors.Cyan.Default}; color: {Colors.Shades.White};",
            ObjectChangeType.Disconnected => $"background: {Colors.Orange.Default}; color: {Colors.Shades.White};",
            // Export operations
            ObjectChangeType.Provisioned => $"background: {Colors.Green.Default}; color: {Colors.Shades.White};",
            ObjectChangeType.Exported => $"background: {Colors.Blue.Default}; color: {Colors.Shades.White};",
            ObjectChangeType.Deprovisioned => $"background: {Colors.DeepOrange.Default}; color: {Colors.Shades.White};",
            // Other
            ObjectChangeType.NoChange => $"background: {Colors.BlueGray.Default}; color: {Colors.Shades.White};",
            _ => $"background: {Colors.Gray.Default}; color: {Colors.Shades.White};"
        };
    }

    private string GetStatusIcon()
    {
        if (_activityRunProfileExecutionItem?.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
            return Icons.Material.Filled.Error;

        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => Icons.Material.Filled.Add,
            ObjectChangeType.Updated => Icons.Material.Filled.Edit,
            ObjectChangeType.Deleted => Icons.Material.Filled.Delete,
            // Sync operations
            ObjectChangeType.Projected => Icons.Material.Filled.AccountTree,
            ObjectChangeType.Joined => Icons.Material.Filled.Link,
            ObjectChangeType.AttributeFlow => Icons.Material.Filled.SwapHoriz,
            ObjectChangeType.Disconnected => Icons.Material.Filled.LinkOff,
            // Export operations
            ObjectChangeType.Provisioned => Icons.Material.Filled.Add,
            ObjectChangeType.Exported => Icons.Material.Filled.Publish,
            ObjectChangeType.Deprovisioned => Icons.Material.Filled.Delete,
            // Other
            ObjectChangeType.NoChange => Icons.Material.Filled.CheckCircle,
            _ => Icons.Material.Filled.Info
        };
    }

    private string GetStatusTitle()
    {
        if (_activityRunProfileExecutionItem?.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
            return "Synchronisation Failed";

        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => "Object Added to Staging",
            ObjectChangeType.Updated => "Object Updated",
            ObjectChangeType.Deleted => "Object Deleted from Source",
            // Sync operations
            ObjectChangeType.Projected => "New Metaverse Object Projected",
            ObjectChangeType.Joined => "Joined to Metaverse Object",
            ObjectChangeType.AttributeFlow => "Attributes Flowed",
            ObjectChangeType.Disconnected => "Disconnected from Metaverse",
            // Export operations
            ObjectChangeType.Provisioned => "Object Provisioned",
            ObjectChangeType.Exported => "Object Exported",
            ObjectChangeType.Deprovisioned => "Object Deprovisioned",
            // Other
            ObjectChangeType.NoChange => "No Changes",
            _ => "Synchronisation Complete"
        };
    }

    private string GetStatusDescription()
    {
        var objectDesc = _externalIdAttributeValue?.ToStringNoName()
            ?? _activityRunProfileExecutionItem?.ExternalIdSnapshot
            ?? "object";

        if (_activityRunProfileExecutionItem?.ErrorType != ActivityRunProfileExecutionItemErrorType.NotSet)
            return $"An error occurred while synchronising {objectDesc}.";

        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => $"A new object ({objectDesc}) was imported and added to the staging area.",
            ObjectChangeType.Updated => $"The object ({objectDesc}) was updated with new attribute values.",
            ObjectChangeType.Deleted => $"The object ({objectDesc}) was deleted from the source system.",
            // Sync operations
            ObjectChangeType.Projected => $"A new metaverse object was created for ({objectDesc}) via projection.",
            ObjectChangeType.Joined => $"The object ({objectDesc}) was joined to an existing metaverse object.",
            ObjectChangeType.AttributeFlow => $"Attributes were flowed for ({objectDesc}) between staging and metaverse.",
            ObjectChangeType.Disconnected => $"The object ({objectDesc}) was disconnected from the metaverse.",
            // Export operations
            ObjectChangeType.Provisioned => $"A new object ({objectDesc}) was provisioned in the target system.",
            ObjectChangeType.Exported => $"The object ({objectDesc}) was exported with updated attributes.",
            ObjectChangeType.Deprovisioned => $"The object ({objectDesc}) was deprovisioned from the target system.",
            // Other
            ObjectChangeType.NoChange => $"The object ({objectDesc}) was already up to date.",
            _ => $"Synchronisation completed for {objectDesc}."
        };
    }

    private string GetChangeTypeIcon()
    {
        return _activityRunProfileExecutionItem?.ObjectChangeType switch
        {
            // Import operations
            ObjectChangeType.Added => Icons.Material.Filled.Add,
            ObjectChangeType.Updated => Icons.Material.Filled.Edit,
            ObjectChangeType.Deleted => Icons.Material.Filled.Delete,
            // Sync operations
            ObjectChangeType.Projected => Icons.Material.Filled.AccountTree,
            ObjectChangeType.Joined => Icons.Material.Filled.Link,
            ObjectChangeType.AttributeFlow => Icons.Material.Filled.SwapHoriz,
            ObjectChangeType.Disconnected => Icons.Material.Filled.LinkOff,
            // Export operations
            ObjectChangeType.Provisioned => Icons.Material.Filled.Add,
            ObjectChangeType.Exported => Icons.Material.Filled.Publish,
            ObjectChangeType.Deprovisioned => Icons.Material.Filled.Delete,
            // Other
            ObjectChangeType.NoChange => Icons.Material.Filled.CheckCircle,
            _ => Icons.Material.Filled.QuestionMark
        };
    }

    private IEnumerable<FlattenedChange> GetFlattenedChanges()
    {
        if (_activityRunProfileExecutionItem?.ConnectedSystemObjectChange == null)
            return Enumerable.Empty<FlattenedChange>();

        return _activityRunProfileExecutionItem.ConnectedSystemObjectChange.AttributeChanges
            .OrderBy(c => c.Attribute.Name)
            .SelectMany(change => change.ValueChanges.Select(vc => new FlattenedChange(
                change.Attribute.Name,
                vc.ValueChangeType,
                vc.ReferenceValue == null ? vc.ToString() : null,
                vc.ReferenceValue
            )));
    }
}
