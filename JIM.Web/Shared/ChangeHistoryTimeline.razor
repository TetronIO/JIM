@using JIM.Models.Core
@using JIM.Models.Enums

<MudPaper Class="pa-5 mt-5" Outlined="true">
    <MudStack Spacing="3">
        <MudText Typo="Typo.h6">Change History</MudText>

        @if (Changes == null || !Changes.Any())
        {
            <MudText Typo="Typo.body2" Class="mud-text-secondary">No change history available.</MudText>
        }
        else
        {
            <!-- Search and Filter Controls -->
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudTextField @bind-Value="_searchText"
                              Label="Search attributes"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Immediate="true"
                              DebounceInterval="300"
                              Style="max-width: 300px;" />

                <MudSelect T="ValueChangeType?"
                           @bind-Value="_filterChangeType"
                           Label="Filter by change type"
                           Variant="Variant.Outlined"
                           Style="max-width: 200px;">
                    <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)null)">All Changes</MudSelectItem>
                    <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)ValueChangeType.Add)">Add</MudSelectItem>
                    <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)ValueChangeType.Remove)">Remove</MudSelectItem>
                </MudSelect>
            </MudStack>

            <!-- Timeline of Changes -->
            @foreach (var changeGroup in GetFilteredChangeGroups())
            {
                <MudPaper Class="pa-4 mt-2" Outlined="true">
                    <MudStack Spacing="2">
                        <!-- Change Header -->
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@GetChangeTypeIcon(changeGroup.ChangeType)" Color="@GetChangeTypeColor(changeGroup.ChangeType)" Size="Size.Medium" />
                            <div>
                                <MudText Typo="Typo.subtitle1">
                                    <strong>@changeGroup.ChangeType</strong>
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                    @changeGroup.ChangeTime.ToLocalTime().ToString("dd MMM yyyy HH:mm:ss") - @GetChangeInitiatorDescription(changeGroup)
                                </MudText>
                            </div>
                        </MudStack>

                        <!-- Attribute Changes Table -->
                        @if (changeGroup.AttributeChanges.Any())
                        {
                            <MudTable Items="@changeGroup.AttributeChanges"
                                      Dense="true"
                                      Hover="true"
                                      Breakpoint="Breakpoint.Sm"
                                      Elevation="0"
                                      Class="mt-2">
                                <HeaderContent>
                                    <MudTh>Attribute</MudTh>
                                    <MudTh>Change</MudTh>
                                    <MudTh>Value</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Attribute">
                                        <MudText Class="jim-text-code">@context.AttributeName</MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Change">
                                        <MudChip T="string"
                                                 Variant="Variant.Text"
                                                 Color="@Helpers.GetMudBlazorColorForValueChangeType(context.ChangeType)"
                                                 Class="ml-0">
                                            @context.ChangeType
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Value">
                                        @if (context.ReferenceValue != null)
                                        {
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                                <MudChip T="string" Color="Color.Default" Size="Size.Small">@context.ReferenceValue.TypeName</MudChip>
                                                <MudLink Href="@context.ReferenceValue.Href">
                                                    @context.ReferenceValue.DisplayName
                                                </MudLink>
                                                @if (!string.IsNullOrEmpty(context.ReferenceValue.SecondaryId))
                                                {
                                                    <MudText Class="mud-text-secondary">(@context.ReferenceValue.SecondaryId)</MudText>
                                                }
                                            </MudStack>
                                        }
                                        else
                                        {
                                            <MudText>@context.Value</MudText>
                                        }
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else if (changeGroup.ChangeType == ObjectChangeType.Deleted)
                        {
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">Object was deleted. Final attribute values were not captured.</MudText>
                        }
                    </MudStack>
                </MudPaper>
            }
        }
    </MudStack>
</MudPaper>

@code {
    /// <summary>
    /// The list of change groups to display (CSO or MVO changes).
    /// </summary>
    [Parameter]
    public List<ChangeGroup> Changes { get; set; } = new();

    private string _searchText = string.Empty;
    private ValueChangeType? _filterChangeType = null;

    /// <summary>
    /// Represents a group of changes that occurred at a specific point in time.
    /// Works for both ConnectedSystemObjectChange and MetaverseObjectChange.
    /// </summary>
    public class ChangeGroup
    {
        public ObjectChangeType ChangeType { get; set; }
        public DateTime ChangeTime { get; set; }
        public string ChangeInitiatorType { get; set; } = string.Empty;
        public string? ChangeInitiatorName { get; set; }
        public List<AttributeChange> AttributeChanges { get; set; } = new();
    }

    /// <summary>
    /// Represents a single attribute change within a change group.
    /// </summary>
    public class AttributeChange
    {
        public string AttributeName { get; set; } = string.Empty;
        public ValueChangeType ChangeType { get; set; }
        public string? Value { get; set; }
        public ReferenceValueInfo? ReferenceValue { get; set; }
    }

    /// <summary>
    /// Reference value information (CSO or MVO).
    /// </summary>
    public class ReferenceValueInfo
    {
        public string TypeName { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string? SecondaryId { get; set; }
        public string Href { get; set; } = string.Empty;
    }

    private IEnumerable<ChangeGroup> GetFilteredChangeGroups()
    {
        var filtered = Changes.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            filtered = filtered.Select(cg => new ChangeGroup
            {
                ChangeType = cg.ChangeType,
                ChangeTime = cg.ChangeTime,
                ChangeInitiatorType = cg.ChangeInitiatorType,
                ChangeInitiatorName = cg.ChangeInitiatorName,
                AttributeChanges = cg.AttributeChanges
                    .Where(ac => ac.AttributeName.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
                    .ToList()
            }).Where(cg => cg.AttributeChanges.Any() || cg.ChangeType == ObjectChangeType.Deleted);
        }

        // Apply change type filter
        if (_filterChangeType.HasValue)
        {
            filtered = filtered.Select(cg => new ChangeGroup
            {
                ChangeType = cg.ChangeType,
                ChangeTime = cg.ChangeTime,
                ChangeInitiatorType = cg.ChangeInitiatorType,
                ChangeInitiatorName = cg.ChangeInitiatorName,
                AttributeChanges = cg.AttributeChanges
                    .Where(ac => ac.ChangeType == _filterChangeType.Value)
                    .ToList()
            }).Where(cg => cg.AttributeChanges.Any() || cg.ChangeType == ObjectChangeType.Deleted);
        }

        return filtered.OrderByDescending(cg => cg.ChangeTime);
    }

    private string GetChangeInitiatorDescription(ChangeGroup changeGroup)
    {
        if (!string.IsNullOrEmpty(changeGroup.ChangeInitiatorName))
        {
            return $"{changeGroup.ChangeInitiatorType}: {changeGroup.ChangeInitiatorName}";
        }
        return changeGroup.ChangeInitiatorType;
    }

    private string GetChangeTypeIcon(ObjectChangeType changeType)
    {
        return changeType switch
        {
            ObjectChangeType.Added => Icons.Material.Filled.Add,
            ObjectChangeType.Updated => Icons.Material.Filled.Edit,
            ObjectChangeType.Deleted => Icons.Material.Filled.Delete,
            _ => Icons.Material.Filled.Info
        };
    }

    private Color GetChangeTypeColor(ObjectChangeType changeType)
    {
        return changeType switch
        {
            ObjectChangeType.Added => Color.Success,
            ObjectChangeType.Updated => Color.Info,
            ObjectChangeType.Deleted => Color.Error,
            _ => Color.Default
        };
    }
}
