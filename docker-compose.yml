version: '3.4'

services:

  jim.web:
    container_name: jim.web
    image: ${DOCKER_REGISTRY-}jim.web
    restart: always
    environment:
     - LOGGING_LEVEL=Verbose
     - LOGGING_PATH=/var/log/jim
     - ENABLE_REQUEST_LOGGING=true
     - SSO_AUTHORITY=${SSO_AUTHORITY}
     - SSO_CLIENT_ID=${SSO_CLIENT_ID}
     - SSO_SECRET=${SSO_SECRET}
     - SSO_UNIQUE_IDENTIFIER_CLAIM_TYPE=${SSO_UNIQUE_IDENTIFIER_CLAIM_TYPE}
     - SSO_UNIQUE_IDENTIFIER_METAVERSE_ATTRIBUTE_NAME=${SSO_UNIQUE_IDENTIFIER_METAVERSE_ATTRIBUTE_NAME}
     - SSO_UNIQUE_IDENTIFIER_INITIAL_ADMIN_CLAIM_VALUE=${SSO_UNIQUE_IDENTIFIER_INITIAL_ADMIN_CLAIM_VALUE}
    volumes:
      - jim-logs-volume:/var/log/jim
    build:
      context: .
      dockerfile: src/JIM.Web/Dockerfile
    depends_on:
      - jim.database
      - jim.service
      - jim.api
    networks:
      - jim-network

  jim.api:
    container_name: jim.api
    image: ${DOCKER_REGISTRY-}jim.api
    restart: always
    environment:
     - LOGGING_LEVEL=Verbose
     - LOGGING_PATH=/var/log/jim
     - ENABLE_REQUEST_LOGGING=true
     - DB_HOSTNAME=JIM.Database
     - DB_NAME=${DB_NAME}
     - DB_USERNAME=${DB_USERNAME}
     - DB_PASSWORD=${DB_PASSWORD}
     - SSO_AUTHORITY=${SSO_AUTHORITY}
     - SSO_CLIENT_ID=${SSO_CLIENT_ID}
     - SSO_SECRET=${SSO_SECRET}
     - SSO_UNIQUE_IDENTIFIER_CLAIM_TYPE=${SSO_UNIQUE_IDENTIFIER_CLAIM_TYPE}
     - SSO_UNIQUE_IDENTIFIER_METAVERSE_ATTRIBUTE_NAME=${SSO_UNIQUE_IDENTIFIER_METAVERSE_ATTRIBUTE_NAME}
     - SSO_UNIQUE_IDENTIFIER_INITIAL_ADMIN_CLAIM_VALUE=${SSO_UNIQUE_IDENTIFIER_INITIAL_ADMIN_CLAIM_VALUE}
    volumes:
      - jim-logs-volume:/var/log/jim
    build:
      context: .
      dockerfile: src/JIM.Api/Dockerfile
    depends_on:
      - jim.database
      - jim.service
    networks:
      - jim-network

  jim.service:
    container_name: jim.service
    image: ${DOCKER_REGISTRY-}jim.service
    restart: always
    environment:
     - LOGGING_LEVEL=Verbose
     - LOGGING_PATH=/var/log/jim
     - DB_HOSTNAME=JIM.Database
     - DB_NAME=${DB_NAME}
     - DB_USERNAME=${DB_USERNAME}
     - DB_PASSWORD=${DB_PASSWORD}
    volumes:
      - jim-logs-volume:/var/log/jim
    build:
      context: .
      dockerfile: src/JIM.Service/Dockerfile
    depends_on:
      - jim.database
    networks:
      - jim-network

  jim.scheduler:
    container_name: jim.scheduler
    image: ${DOCKER_REGISTRY-}jim.scheduler
    restart: always
    environment:
     - LOGGING_LEVEL=Verbose
     - LOGGING_PATH=/var/log/jim
     - DB_HOSTNAME=JIM.Database
     - DB_NAME=${DB_NAME}
     - DB_USERNAME=${DB_USERNAME}
     - DB_PASSWORD=${DB_PASSWORD}
    volumes:
      - jim-logs-volume:/var/log/jim
    build:
      context: .
      dockerfile: src/JIM.Scheduler/Dockerfile
    depends_on:
      - jim.database
      - jim.service
    networks:
      - jim-network
  
  adminer:
    container_name: jim.adminer
    image: adminer
    restart: always
    ports:
      - 8080:8080
    depends_on:
      - jim.database
    networks:
      - jim-network

  jim.database:
    container_name: jim.database
    image: postgres
    restart: always
    volumes:
      - jim-db-volume:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USERNAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}      
    networks: 
      - jim-network

networks:
  jim-network:
    driver: bridge

volumes:
  jim-db-volume:
    name: jim-db-volume
  jim-logs-volume:
    name: jim-logs-volume