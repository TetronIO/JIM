@page "/activity"
@page "/activity/mine"
@attribute [Authorize(Roles = "User")]
@implements IDisposable
@using JIM.Application
@using JIM.Models.Activities
@using JIM.Models.Utility;
@using JIM.Utilities;
@using Microsoft.AspNetCore.Components.Authorization
@inject JimApplication Jim
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>@_pageTitle</PageTitle>
<MudText Typo="Typo.h4">@_pageTitle</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>

<MudText Typo="Typo.subtitle1" Class="mud-text-secondary mt-2 mb-2">
    @_pageDescription
</MudText>

<MudTable @ref="_table" T="Activity" ServerData="ServerReload" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm"
    Class="mt-5" Outlined="true" Elevation="0" OnRowClick="HandleRowClick" RowClass="cursor-pointer" Loading="@_loading"
    LoadingProgressColor="Color.Primary">
    <ToolBarContent>
        <MudSpacer />
        <MudTextField T="string" ValueChanged="@(s => OnSearch(s))" Placeholder="Search type or target"
            Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
            Class="mt-0" />
    </ToolBarContent>
    <HeaderContent>
        <MudTh>
            <MudTableSortLabel SortLabel="type" T="Activity">
                <MudText Typo="Typo.button">Type</MudText>
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="target" T="Activity">
                <MudText Typo="Typo.button">Target</MudText>
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="operation" T="Activity">
                <MudText Typo="Typo.button">Operation</MudText>
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="created" T="Activity" InitialDirection="SortDirection.Descending">
                <MudText Typo="Typo.button">Created</MudText>
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="initiatedby" T="Activity">
                <MudText Typo="Typo.button">Initiated By</MudText>
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="status" T="Activity">
                <MudText Typo="Typo.button">Status</MudText>
            </MudTableSortLabel>
        </MudTh>
        <MudTh>
            <MudTableSortLabel SortLabel="executiontime" T="Activity">
                <MudText Typo="Typo.button">Execution Time</MudText>
            </MudTableSortLabel>
        </MudTh>
    </HeaderContent>
    <RowTemplate Context="context">
        <MudTd DataLabel="Type">
            <MudLink Href="@($"/activity/{context.Id}")">
                @context.TargetType.ToString().SplitOnCapitalLetters()
            </MudLink>
        </MudTd>
        <MudTd DataLabel="Target">
            <MudLink Href="@($"/activity/{context.Id}")">
                @(!string.IsNullOrEmpty(context.TargetName) ? context.TargetName : "(no name)")
            </MudLink>
        </MudTd>
        <MudTd DataLabel="Operation">@context.TargetOperationType.ToString().SplitOnCapitalLetters()</MudTd>
        <MudTd DataLabel="Created">@context.Created.ToFriendlyDate()</MudTd>
        <MudTd DataLabel="Initiated By">
            @if (context.InitiatedBy != null)
            {
                <MudLink Href="@Utilities.GetMetaverseObjectHref(context.InitiatedBy)">
                    @Utilities.GetMetaverseObjectHrefText(context.InitiatedBy)
                </MudLink>
            }
            else if (!string.IsNullOrEmpty(context.InitiatedByName))
            {
                @context.InitiatedByName
            }
        </MudTd>
        <MudTd DataLabel="Status">
            <MudChip T="string" Variant="Variant.Text"
                Color="Helpers.GetActivityMudBlazorColorForStatus(context.Status)">
                @context.Status.ToString().SplitOnCapitalLetters()
            </MudChip>
        </MudTd>
        <MudTd DataLabel="Execution Time">@(context.ExecutionTime?.ToCasualString() ?? "-")</MudTd>
    </RowTemplate>
    <NoRecordsContent>
        There is no activity to show yet.
    </NoRecordsContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    private MudTable<Activity>? _table;
    private string _searchString = "";
    private bool _loading;
    private bool _isMyActivity;
    private Guid? _currentUserId;
    private string _pageTitle = "Activity";
    private string _pageDescription = "Monitor all activity across the system. View operations initiated by users or automated processes, including synchronisations, configuration changes, and system events.";
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        NavManager.LocationChanged += OnLocationChanged;
        await UpdatePageStateAsync();
    }

    private async void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        await UpdatePageStateAsync();
        await InvokeAsync(StateHasChanged);

        // Reload the table data when location changes
        if (_table != null)
            await _table.ReloadServerData();
    }

    private async Task UpdatePageStateAsync()
    {
        _isMyActivity = NavManager.Uri.EndsWith("/activity/mine", StringComparison.OrdinalIgnoreCase);

        if (_isMyActivity)
        {
            _pageTitle = "My Activity";
            _pageDescription = "View operations you have initiated, including synchronisations, configuration changes, and other actions.";

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            _currentUserId = IdentityUtilities.GetUserId(authState.User);
        }
        else
        {
            _pageTitle = "Activity";
            _pageDescription = "Monitor all activity across the system. View operations initiated by users or automated processes, including synchronisations, configuration changes, and system events.";
            _currentUserId = null;
        }

        _breadcrumbs = new List<BreadcrumbItem>
        {
            new("Home", href: "/", icon: Icons.Material.Filled.Home),
            new(_pageTitle, href: null, disabled: true),
        };
    }

    public void Dispose()
    {
        NavManager.LocationChanged -= OnLocationChanged;
    }

    private async Task<TableData<Activity>> ServerReload(TableState state, CancellationToken token)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            // Convert MudBlazor's 0-indexed page to our 1-indexed page
            var page = state.Page + 1;
            var sortDescending = state.SortDirection == SortDirection.Descending;

            var result = await Jim.Activities.GetActivitiesAsync(
                page,
                state.PageSize,
                string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                state.SortLabel,
                sortDescending,
                _currentUserId);

            return new TableData<Activity>
            {
                TotalItems = result.TotalResults,
                Items = result.Results
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private void OnSearch(string text)
    {
        _searchString = text;
        _table?.ReloadServerData();
    }

    private void HandleRowClick(TableRowClickEventArgs<Activity> args)
    {
        if (args.Item != null)
            NavManager.NavigateTo($"/activity/{args.Item.Id}");
    }
}
