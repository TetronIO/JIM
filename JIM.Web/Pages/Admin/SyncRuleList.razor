@page "/admin/connected-systems/sync-rules"
@attribute [Authorize(Roles = "Administrators")]
@using JIM.Application
@using JIM.Models.Core
@using JIM.Models.Core.DTOs
@using JIM.Models.Logic;
@using JIM.Models.Logic.DTOs
@inject JimApplication Jim

<PageTitle>Synchronisation Rules</PageTitle>
<MudText Typo="Typo.h4">Synchronisation Rules</MudText>
<MudBreadcrumbs Items="breadcrumbs" Class="ps-0"></MudBreadcrumbs>
<MudText Typo="Typo.subtitle1" Class="mud-text-secondary">
    Synchronisation Rules are used to define the flow of information between JIM and connected systems.
</MudText>

<MudPaper Elevation="0" Class="mt-2" Outlined="true">
    <MudToolBar>
        <MudButton Href="/admin/connected-systems/sync-rules" Color="Color.Primary" DisableElevation="true" Disabled="true">Sync Rules</MudButton>
        <MudSpacer />
        <MudButton 
            StartIcon="@Icons.Material.Filled.Add" 
            ariant="Variant.Filled" 
            Href="/admin/connected-systems/sync-rules/create" 
            Size="Size.Small" 
            Color="Color.Primary"
            Disabled=@(!canCreateSyncRules)
            DisableElevation="true">Create Sync Rule</MudButton>
    </MudToolBar>
</MudPaper>

@if (!canCreateSyncRules)
{
    <MudAlert Class="mt-5" Severity="Severity.Warning">Please create a <MudLink Href="/admin/connected-systems/">Connected System</MudLink> first.</MudAlert>
}

<MudTable Items="@syncRuleHeaders" Hover="true" Breakpoint="Breakpoint.Sm" Class="mt-5 mb-5" SortLabel="Sort By" Filter="new Func<SyncRuleHeader,bool>(FilterFunc1)" Outlined="true" Elevation="0">
    <ToolBarContent>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.Name)">Name</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.Direction)">Direction</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.ConnectedSystemName)">Connected System</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.MetaverseObjectTypeName)">Metaverse Object Type</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.ConnectedSystemObjectTypeName)">Connected System Object Type</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.ProvisionToConnectedSystem)">Provision?</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.ProjectToMetaverse)">Project?</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<SyncRuleHeader, object>(x => x.Status)">Status</MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name"><MudLink Href="@("/admin/connected-systems/sync-rules/"+context.Id)">@context.Name</MudLink></MudTd>
        <MudTd DataLabel="Direction">
            @if (context.Direction == SyncRuleDirection.Import)
            {
                <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowLeft" />
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.KeyboardArrowRight" />
            }
        </MudTd>
        <MudTd DataLabel="Connected System">@context.ConnectedSystemName</MudTd>
        <MudTd DataLabel="Metaverse Object Type">@context.MetaverseObjectTypeName</MudTd>
        <MudTd DataLabel="Connected System Object Type">@context.ConnectedSystemObjectTypeName</MudTd>
        <MudTd DataLabel="Provision?">@(context.ProvisionToConnectedSystem.HasValue && context.ProvisionToConnectedSystem.Value ? "Yes" : "No")</MudTd>
        <MudTd DataLabel="Project?">@(context.ProjectToMetaverse.HasValue && context.ProjectToMetaverse.Value ? "Yes" : "No")</MudTd>
        <MudTd DataLabel="Status">@context.Status</MudTd>
    </RowTemplate>
    <NoRecordsContent>
        There are no synchronisation rules
    </NoRecordsContent>
</MudTable>

@code {
    private IList<SyncRuleHeader>? syncRuleHeaders;
    private string searchString = "";
    private bool canCreateSyncRules = false;

    private List<BreadcrumbItem> breadcrumbs = new List<BreadcrumbItem>
    {
        new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
        new BreadcrumbItem("Synchronisation Rules", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        canCreateSyncRules = Jim.ConnectedSystems.GetConnectedSystemCount() > 0;
        syncRuleHeaders = await Jim.ConnectedSystems.GetSyncRuleHeadersAsync();
    }

    private bool FilterFunc1(SyncRuleHeader element) => FilterFunc(element, searchString);

    private bool FilterFunc(SyncRuleHeader element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        if (element.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    }
}