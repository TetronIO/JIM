@page "/admin/example-data/datasets"
@attribute [Authorize(Roles = "Administrator")]
@using JIM.Application
@using JIM.Models.DataGeneration.DTOs
@inject JimApplication Jim

<PageTitle>Example Data Sets</PageTitle>
<MudText Typo="Typo.h4"><span class="mud-primary-text">Example Data:</span> Data Sets</MudText>
<MudBreadcrumbs Items="_breadcrumbs" Class="ps-0"></MudBreadcrumbs>

<MudButtonGroup Class="mt-3" OverrideStyles="false">
    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/admin/example-data">Templates</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary">Data Sets</MudButton>
</MudButtonGroup>

<MudText Typo="Typo.subtitle1" Class="mud-text-secondary mt-5">
    You can quickly populate JIM with example data, as a way to demo, or prototype new features without needing to fuly
    configure JIM with Connected Systems, Sync Rules and wait for data to be imported and synchronised etc.
</MudText>
<MudText Typo="Typo.subtitle1" Class="mud-text-secondary mt-2">
    Example datasets provide the raw values that are used to construct example data in Example Data Templates.
</MudText>

<MudTable Items="@_datasets" Hover="true" Breakpoint="Breakpoint.Sm" Class="mt-5 mb-5" SortLabel="Sort By" Filter="new Func<ExampleDataSetHeader,bool>(FilterFunc1)" Outlined="true" Elevation="0">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Data Sets</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="_searchString" Variant="Variant.Outlined" Placeholder="Search" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortBy="new Func<ExampleDataSetHeader, object>(x => x.Name)"><MudText Typo="Typo.button">Name</MudText></MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ExampleDataSetHeader, object>(x => x.BuiltIn)"><MudText Typo="Typo.button">Built-in?</MudText></MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ExampleDataSetHeader, object>(x => x.Culture)"><MudText Typo="Typo.button">Culture</MudText></MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ExampleDataSetHeader, object>(x => x.ValueCount)"><MudText Typo="Typo.button">Values</MudText></MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<ExampleDataSetHeader, object>(x => x.Created)"><MudText Typo="Typo.button">Created</MudText></MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Name"><MudLink Href="@("/admin/example-data/datasets/"+context.Id)">@context.Name</MudLink></MudTd>
        <MudTd DataLabel="Built-in?">@(context.BuiltIn ? "Yes" : "No")</MudTd>
        <MudTd DataLabel="Culture">@context.Culture</MudTd>
        <MudTd DataLabel="Values">@context.ValueCount.ToString("N0")</MudTd>
        <MudTd DataLabel="Created">
            <MudTooltip Text="@context.Created.ToLocalTime().ToFriendlyDate()" Arrow="true" Placement="Placement.Top">
                @context.Created.ToLocalTime().ToRelativeTime()
            </MudTooltip>
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        There are no example data sets
    </NoRecordsContent>
</MudTable>

@code {
    private List<ExampleDataSetHeader>? _datasets;
    private string _searchString = "";
    private readonly List<BreadcrumbItem> _breadcrumbs = new List<BreadcrumbItem>
    {
        new("Home", href: "/", icon: Icons.Material.Filled.Home),
        new("Example Data", href: "/admin/example-data/"),
        new("Data Sets", href: null, disabled: true)
    };

    protected override async Task OnInitializedAsync()
    {
        _datasets = await Jim.DataGeneration.GetExampleDataSetHeadersAsync();
    }

    private bool FilterFunc1(ExampleDataSetHeader element) => FilterFunc(element, _searchString);

    private static bool FilterFunc(ExampleDataSetHeader element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;

        if (element.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;

        return false;
    }
}