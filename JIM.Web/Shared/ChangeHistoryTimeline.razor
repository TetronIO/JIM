@using JIM.Models.Core
@using JIM.Models.Enums

@if (Changes == null || !Changes.Any())
{
    <MudText Typo="Typo.body2" Class="mud-text-secondary pa-5">No change history available.</MudText>
}
else
{
    <!-- Search and Filter Controls -->
    <div style="display: flex; flex-direction: row; gap: 12px; margin-bottom: 16px;">
        <div style="width: 300px;">
            <MudTextField @bind-Value="_searchText"
                          Label="Search attributes"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          DebounceInterval="300"
                          FullWidth="true" />
        </div>
        <div style="width: 200px;">
            <MudSelect T="ValueChangeType?"
                       @bind-Value="_filterChangeType"
                       Label="Filter by change type"
                       Variant="Variant.Outlined"
                       FullWidth="true">
                <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)null)">All Changes</MudSelectItem>
                <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)ValueChangeType.Add)">Add</MudSelectItem>
                <MudSelectItem T="ValueChangeType?" Value="@((ValueChangeType?)ValueChangeType.Remove)">Remove</MudSelectItem>
            </MudSelect>
        </div>
    </div>

    <!-- Timeline -->
    <MudTimeline TimelinePosition="TimelinePosition.Start" TimelineOrientation="TimelineOrientation.Vertical">
        @foreach (var changeGroup in GetFilteredChangeGroups())
        {
            <MudTimelineItem Color="@GetChangeTypeColor(changeGroup.ChangeType)" Size="Size.Small" Elevation="0">
                <ItemContent>
                    <MudCard Outlined="true" Class="cursor-pointer" @onclick="() => OpenChangeDetails(changeGroup)">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <!-- Change Header: {icon} {type}    {relative date}    {mechanism icon} {mechanism} by {initiator} -->
                                <MudStack Row="true" Spacing="0" AlignItems="AlignItems.Center" Style="flex-wrap: wrap; gap: 6px;">
                                    <MudIcon Icon="@GetChangeTypeIcon(changeGroup.ChangeType)"
                                             Color="@GetChangeTypeColor(changeGroup.ChangeType)"
                                             Size="Size.Small" />
                                    <MudText Typo="Typo.body1" Style="margin-right: 12px;"><strong>@changeGroup.ChangeType</strong></MudText>
                                    <MudTooltip Text="@changeGroup.ChangeTime.ToLocalTime().ToString("dd MMM yyyy HH:mm:ss")" Placement="Placement.Top" Arrow="true">
                                        <MudText Typo="Typo.body2" Class="mud-text-secondary" Style="margin-right: 12px;">@GetRelativeTime(changeGroup.ChangeTime)</MudText>
                                    </MudTooltip>
                                    @GetTimelineInitiatorDisplay(changeGroup)
                                </MudStack>

                                <!-- Summary of Changes -->
                                @if (changeGroup.AttributeChanges.Any())
                                {
                                    <MudDivider />
                                    <div class="change-summary">
                                        @foreach (var change in GetVisibleChanges(changeGroup))
                                        {
                                            <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center" Class="mb-1">
                                                <MudText Typo="Typo.body2" Class="jim-text-code" Style="min-width: 120px;">
                                                    @change.AttributeName
                                                </MudText>
                                                <MudChip T="string"
                                                         Variant="Variant.Text"
                                                         Size="Size.Small"
                                                         Color="@Helpers.GetMudBlazorColorForValueChangeType(change.ChangeType)">
                                                    @change.ChangeType
                                                </MudChip>
                                                <MudText Typo="Typo.body2" Class="mud-text-secondary" Style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                    @(change.ReferenceValue?.DisplayName ?? change.Value)
                                                </MudText>
                                            </MudStack>
                                        }
                                        @if (ShouldShowMoreIndicator(changeGroup))
                                        {
                                            <div class="more-changes-indicator">
                                                <MudChip T="string"
                                                         Variant="Variant.Filled"
                                                         Size="Size.Small"
                                                         Color="Color.Primary">
                                                    +@GetRemainingChangesCount(changeGroup) more
                                                </MudChip>
                                            </div>
                                        }
                                    </div>
                                }
                                else if (changeGroup.ChangeType == ObjectChangeType.Deleted)
                                {
                                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                        Object was deleted. Final attribute values were not captured.
                                    </MudText>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </ItemContent>
            </MudTimelineItem>
        }
    </MudTimeline>
}

<!-- Change Details Dialog -->
<MudDialog @bind-Visible="_detailsDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudIcon Icon="@GetChangeTypeIcon(_selectedChange?.ChangeType ?? ObjectChangeType.Updated)"
                     Color="@GetChangeTypeColor(_selectedChange?.ChangeType ?? ObjectChangeType.Updated)"
                     Size="Size.Large" />
            <div>
                <MudText Typo="Typo.h6">@_selectedChange?.ChangeType</MudText>
                <MudText Typo="Typo.body2" Class="mud-text-secondary">
                    @_selectedChange?.ChangeTime.ToLocalTime().ToString("dd MMM yyyy HH:mm:ss")
                </MudText>
            </div>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (_selectedChange != null)
        {
            <!-- Initiator Context Section -->
            <MudPaper Class="pa-3 mb-4" Outlined="true">
                <MudGrid Spacing="2">
                    <!-- Initiated By -->
                    <MudItem xs="12" sm="4">
                        <MudText Typo="Typo.overline" Class="mud-text-secondary">Initiated By</MudText>
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            @GetModalInitiatorIcon(_selectedChange)
                            @if (_selectedChange.ChangeInitiatorId != null && !string.IsNullOrEmpty(_selectedChange.ChangeInitiatorName))
                            {
                                <MudLink Href="@GetInitiatorHref(_selectedChange)">@_selectedChange.ChangeInitiatorName</MudLink>
                            }
                            else if (!string.IsNullOrEmpty(_selectedChange.ChangeInitiatorName))
                            {
                                <MudText>@_selectedChange.ChangeInitiatorName</MudText>
                            }
                            else
                            {
                                <MudText Class="mud-text-secondary">Unknown</MudText>
                            }
                        </MudStack>
                    </MudItem>

                    <!-- Sync Rule -->
                    @if (_selectedChange.SyncRuleId != null || !string.IsNullOrEmpty(_selectedChange.SyncRuleName))
                    {
                        <MudItem xs="12" sm="4">
                            <MudText Typo="Typo.overline" Class="mud-text-secondary">Sync Rule</MudText>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Rule" Size="Size.Small" Class="mud-text-secondary" />
                                @if (_selectedChange.SyncRuleId != null)
                                {
                                    <MudLink Href="@($"/admin/connected-systems/sync-rules/{_selectedChange.SyncRuleId}")">@(_selectedChange.SyncRuleName ?? "Sync Rule")</MudLink>
                                }
                                else
                                {
                                    <MudText>@_selectedChange.SyncRuleName <span class="mud-text-secondary">(deleted)</span></MudText>
                                }
                            </MudStack>
                        </MudItem>
                    }

                    <!-- Activity Link -->
                    @if (_selectedChange.ActivityRunProfileExecutionItemId != null)
                    {
                        <MudItem xs="12" sm="4">
                            <MudText Typo="Typo.overline" Class="mud-text-secondary">Activity</MudText>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.PlayCircle" Size="Size.Small" Class="mud-text-secondary" />
                                <MudLink Href="@($"/activity/item/{_selectedChange.ActivityRunProfileExecutionItemId}")">View Activity</MudLink>
                            </MudStack>
                        </MudItem>
                    }
                </MudGrid>
            </MudPaper>
        }
        @if (_selectedChange?.AttributeChanges.Any() == true)
        {
            <MudTable Items="@_selectedChange.AttributeChanges"
                      Dense="true"
                      Hover="true"
                      Breakpoint="Breakpoint.Sm"
                      Elevation="0">
                <HeaderContent>
                    <MudTh>Attribute</MudTh>
                    <MudTh>Change</MudTh>
                    <MudTh>Value</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Attribute">
                        <MudText Class="jim-text-code">@context.AttributeName</MudText>
                    </MudTd>
                    <MudTd DataLabel="Change">
                        <MudChip T="string"
                                 Variant="Variant.Text"
                                 Color="@Helpers.GetMudBlazorColorForValueChangeType(context.ChangeType)">
                            @context.ChangeType
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Value">
                        @if (context.ReferenceValue != null)
                        {
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudChip T="string" Color="Color.Default" Size="Size.Small">@context.ReferenceValue.TypeName</MudChip>
                                <MudLink Href="@context.ReferenceValue.Href">
                                    @context.ReferenceValue.DisplayName
                                </MudLink>
                                @if (!string.IsNullOrEmpty(context.ReferenceValue.SecondaryId))
                                {
                                    <MudText Class="mud-text-secondary">(@context.ReferenceValue.SecondaryId)</MudText>
                                }
                            </MudStack>
                        }
                        else
                        {
                            <MudText>@context.Value</MudText>
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                Object was deleted. Final attribute values were not captured.
            </MudText>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDetailsDialog" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .change-summary {
        position: relative;
    }

    .more-changes-indicator {
        margin-top: 4px;
    }

    .cursor-pointer {
        cursor: pointer;
        transition: box-shadow 0.2s;
    }

    .cursor-pointer:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

@code {
    /// <summary>
    /// The list of change groups to display (CSO or MVO changes).
    /// </summary>
    [Parameter]
    public List<ChangeGroup> Changes { get; set; } = new();

    private string _searchText = string.Empty;
    private ValueChangeType? _filterChangeType = null;
    private bool _detailsDialogVisible = false;
    private ChangeGroup? _selectedChange = null;

    private DialogOptions _dialogOptions = new DialogOptions
    {
        MaxWidth = MaxWidth.Large,
        FullWidth = true,
        CloseButton = true
    };

    /// <summary>
    /// Represents a group of changes that occurred at a specific point in time.
    /// Works for both ConnectedSystemObjectChange and MetaverseObjectChange.
    /// </summary>
    public class ChangeGroup
    {
        public ObjectChangeType ChangeType { get; set; }
        public DateTime ChangeTime { get; set; }
        public string ChangeInitiatorType { get; set; } = string.Empty;
        public string? ChangeInitiatorName { get; set; }
        public Guid? ChangeInitiatorId { get; set; }
        /// <summary>
        /// The sync rule that caused this change (if applicable).
        /// </summary>
        public int? SyncRuleId { get; set; }
        public string? SyncRuleName { get; set; }
        /// <summary>
        /// Link to the RPEI for viewing the full activity context.
        /// </summary>
        public Guid? ActivityRunProfileExecutionItemId { get; set; }
        public List<AttributeChange> AttributeChanges { get; set; } = new();
    }

    /// <summary>
    /// Represents a single attribute change within a change group.
    /// </summary>
    public class AttributeChange
    {
        public string AttributeName { get; set; } = string.Empty;
        public ValueChangeType ChangeType { get; set; }
        public string? Value { get; set; }
        public ReferenceValueInfo? ReferenceValue { get; set; }
    }

    /// <summary>
    /// Reference value information (CSO or MVO).
    /// </summary>
    public class ReferenceValueInfo
    {
        public string TypeName { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string? SecondaryId { get; set; }
        public string Href { get; set; } = string.Empty;
    }

    private IEnumerable<ChangeGroup> GetFilteredChangeGroups()
    {
        var filtered = Changes.AsEnumerable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            filtered = filtered.Select(cg => new ChangeGroup
            {
                ChangeType = cg.ChangeType,
                ChangeTime = cg.ChangeTime,
                ChangeInitiatorType = cg.ChangeInitiatorType,
                ChangeInitiatorName = cg.ChangeInitiatorName,
                ChangeInitiatorId = cg.ChangeInitiatorId,
                SyncRuleId = cg.SyncRuleId,
                SyncRuleName = cg.SyncRuleName,
                ActivityRunProfileExecutionItemId = cg.ActivityRunProfileExecutionItemId,
                AttributeChanges = cg.AttributeChanges
                    .Where(ac => ac.AttributeName.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
                    .ToList()
            }).Where(cg => cg.AttributeChanges.Any() || cg.ChangeType == ObjectChangeType.Deleted);
        }

        // Apply change type filter
        if (_filterChangeType.HasValue)
        {
            filtered = filtered.Select(cg => new ChangeGroup
            {
                ChangeType = cg.ChangeType,
                ChangeTime = cg.ChangeTime,
                ChangeInitiatorType = cg.ChangeInitiatorType,
                ChangeInitiatorName = cg.ChangeInitiatorName,
                ChangeInitiatorId = cg.ChangeInitiatorId,
                SyncRuleId = cg.SyncRuleId,
                SyncRuleName = cg.SyncRuleName,
                ActivityRunProfileExecutionItemId = cg.ActivityRunProfileExecutionItemId,
                AttributeChanges = cg.AttributeChanges
                    .Where(ac => ac.ChangeType == _filterChangeType.Value)
                    .ToList()
            }).Where(cg => cg.AttributeChanges.Any() || cg.ChangeType == ObjectChangeType.Deleted);
        }

        return filtered.OrderByDescending(cg => cg.ChangeTime);
    }

    private const int MaxVisibleChanges = 3;

    private IEnumerable<AttributeChange> GetVisibleChanges(ChangeGroup changeGroup)
    {
        // Show individual changes, limited to MaxVisibleChanges
        return changeGroup.AttributeChanges.Take(MaxVisibleChanges);
    }

    private int GetRemainingChangesCount(ChangeGroup changeGroup)
    {
        // Count total changes minus the visible ones
        return changeGroup.AttributeChanges.Count - MaxVisibleChanges;
    }

    private bool ShouldShowMoreIndicator(ChangeGroup changeGroup)
    {
        // Show indicator when there are more changes than we display
        return changeGroup.AttributeChanges.Count > MaxVisibleChanges;
    }

    private void OpenChangeDetails(ChangeGroup changeGroup)
    {
        _selectedChange = changeGroup;
        _detailsDialogVisible = true;
    }

    private void CloseDetailsDialog()
    {
        _detailsDialogVisible = false;
        _selectedChange = null;
    }

    private string GetRelativeTime(DateTime changeTime)
    {
        var localTime = changeTime.ToLocalTime();
        var now = DateTime.Now;
        var diff = now - localTime;

        if (diff.TotalMinutes < 1)
            return "Just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)}w ago";
        if (diff.TotalDays < 365)
            return $"{(int)(diff.TotalDays / 30)}mo ago";
        return $"{(int)(diff.TotalDays / 365)}y ago";
    }

    /// <summary>
    /// Generates the timeline card initiator display.
    /// Format: "{icon} Synchronisation by {Name}" for sync changes
    /// Format: "{icon} {Name}" for direct user changes
    /// </summary>
    private RenderFragment GetTimelineInitiatorDisplay(ChangeGroup changeGroup)
    {
        return builder =>
        {
            int seq = 0;

            // Determine if this is a sync-initiated change
            bool isSyncChange = changeGroup.ChangeInitiatorType == "SynchronisationRule" ||
                                changeGroup.SyncRuleId != null ||
                                !string.IsNullOrEmpty(changeGroup.SyncRuleName);

            if (isSyncChange)
            {
                // Sync icon
                builder.OpenComponent<MudIcon>(seq++);
                builder.AddAttribute(seq++, "Icon", Icons.Material.Filled.Sync);
                builder.AddAttribute(seq++, "Size", Size.Small);
                builder.AddAttribute(seq++, "Class", "mud-text-secondary");
                builder.AddAttribute(seq++, "Style", "margin-right: 4px;");
                builder.CloseComponent();

                // "Synchronisation by {Name}"
                builder.OpenComponent<MudText>(seq++);
                builder.AddAttribute(seq++, "Typo", Typo.body2);
                builder.AddAttribute(seq++, "Class", "mud-text-secondary");
                if (!string.IsNullOrEmpty(changeGroup.ChangeInitiatorName))
                {
                    builder.AddAttribute(seq++, "ChildContent", (RenderFragment)(b => b.AddContent(0, $"Synchronisation by {changeGroup.ChangeInitiatorName}")));
                }
                else
                {
                    builder.AddAttribute(seq++, "ChildContent", (RenderFragment)(b => b.AddContent(0, "Synchronisation")));
                }
                builder.CloseComponent();
            }
            else
            {
                // Direct change by user/system - use appropriate icon
                string icon = changeGroup.ChangeInitiatorType switch
                {
                    "User" => Icons.Material.Filled.Person,
                    "ApiKey" => Icons.Material.Filled.Key,
                    "System" => Icons.Material.Filled.Settings,
                    _ => Icons.Material.Filled.HelpOutline
                };

                builder.OpenComponent<MudIcon>(seq++);
                builder.AddAttribute(seq++, "Icon", icon);
                builder.AddAttribute(seq++, "Size", Size.Small);
                builder.AddAttribute(seq++, "Class", "mud-text-secondary");
                builder.AddAttribute(seq++, "Style", "margin-right: 4px;");
                builder.CloseComponent();

                builder.OpenComponent<MudText>(seq++);
                builder.AddAttribute(seq++, "Typo", Typo.body2);
                builder.AddAttribute(seq++, "Class", "mud-text-secondary");
                builder.AddAttribute(seq++, "ChildContent", (RenderFragment)(b => b.AddContent(0, changeGroup.ChangeInitiatorName ?? changeGroup.ChangeInitiatorType)));
                builder.CloseComponent();
            }
        };
    }

    /// <summary>
    /// Generates the icon for the modal initiator display.
    /// </summary>
    private RenderFragment GetModalInitiatorIcon(ChangeGroup changeGroup)
    {
        return builder =>
        {
            string icon = changeGroup.ChangeInitiatorType switch
            {
                "User" => Icons.Material.Filled.Person,
                "ApiKey" => Icons.Material.Filled.Key,
                "System" => Icons.Material.Filled.Settings,
                _ => Icons.Material.Filled.HelpOutline
            };

            builder.OpenComponent<MudIcon>(0);
            builder.AddAttribute(1, "Icon", icon);
            builder.AddAttribute(2, "Size", Size.Small);
            builder.AddAttribute(3, "Class", "mud-text-secondary");
            builder.CloseComponent();
        };
    }

    private string GetInitiatorHref(ChangeGroup changeGroup)
    {
        if (changeGroup.ChangeInitiatorId == null)
            return "#";

        return changeGroup.ChangeInitiatorType switch
        {
            "User" => $"/t/users/v/{changeGroup.ChangeInitiatorId}",
            "ApiKey" => $"/admin/apikeys", // API Keys list page
            "SynchronisationRule" => $"/admin/connected-systems/sync-rules/{changeGroup.ChangeInitiatorId}",
            _ => "#"
        };
    }

    private string GetChangeTypeIcon(ObjectChangeType changeType)
    {
        return changeType switch
        {
            ObjectChangeType.Added => Icons.Material.Filled.Add,
            ObjectChangeType.Updated => Icons.Material.Filled.Edit,
            ObjectChangeType.Deleted => Icons.Material.Filled.Delete,
            _ => Icons.Material.Filled.Info
        };
    }

    private Color GetChangeTypeColor(ObjectChangeType changeType)
    {
        return changeType switch
        {
            ObjectChangeType.Added => Color.Success,
            ObjectChangeType.Updated => Color.Info,
            ObjectChangeType.Deleted => Color.Error,
            _ => Color.Default
        };
    }
}
